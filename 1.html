<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>فاکتور فروش طلا</title>
<style>
  @font-face {
    font-family: 'Vazir';
    src: url('https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.woff2') format('woff2');
  }
  body {
    font-family: 'Vazir', sans-serif;
    background-color: #f8f9fa;
    margin: 0;
    padding: 12px 16px;
    color: #333;
    min-height: 100vh;
    box-sizing: border-box;
  }
  h2 {
    border-right: 6px solid #2196f3;
    padding-right: 10px;
    margin-bottom: 16px;
    color: #2196f3;
    font-weight: 700;
    font-size: 1.7rem;
  }
  h3 {
    border-right: 6px solid #4caf50;
    padding-right: 10px;
    margin-top: 24px;
    margin-bottom: 12px;
    color: #4caf50;
    font-weight: 600;
    font-size: 1.3rem;
  }
  label {
    font-weight: 600;
    font-size: 1rem;
    display: block;
    margin-bottom: 6px;
    position: relative;
  }
  label::before {
    content: "";
    display: inline-block;
    width: 6px;
    height: 22px;
    background-color: #2196f3;
    position: absolute;
    left: 100%;
    margin-left: 8px;
    border-radius: 3px;
    top: 0;
  }
  input[type=text],
  input[type=tel],
  select {
    width: 100%;
    padding: 8px 10px;
    font-size: 1.05rem;
    border: 1.5px solid #bbb;
    border-radius: 8px;
    box-sizing: border-box;
    font-family: 'Vazir', sans-serif;
    transition: border-color 0.2s ease;
    color: #111;
  }
  input[type=text]:focus,
  input[type=tel]:focus,
  select:focus {
    border-color: #2196f3;
    outline: none;
  }
  .ajrat-input {
    direction: ltr;
    text-align: left;
  }
  button {
    background-color: #2196f3;
    border: none;
    padding: 9px 18px;
    border-radius: 8px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s ease;
    font-family: 'Vazir', sans-serif;
  }
  button:hover {
    background-color: #1976d2;
  }
  .remove-btn {
    background-color: #f44336;
    padding: 7px 14px;
    margin-top: 24px;
  }
  .remove-btn:hover {
    background-color: #d32f2f;
  }
  .gold-item {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 14px 20px;
    margin-bottom: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .flex-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  .flex-row > div {
    flex: 1 1 150px;
  }
  .highlight-blue {
    color: #2196f3;
    font-weight: 700;
  }
  .highlight-green {
    color: #4caf50;
    font-weight: 700;
  }
  .highlight-red {
    color: #f44336;
    font-weight: 700;
  }
  .smart-discount {
    margin-top: 6px;
  }
  .smart-discount button {
    background-color: #e8f5e9;
    color: #4caf50;
    border: 1.5px solid #4caf50;
    border-radius: 6px;
    padding: 6px 12px;
    margin-right: 8px;
    cursor: pointer;
    font-weight: 600;
    font-family: 'Vazir', sans-serif;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .smart-discount button.active {
    background-color: #4caf50;
    color: white;
  }
  input[data-type="farsi-num"] {
    direction: ltr;
    text-align: left;
  }
  #manualDiscount {
    width: 100%;
    font-weight: 700;
    color: #f44336;
  }
  #invoiceSummary {
    background-color: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }
  #invoiceSummary .row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 1rem;
  }
  #invoiceSummary .row.bold-blue {
    color: #2196f3;
    font-weight: 900;
    font-size: 1.3rem;
  }
  select[multiple] {
    height: 110px;
    font-family: 'Vazir', sans-serif;
  }
  @media (max-width: 600px) {
    .flex-row {
      flex-direction: column;
    }
    label::before {
      display: none;
    }
  }
</style>
</head>
<body>

<h2>فاکتور فروش طلا</h2>

<!-- مشخصات خریدار -->
<section>
  <h3>مشخصات خریدار</h3>
  <label for="buyerName">نام خریدار (فقط حروف)</label>
  <input type="text" id="buyerName" autocomplete="off" placeholder="مثلاً علی رضایی" oninput="validateName(this)" />
  
  <label for="buyerPhone" style="margin-top:12px;">شماره تماس (اختیاری - حداکثر ۱۱ رقم)</label>
  <input type="tel" id="buyerPhone" autocomplete="off" placeholder="۰۹۱۲۳۴۵۶۷۸۹" maxlength="11" oninput="validatePhone(this)" />
</section>

<!-- قیمت طلا -->
<section>
  <h3>قیمت طلا (تومان)</h3>
  <label for="goldPrice">قیمت طلا (۷ رقم، فقط عدد)</label>
  <input type="text" id="goldPrice" maxlength="9" autocomplete="off" placeholder="مثلاً ۱۲۳٬۴۵۶٬۷۸۹" oninput="formatGoldPrice(this)" />
  <div id="goldPriceWords" style="color:#9c27b0; margin-top:6px; font-weight: 600;"></div>
</section>
<!-- افزودن آیتم های طلا -->
<section>
  <h3>آیتم‌های طلا</h3>
  <div id="goldItemsContainer"></div>
  <button type="button" onclick="addGoldItem()">➕ افزودن آیتم طلا</button>
</section>

<!-- خرید طلا از مشتری -->
<section>
  <h3>خرید طلا از مشتری</h3>
  <div class="flex-row" style="margin-bottom:12px;">
    <div>
      <label for="buyGoldWeight">خرید طلا (وزن)</label>
      <input type="text" id="buyGoldWeight" placeholder="مثلاً 12.5" autocomplete="off" data-type="farsi-num" oninput="formatPersianNumber(this)" />
    </div>
    <div>
      <label for="buyShamshWeight">خرید شمش (وزن)</label>
      <input type="text" id="buyShamshWeight" placeholder="مثلاً 10" autocomplete="off" data-type="farsi-num" oninput="formatPersianNumber(this)" />
    </div>
    <div>
      <label for="buyParsianWeight">خرید پارسیان (وزن)</label>
      <input type="text" id="buyParsianWeight" placeholder="مثلاً 8" autocomplete="off" data-type="farsi-num" oninput="formatPersianNumber(this)" />
    </div>
  </div>
  
  <label for="buyCoinSelect">خرید سکه (انتخاب مدل یا چند مدل)</label>
  <select id="buyCoinSelect" multiple>
    <option value="ربع ۸۶">ربع ۸۶</option>
    <option value="نیم ۸۶">نیم ۸۶</option>
    <option value="امامی ۸۶">امامی ۸۶</option>
    <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
    <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
    <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
    <option value="یک گرمی بانکی">یک گرمی بانکی</option>
  </select>

  <label for="buyCoinPrice" style="margin-top:12px;">مبلغ سکه‌ها (تومان)</label>
  <input type="text" id="buyCoinPrice" maxlength="9" autocomplete="off" placeholder="مثلاً ۵۰۰۰۰۰۰" oninput="formatCoinPrice(this)" />
</section>

<!-- تنظیمات مالی -->
<section>
  <h3>تنظیمات مالی</h3>
  <label for="sellerProfit">سود فروشنده (%): <span id="profitValue">۷٪</span></label>
  <input type="range" id="sellerProfit" min="1" max="7" value="7" oninput="onProfitInput()" />
  <div style="margin-top:12px;">
    <label><input type="checkbox" id="taxToggle" checked onchange="calculateFinal()" /> اعمال مالیات ۱۰٪</label>
  </div>
</section>

<!-- تخفیف -->
<section>
  <h3>تخفیف</h3>
  <label for="manualDiscount">تخفیف دستی (تومان)</label>
  <input type="text" id="manualDiscount" maxlength="9" autocomplete="off" placeholder="مثلاً ۱۰۰۰۰۰" oninput="formatManualDiscount(this)" />
  
  <div class="smart-discount">
    <p style="color:#4caf50; font-weight:700; margin-bottom:6px;">تخفیف هوشمند:</p>
    <button type="button" onclick="toggleSmartDiscount(0)">۱۷۸۹۰۰۰۰</button>
    <button type="button" onclick="toggleSmartDiscount(1)">۱۷۸۵۰۰۰۰</button>
    <button type="button" onclick="toggleSmartDiscount(2)">۱۷۸۰۰۰۰۰</button>
    <button type="button" onclick="toggleSmartDiscount(3)">۱۷۵۰۰۰۰۰</button>
  </div>
</section>
<section>
  <h3>فاکتور نهایی</h3>
  <div id="invoiceSummary">
    <div class="row"><span>نام طلا:</span><span id="finalModel">-</span></div>
    <div class="row"><span>اجرت:</span><span id="finalAjrat">-</span></div>
    <div class="row"><span>مالیات:</span><span id="finalTax">-</span></div>
    <div class="row" style="color:#f44336; font-weight:700;"><span>تخفیف:</span><span id="finalDiscount">-</span></div>
    <div class="row bold-blue"><span>قیمت نهایی:</span><span id="finalPrice">-</span></div>
  </div>
</section>

<script>
  // تبدیل اعداد انگلیسی به فارسی
  function toFarsiDigits(str) {
    const map = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
    return String(str).replace(/\d/g, x => map[x]);
  }

  // حذف اعداد و کاراکتر غیرحروف از نام
  function validateName(input) {
    input.value = input.value.replace(/[^آ-ی\s]/g, '');
  }

  // فقط اعداد و حداکثر ۱۱ رقم برای شماره تماس
  function validatePhone(input) {
    input.value = input.value.replace(/[^0-9]/g, '').slice(0,11);
  }

  // فرمت ورودی قیمت طلا (۷ رقم، با جداکننده هزارگان)
  function formatGoldPrice(input) {
    let val = input.value.replace(/[^0-9]/g, '').slice(0,7);
    val = val.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    input.value = val;
    // نمایش به حروف
    const num = parseInt(val.replace(/,/g, ''));
    if(!isNaN(num)) {
      document.getElementById('goldPriceWords').innerText = numberToWords(num) + ' تومان';
    } else {
      document.getElementById('goldPriceWords').innerText = '';
    }
    calculateFinal();
  }

  // فرمت مبلغ سکه‌ها (۷ رقم)
  function formatCoinPrice(input) {
    let val = input.value.replace(/[^0-9]/g, '').slice(0,7);
    val = val.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    input.value = val;
    calculateFinal();
  }

  // فرمت تخفیف دستی (۹ رقم)
  function formatManualDiscount(input) {
    let val = input.value.replace(/[^0-9]/g, '').slice(0,9);
    val = val.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    input.value = val;
    calculateFinal();
  }

  // فرمت اعداد فارسی و اجازه نقطه در وزن‌ها
  function formatPersianNumber(input) {
    let val = input.value;
    val = val.replace(/[^0-9.]/g, '');
    // فقط یک نقطه مجاز
    let parts = val.split('.');
    if(parts.length > 2) val = parts[0] + '.' + parts[1];
    input.value = val;
    calculateFinal();
  }

  // تبدیل عدد به حروف فارسی (نسخه ساده برای تا میلیارد)
  function numberToWords(num) {
    if (num === 0) return 'صفر';
    const ones = ['','یک','دو','سه','چهار','پنج','شش','هفت','هشت','نه'];
    const teens = ['ده','یازده','دوازده','سیزده','چهارده','پانزده','شانزده','هفده','هجده','نوزده'];
    const tens = ['','','بیست','سی','چهل','پنجاه','شصت','هفتاد','هشتاد','نود'];
    const hundreds = ['','یکصد','دویست','سیصد','چهارصد','پانصد','ششصد','هفتصد','هشتصد','نهصد'];
    const thousands = ['','هزار','میلیون','میلیارد'];
    
    function chunkToWords(n) {
      let str = '';
      if(n >= 100) {
        str += hundreds[Math.floor(n/100)] + ' ';
        n %= 100;
      }
      if(n >= 10 && n < 20) {
        str += teens[n-10] + ' ';
      } else if(n >= 20) {
        str += tens[Math.floor(n/10)] + ' ';
        if(n%10 > 0) str += ones[n%10] + ' ';
      } else if(n > 0) {
        str += ones[n] + ' ';
      }
      return str.trim();
    }

    let parts = [];
    let i = 0;
    while(num > 0) {
      let chunk = num % 1000;
      if(chunk > 0) {
        parts.unshift(chunkToWords(chunk) + (thousands[i] ? ' ' + thousands[i] : ''));
      }
      num = Math.floor(num/1000);
      i++;
    }
    return parts.join(' و ').trim();
  }
  // تابع اضافه کردن آیتم طلا
  function addGoldItem() {
    const container = document.getElementById('goldItemsContainer');
    const div = document.createElement('div');
    div.classList.add('gold-item');
    div.innerHTML = `
      <div class="flex-row">
        <div>
          <label>مدل طلا</label>
          <select class="gold-model">
            <option>سرویس</option>
            <option>النگو</option>
            <option>نیم‌ست</option>
            <option>دستبند</option>
            <option>زنجیر</option>
            <option>گردنبند</option>
            <option>گوشواره</option>
            <option>مدال</option>
            <option>پلاک</option>
            <option>خلخال</option>
            <option>آویز ساعت</option>
            <option>رو لباسی</option>
            <option>سفارشی</option>
          </select>
        </div>
        <div>
          <label>وزن طلا</label>
          <input type="text" class="gold-weight" autocomplete="off" placeholder="مثلاً 12.5" data-type="farsi-num" oninput="formatPersianNumber(this)" />
        </div>
        <div>
          <label>اجرت (٪ یا تومان)</label>
          <input type="text" class="ajrat-input" autocomplete="off" placeholder="مثلاً 5% یا 50000" oninput="formatAjrat(this)" />
        </div>
        <div style="flex: 0 0 90px;">
          <button type="button" class="remove-btn" onclick="removeGoldItem(this)">حذف</button>
        </div>
      </div>
    `;
    container.appendChild(div);
    calculateFinal();
  }

  // حذف آیتم طلا
  function removeGoldItem(btn) {
    btn.closest('.gold-item').remove();
    calculateFinal();
  }

  // فرمت ورودی اجرت: عدد یا عدد + %
  function formatAjrat(input) {
    let val = input.value.toUpperCase();
    // حذف همه به جز اعداد و درصد
    val = val.replace(/[^0-9%]/g, '');

    // درصد فقط تا 30
    if(val.includes('%')) {
      let num = parseInt(val);
      if(isNaN(num)) num = 0;
      if(num > 30) num = 30;
      val = num + '%';
    } else {
      // عدد تومان حداکثر 7 رقم
      val = val.slice(0,7);
    }
    input.value = val;
    calculateFinal();
  }
  // متغیر تخفیف هوشمند فعال (اندیس)
  let smartDiscountActive = -1;
  const smartDiscountValues = [17890000, 17850000, 17800000, 17500000];

  function toggleSmartDiscount(idx) {
    const buttons = document.querySelectorAll('.smart-discount button');
    if(smartDiscountActive === idx) {
      // غیرفعال کردن
      smartDiscountActive = -1;
      document.getElementById('manualDiscount').value = '';
      buttons[idx].classList.remove('active');
    } else {
      smartDiscountActive = idx;
      document.getElementById('manualDiscount').value = '';
      buttons.forEach((b,i) => {
        if(i === idx) b.classList.add('active');
        else b.classList.remove('active');
      });
    }
    calculateFinal();
  }

  // تغییر مقدار سود فروشنده و نمایش
  function onProfitInput() {
    const val = document.getElementById('sellerProfit').value;
    document.getElementById('profitValue').innerText = val + '٪';
    calculateFinal();
  }
  function calculateFinal() {
    // قیمت طلا (عدد)
    let goldPriceStr = document.getElementById('goldPrice').value.replace(/,/g,'');
    let goldPrice = parseInt(goldPriceStr);
    if(isNaN(goldPrice)) goldPrice = 0;

    // سود فروشنده
    let profitPercent = parseInt(document.getElementById('sellerProfit').value);
    if(isNaN(profitPercent)) profitPercent = 7;

    // مالیات فعال؟
    let taxEnabled = document.getElementById('taxToggle').checked;

    // جمع اجرت کل و قیمت کل آیتم‌ها
    let totalAjrat = 0;
    let totalPriceWithProfit = 0;

    // محاسبه برای هر آیتم طلا
    let items = document.querySelectorAll('.gold-item');
    let models = [];
    for(let item of items) {
      let model = item.querySelector('.gold-model').value || 'طلا';
      let weightStr = item.querySelector('.gold-weight').value.replace(/,/g, '');
      let weight = parseFloat(weightStr);
      if(isNaN(weight)) weight = 0;
      let ajratStr = item.querySelector('.ajrat-input').value;
      let ajratPercent = 0;
      let ajratAmount = 0;
      if(ajratStr.endsWith('%')) {
        ajratPercent = parseInt(ajratStr);
        if(isNaN(ajratPercent) || ajratPercent < 1) ajratPercent = 0;
        if(ajratPercent > 30) ajratPercent = 30;
        ajratAmount = goldPrice * (ajratPercent/100) * weight;
      } else {
        ajratAmount = parseInt(ajratStr.replace(/,/g, ''));
        if(isNaN(ajratAmount) || ajratAmount < 0) ajratAmount = 0;
      }
      let priceWithoutProfit = goldPrice * weight + ajratAmount;
      let profitAmount = priceWithoutProfit * (profitPercent/100);
      let priceWithProfit = priceWithoutProfit + profitAmount;

      totalAjrat += ajratAmount;
      totalPriceWithProfit += priceWithProfit;
      models.push(model);
    }

    // خرید طلا از مشتری
    // خرید طلا وزن
    let buyGoldWeight = parseFloat(document.getElementById('buyGoldWeight').value.replace(/,/g, ''));
    if(isNaN(buyGoldWeight)) buyGoldWeight = 0;
    let buyGoldPrice = goldPrice * buyGoldWeight;

    // خرید شمش وزن (وزن * 995/750 * قیمت طلا)
    let buyShamshWeight = parseFloat(document.getElementById('buyShamshWeight').value.replace(/,/g, ''));
    if(isNaN(buyShamshWeight)) buyShamshWeight = 0;
    let buyShamshPrice = buyShamshWeight * 995/750 * goldPrice;

    // خرید پارسیان وزن (ضرب قیمت طلا)
    let buyParsianWeight = parseFloat(document.getElementById('buyParsianWeight').value.replace(/,/g, ''));
    if(isNaN(buyParsianWeight)) buyParsianWeight = 0;
    let buyParsianPrice = buyParsianWeight * goldPrice;

    // خرید سکه: مبلغ دستی وارد شده
    let buyCoinPriceStr = document.getElementById('buyCoinPrice').value.replace(/,/g,'');
    let buyCoinPrice = parseInt(buyCoinPriceStr);
    if(isNaN(buyCoinPrice)) buyCoinPrice = 0;

    // مالیات ۱۰ درصد روی (اجرت + سود)
    let taxAmount = 0;
    if(taxEnabled) {
      taxAmount = (totalAjrat + (totalPriceWithProfit - totalAjrat - (goldPrice * getTotalWeight()))) * 0.1;
    }

    // تخفیف دستی یا تخفیف هوشمند
    let manualDiscount = 0;
    if(smartDiscountActive >= 0) {
      manualDiscount = smartDiscountValues[smartDiscountActive];
    } else {
      let manualDiscountStr = document.getElementById('manualDiscount').value.replace(/,/g, '');
      manualDiscount = parseInt(manualDiscountStr);
      if(isNaN(manualDiscount)) manualDiscount = 0;
    }

    // قیمت نهایی کل
    let finalPrice = totalPriceWithProfit + taxAmount - manualDiscount;

    // نمایش در فاکتور
    document.getElementById('finalModel').innerText = models.length >
      models.length > 0 ? models.join(' ، ') : 'طلا';
    document.getElementById('finalAjrat').innerText = totalAjrat > 0 ? toFarsiDigits(Math.round(totalAjrat)) + ' تومان' : '-';
    document.getElementById('finalTax').innerText = taxEnabled && taxAmount > 0 ? toFarsiDigits(Math.round(taxAmount)) + ' تومان' : '-';
    document.getElementById('finalDiscount').innerText = manualDiscount > 0 ? '-' + toFarsiDigits(Math.round(manualDiscount)) + ' تومان' : '-';
    document.getElementById('finalPrice').innerText = toFarsiDigits(Math.round(finalPrice > 0 ? finalPrice : 0)) + ' تومان';
  }

  // جمع کل وزن آیتم های طلا (برای محاسبات)
  function getTotalWeight() {
    let total = 0;
    let items = document.querySelectorAll('.gold-item');
    for(let item of items) {
      let weightStr = item.querySelector('.gold-weight').value.replace(/,/g, '');
      let weight = parseFloat(weightStr);
      if(!isNaN(weight)) total += weight;
    }
    return total;
  }

  // رویدادهای اولیه
  document.addEventListener('DOMContentLoaded', () => {
    addGoldItem(); // حداقل یک آیتم طلا ایجاد کن
    onProfitInput();
  });

  // محاسبه نهایی هر چند ثانیه یا تغییرات سریع
  ['goldPrice', 'buyerName', 'buyerPhone', 'buyGoldWeight', 'buyShamshWeight', 'buyParsianWeight', 'buyCoinPrice', 'manualDiscount', 'taxToggle', 'sellerProfit', 'buyCoinSelect'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', calculateFinal);
  });
</script>
</body>
</html>
