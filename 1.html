<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ماشین حساب طلا و فاکتور</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #4A90E2;
            --light-blue: #D6E8FB; /* Lighter shade of blue for accents */
            --dark-gray: #333;
            --medium-gray: #555;
            --light-gray: #F7F7F7;
            --white: #FFFFFF;
            --border-color: #E0E0E0;
            --success-green: #28a745;
            --error-red: #dc3545;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            font-size: 0.95rem; /* Slightly smaller base font */
        }

        .container {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            max-width: 500px; /* Reduced max-width for more minimalist feel */
            width: 100%;
            box-sizing: border-box;
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-blue);
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.6rem; /* Slightly smaller heading */
        }

        h2 {
            border-bottom: 1px solid var(--light-blue);
            padding-bottom: 8px;
            margin-top: 25px;
            font-size: 1.25rem; /* Slightly smaller sub-heading */
        }

        .form-group {
            margin-bottom: 15px; /* Reduced margin */
        }

        label {
            display: block;
            margin-bottom: 6px; /* Reduced margin */
            font-weight: bold;
            color: var(--medium-gray);
            font-size: 0.9rem; /* Slightly smaller label font */
        }

        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 18px); /* Adjust for padding and border */
            padding: 10px 8px; /* Reduced padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem; /* Smaller input font */
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            color: var(--dark-gray);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.15); /* Softer shadow */
        }

        .input-inline {
            display: flex;
            align-items: center;
            gap: 10px; /* Gap between input and toggle buttons */
        }

        .input-inline input {
            flex-grow: 1;
        }

        .price-display {
            display: flex;
            align-items: stretch; /* Stretch items to fill height */
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .price-display > div {
            flex: 1; /* Allow flexing */
            min-width: 120px; /* Minimum width for flex items */
        }

        .price-display label {
            flex-basis: 100%; /* Label takes full width on top */
        }

        .persian-price-text {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 8px;
            background-color: var(--light-gray);
            min-height: 40px; /* Adjusted min-height */
            display: flex;
            align-items: center;
            justify-content: flex-start;
            word-break: break-word;
            box-sizing: border-box;
            font-size: 0.9rem; /* Default size */
            line-height: 1.3;
        }

        .persian-price-text.small-font {
            font-size: 0.75rem; /* Smaller size for longer text */
        }

        .add-item-btn {
            background-color: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            margin-top: 15px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .add-item-btn:hover {
            background-color: #3a7fd6;
        }

        .item-section {
            border: 1px solid var(--light-blue);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px; /* Reduced margin */
            background-color: #FBFDFF; /* Very light blue background */
            position: relative;
        }

        .item-section:first-of-type {
            margin-top: 0;
        }

        .remove-item-btn {
            background-color: var(--error-red);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 26px; /* Smaller button */
            height: 26px; /* Smaller button */
            font-size: 0.9rem; /* Smaller font */
            cursor: pointer;
            position: absolute;
            top: 8px; /* Adjusted position */
            left: 8px; /* Adjusted position */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .remove-item-btn:hover {
            background-color: #c82333;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 8px;
            width: 18px; /* Smaller checkbox */
            height: 18px; /* Smaller checkbox */
            accent-color: var(--primary-blue);
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-size: 0.9rem;
            font-weight: normal; /* Labels for checkboxes are often not bold */
            color: var(--dark-gray);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0;
            font-weight: normal;
            font-size: 0.85rem;
        }

        .radio-group input[type="radio"] {
            margin-left: 6px;
            accent-color: var(--primary-blue);
        }

        .toggle-group {
            display: flex;
            gap: 5px; /* Smaller gap for toggle buttons */
        }

        .toggle-group button {
            padding: 8px 12px; /* Reduced padding */
            border-radius: 6px;
            border: 1px solid var(--primary-blue);
            background-color: var(--white);
            color: var(--primary-blue);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem; /* Smaller font for buttons */
        }

        .toggle-group button.active {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        .discount-options button {
            width: 100%;
            margin-top: 8px; /* Reduced margin */
            background-color: var(--light-blue);
            color: var(--dark-gray);
            border: none;
            padding: 9px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }

        .discount-options button:hover {
            background-color: #BBDDFF; /* Lighter hover color */
        }

        #finalInvoice, #customerInvoice {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            padding: 20px;
            margin-top: 25px;
            border: 1px solid var(--primary-blue);
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #F0F0F0; /* Lighter dashed line */
            font-size: 0.9rem;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item strong {
            color: var(--dark-gray);
        }

        .total-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-blue);
            text-align: left;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--light-blue);
        }

        .customer-info-box {
            background-color: #e6f2ff;
            border: 1px solid var(--light-blue);
            border-radius: 8px;
            padding: 12px; /* Reduced padding */
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .customer-info-box label {
            color: var(--primary-blue);
            font-size: 0.9rem;
        }

        .customer-invoice-details div {
            margin-bottom: 6px; /* Reduced margin */
            font-size: 0.9rem;
        }
        .customer-invoice-details strong {
            display: inline-block;
            min-width: 70px; /* Reduced min-width */
            color: var(--medium-gray);
        }

        .customer-invoice-details p {
            margin: 3px 0 0 0;
            padding-right: 15px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .price-display {
                flex-direction: column;
                align-items: stretch;
            }
            .price-display > div {
                min-width: unset; /* Remove min-width on small screens */
            }
            .persian-price-text {
                margin-top: 8px; /* Add margin when stacked */
            }
            .input-inline {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .input-inline input {
                width: 100%;
            }
            .toggle-group {
                width: 100%;
                justify-content: stretch;
            }
            .toggle-group button {
                flex-grow: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ماشین حساب طلا</h1>

        <h2>اطلاعات پایه</h2>
        <div class="form-group price-display">
            <label for="goldPrice">قیمت هر گرم طلا (تومان):</label>
            <div>
                <input type="text" id="goldPrice" placeholder="فقط ۷ رقم" maxlength="7" inputmode="numeric">
            </div>
            <div>
                <div class="persian-price-text" id="goldPriceText"></div>
            </div>
        </div>

        <div class="form-group">
            <label for="sellerProfit">سود فروشنده (درصد):</label>
            <select id="sellerProfit" onchange="calculateTotal()">
                <option value="1">1%</option>
                <option value="2">2%</option>
                <option value="3">3%</option>
                <option value="4">4%</option>
                <option value="5">5%</option>
                <option value="6">6%</option>
                <option value="7" selected>7%</option>
            </select>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="enableTax" checked onchange="calculateTotal()">
            <label for="enableTax">محاسبه مالیات ۱۰% (از سود و اجرت)</label>
        </div>

        ---

        <h2>جزئیات طلا (آیتم‌ها)</h2>
        <div id="goldItemsContainer">
            </div>
        <button type="button" class="add-item-btn" onclick="addGoldItem()">+ افزودن آیتم طلای جدید</button>

        ---

        <h2>خرید‌های دیگر (اختیاری)</h2>
        <div id="otherPurchasesContainer">
            </div>
        <div class="form-group">
            <label>افزودن خرید جدید:</label>
            <div class="toggle-group">
                <button type="button" onclick="addOtherPurchase('gold')">طلا</button>
                <button type="button" onclick="addOtherPurchase('shemsh')">شمش</button>
                <button type="button" onclick="addOtherPurchase('parsian')">پارسیان</button>
                <button type="button" onclick="addOtherPurchase('coin')">سکه</button>
            </div>
        </div>

        ---

        <h2>تخفیف</h2>
        <div class="form-group">
            <label for="manualDiscount">تخفیف دستی (تومان):</label>
            <input type="text" id="manualDiscount" value="0" inputmode="numeric" onkeyup="formatNumberInput(this); calculateTotal()">
        </div>

        <div class="form-group">
            <label>تخفیف هوشمند (برای رندسازی):</label>
            <div id="smartDiscountOptions" class="discount-options">
                </div>
        </div>

        ---

        <h2>فاکتور نهایی</h2>
        <div id="finalInvoice">
            <h3>جزئیات فاکتور</h3>
            <div id="finalInvoiceDetails">
                </div>
            <div class="invoice-item">
                <span>**مالیات:**</span>
                <span id="invoiceTaxAmount">۰ تومان</span>
            </div>
            <div class="invoice-item">
                <span>**تخفیف:**</span>
                <span id="invoiceDiscountAmount">۰ تومان</span>
            </div>
            <div class="total-price">
                <span>**قیمت نهایی:**</span>
                <span id="finalTotalPrice">۰ تومان</span>
            </div>
        </div>

        ---

        <h2>فاکتور فروش مشتری</h2>
        <div class="customer-info-box">
            <div class="form-group">
                <label for="customerName">نام خریدار:</label>
                <input type="text" id="customerName" oninput="updateCustomerInvoice()">
            </div>
            <div class="form-group">
                <label for="customerPhone">شماره تماس (اختیاری):</label>
                <input type="text" id="customerPhone" inputmode="tel" oninput="updateCustomerInvoice()">
            </div>
        </div>

        <div id="customerInvoice">
            <h3>جزئیات فاکتور مشتری</h3>
            <div id="customerInvoiceDetails" class="customer-invoice-details">
                <div><strong>نام خریدار:</strong> <span id="customerInvoiceName">---</span></div>
                <div><strong>شماره تماس:</strong> <span id="customerInvoicePhone">---</span></div>
                <div style="margin-top: 10px;"><strong>طلا/اقلام خریداری شده:</strong></div>
                <div class="customer-invoice-section" id="customerItemsList">
                    </div>
                <div><strong>مالیات:</strong> <span id="customerInvoiceTax">۰ تومان</span></div>
                <div><strong>تخفیف:</strong> <span id="customerInvoiceDiscount">۰ تومان</span></div>
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-blue); margin-top: 15px;">
                    <strong>قیمت کل:</strong> <span id="customerFinalPrice">۰ تومان</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        const goldPriceInput = document.getElementById('goldPrice');
        const goldPriceTextDisplay = document.getElementById('goldPriceText');
        const sellerProfitSelect = document.getElementById('sellerProfit');
        const enableTaxCheckbox = document.getElementById('enableTax');
        const goldItemsContainer = document.getElementById('goldItemsContainer');
        const otherPurchasesContainer = document.getElementById('otherPurchasesContainer');
        const manualDiscountInput = document.getElementById('manualDiscount');
        const smartDiscountOptionsDiv = document.getElementById('smartDiscountOptions');
        const finalInvoiceDetailsDiv = document.getElementById('finalInvoiceDetails');
        const invoiceTaxAmountSpan = document.getElementById('invoiceTaxAmount');
        const invoiceDiscountAmountSpan = document.getElementById('invoiceDiscountAmount');
        const finalTotalPriceSpan = document.getElementById('finalTotalPrice');

        // Customer Invoice Spans
        const customerInvoiceNameSpan = document.getElementById('customerInvoiceName');
        const customerInvoicePhoneSpan = document.getElementById('customerInvoicePhone');
        const customerItemsListDiv = document.getElementById('customerItemsList');
        const customerInvoiceTaxSpan = document.getElementById('customerInvoiceTax');
        const customerInvoiceDiscountSpan = document.getElementById('customerInvoiceDiscount');
        const customerFinalPriceSpan = document.getElementById('customerFinalPrice');


        let goldItemCounter = 0;
        let otherPurchaseCounter = 0;

        const goldModels = [
            "سرویس", "النگو", "نیم‌ست", "دستبند", "زنجیر", "گردنبند",
            "گوشواره", "مدال", "پلاک", "خلخال", "آویز ساعت", "رو لباسی", "سفارشی"
        ];

        const coinTypes = [
            'ربع ۸۶', 'نیم ۸۶', 'امامی ۸۶',
            'ربع زیر ۸۶', 'نیم زیر ۸۶', 'امامی زیر ۸۶',
            'یک گرمی بانکی'
        ];

        // Utility functions
        function toPersianNumber(num) {
            if (num === null || num === undefined) return '';
            const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return String(num).split('').map(digit => persian[parseInt(digit)] || digit).join('');
        }

        function toEnglishNumber(numStr) {
            if (typeof numStr !== 'string') numStr = String(numStr);
            const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            let englishNum = numStr.replace(/,/g, ''); // Remove commas
            for (let i = 0; i < persian.length; i++) {
                englishNum = englishNum.replace(new RegExp(persian[i], 'g'), i);
            }
            return englishNum;
        }

        function formatNumberWithCommas(number) {
            if (isNaN(number) || number === null) return '0';
            return new Intl.NumberFormat('fa-IR').format(Math.round(number)); // Round to nearest integer for display
        }

        function formatNumberInput(input) {
            let value = toEnglishNumber(input.value);
            if (value === '') {
                input.value = '';
                return;
            }
            // Ensure only digits and one decimal point for decimal inputs
            if (input.inputmode === 'decimal') {
                value = value.replace(/[^\d.]/g, ''); // Allow only digits and a single dot
                const parts = value.split('.');
                if (parts.length > 2) { // More than one dot
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
            } else { // Numeric only, like gold price or discount
                value = value.replace(/[^\d]/g, '');
            }

            // For goldPrice, enforce max 7 digits before formatting
            if (input.id === 'goldPrice' && value.length > 7) {
                value = value.substring(0, 7);
            }

            input.value = formatNumberWithCommas(parseFloat(value) || 0); // Format with commas and convert to Persian numbers
        }

        // Convert number to Persian text
        function numberToPersianWords(num) {
            if (num === 0) return 'صفر';
            num = Math.floor(Math.abs(num)); // Ensure positive integer

            const units = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
            const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
            const tens = ["", "", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
            const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
            const thousands = ["", "هزار", "میلیون", "میلیارد", "تریلیون"];

            function convertLessThanThousand(n) {
                let s = "";
                if (n >= 100) {
                    s += hundreds[Math.floor(n / 100)];
                    n %= 100;
                    if (n > 0) s += " و ";
                }
                if (n >= 20) {
                    s += tens[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) s += " و ";
                }
                if (n >= 10) {
                    s += teens[n - 10];
                } else if (n > 0) {
                    s += units[n];
                }
                return s;
            }

            let result = "";
            let i = 0;
            while (num > 0) {
                const chunk = num % 1000;
                if (chunk > 0) {
                    const chunkWords = convertLessThanThousand(chunk);
                    result = chunkWords + (thousands[i] ? " " + thousands[i] : "") + (result ? " و " + result : "");
                }
                num = Math.floor(num / 1000);
                i++;
            }
            return result.trim();
        }

        // Gold Price Input Handling
        goldPriceInput.addEventListener('input', function() {
            let value = toEnglishNumber(this.value);
            if (value.length > 7) {
                value = value.substring(0, 7);
            }
            this.value = formatNumberWithCommas(parseFloat(value) || 0);

            const numericValue = parseFloat(value || 0);
            const persianText = numberToPersianWords(numericValue) + ' تومان';
            goldPriceTextDisplay.textContent = persianText;

            // Adjust font size if text is too long
            goldPriceTextDisplay.classList.remove('small-font'); // Reset first
            if (goldPriceTextDisplay.scrollWidth > goldPriceTextDisplay.clientWidth + 5) { // Add a small buffer
                goldPriceTextDisplay.classList.add('small-font');
            }
            calculateTotal();
        });

        // Add Gold Item
        function addGoldItem() {
            goldItemCounter++;
            const newItemHtml = `
                <div class="item-section" id="goldItem_${goldItemCounter}">
                    <button type="button" class="remove-item-btn" onclick="removeGoldItem('goldItem_${goldItemCounter}')">X</button>
                    <h3>آیتم طلای ${toPersianNumber(goldItemCounter)}</h3>
                    <div class="form-group">
                        <label for="goldModel_${goldItemCounter}">مدل طلا:</label>
                        <select id="goldModel_${goldItemCounter}" onchange="calculateTotal()">
                            ${goldModels.map(model => `<option value="${model}">${model}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="goldWeight_${goldItemCounter}">وزن طلا (گرم):</label>
                        <input type="text" id="goldWeight_${goldItemCounter}" placeholder="مثال: ۱۲.۵" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label for="wage_${goldItemCounter}">اجرت (درصد % یا تومان $):</label>
                        <div class="input-inline">
                            <input type="text" id="wage_${goldItemCounter}" value="0" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            <div class="toggle-group" id="wageToggleGroup_${goldItemCounter}">
                                <button type="button" class="wage-type-btn active" data-type="percent" onclick="toggleWageType(this, 'wage_${goldItemCounter}')">%</button>
                                <button type="button" class="wage-type-btn" data-type="toman" onclick="toggleWageType(this, 'wage_${goldItemCounter}')">$</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            goldItemsContainer.insertAdjacentHTML('beforeend', newItemHtml);
            calculateTotal();
        }

        function removeGoldItem(id) {
            document.getElementById(id).remove();
            calculateTotal();
        }

        function toggleWageType(button, inputId) {
            const parent = button.closest('.toggle-group');
            parent.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            calculateTotal(); // Recalculate if wage type changes
        }

        // Add Other Purchase Item
        function addOtherPurchase(type) {
            otherPurchaseCounter++;
            let newItemHtml = '';
            const commonHtml = `
                <button type="button" class="remove-item-btn" onclick="removeOtherPurchase('otherPurchase_${otherPurchaseCounter}')">X</button>
            `;

            switch (type) {
                case 'gold':
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_gold_${otherPurchaseCounter}" data-type="gold">
                            ${commonHtml}
                            <h3>خرید طلا (اضافی) ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="otherGoldWeight_${otherPurchaseCounter}">وزن طلا (گرم):</label>
                                <input type="text" id="otherGoldWeight_${otherPurchaseCounter}" placeholder="مثال: ۵.۲" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
                case 'shemsh':
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_shemsh_${otherPurchaseCounter}" data-type="shemsh">
                            ${commonHtml}
                            <h3>خرید شمش ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="shemshWeight_${otherPurchaseCounter}">وزن شمش (گرم):</label>
                                <input type="text" id="shemshWeight_${otherPurchaseCounter}" placeholder="مثال: ۱۰۰" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
                case 'parsian':
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_parsian_${otherPurchaseCounter}" data-type="parsian">
                            ${commonHtml}
                            <h3>خرید سکه پارسیان ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="parsianWeight_${otherPurchaseCounter}">وزن سکه پارسیان (گرم):</label>
                                <input type="text" id="parsianWeight_${otherPurchaseCounter}" placeholder="مثال: ۱" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
                case 'coin':
                    const coinOptions = coinTypes.map(coin => `<option value="${coin}">${coin}</option>`).join('');
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_coin_${otherPurchaseCounter}" data-type="coin">
                            ${commonHtml}
                            <h3>خرید سکه ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="coinType_${otherPurchaseCounter}">مدل سکه:</label>
                                <select id="coinType_${otherPurchaseCounter}" onchange="calculateTotal()">
                                    ${coinOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="coinCount_${otherPurchaseCounter}">تعداد سکه:</label>
                                <input type="number" id="coinCount_${otherPurchaseCounter}" value="1" min="1" oninput="calculateTotal()">
                            </div>
                            <div class="form-group">
                                <label for="coinPrice_${otherPurchaseCounter}">مبلغ سکه (تومان):</label>
                                <input type="text" id="coinPrice_${otherPurchaseCounter}" value="0" inputmode="numeric" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
            }
            otherPurchasesContainer.insertAdjacentHTML('beforeend', newItemHtml);
            calculateTotal();
        }

        function removeOtherPurchase(id) {
            document.getElementById(id).remove();
            calculateTotal();
        }

        // Main Calculation Logic
        function calculateTotal() {
            const currentGoldPricePerGram = parseFloat(toEnglishNumber(goldPriceInput.value) || 0);
            const sellerProfitPercentage = parseFloat(sellerProfitSelect.value || 7);
            const enableTax = enableTaxCheckbox.checked;
            let totalOverallPrice = 0; // Sum of base price + profit + wage for all items
            let totalTaxableAmount = 0; // Sum of profit and wage for tax calculation across all gold items

            // Clear previous invoice details
            finalInvoiceDetailsDiv.innerHTML = '';
            customerItemsListDiv.innerHTML = ''; // Clear for customer invoice too

            // Calculate Gold Items
            document.querySelectorAll('#goldItemsContainer .item-section').forEach((itemDiv) => {
                const itemId = itemDiv.id.split('_')[1];

                const model = document.getElementById(`goldModel_${itemId}`).value;
                const weight = parseFloat(toEnglishNumber(document.getElementById(`goldWeight_${itemId}`).value) || 0);
                let wageValue = parseFloat(toEnglishNumber(document.getElementById(`wage_${itemId}`).value) || 0);
                const wageTypeButton = itemDiv.querySelector('.wage-type-btn.active');
                const wageType = wageTypeButton ? wageTypeButton.dataset.type : 'percent';

                let itemBasePrice = weight * currentGoldPricePerGram;
                let itemProfit = itemBasePrice * (sellerProfitPercentage / 100);
                let itemWageToman = 0;

                if (wageType === 'percent') {
                    itemWageToman = itemBasePrice * (wageValue / 100);
                } else { // toman
                    itemWageToman = wageValue;
                }

                const itemPrice = itemBasePrice + itemProfit + itemWageToman;
                totalOverallPrice += itemPrice;
                totalTaxableAmount += itemProfit + itemWageToman;

                // Add to final invoice
                finalInvoiceDetailsDiv.insertAdjacentHTML('beforeend', `
                    <div class="invoice-item">
                        <span>طلا (${model}, ${toPersianNumber(weight)} گرم):</span>
                        <span>${formatNumberWithCommas(itemPrice)} تومان</span>
                    </div>
                `);

                // Add to customer invoice
                customerItemsListDiv.insertAdjacentHTML('beforeend', `
                    <div>
                        <strong>مدل طلا:</strong> ${model}<br>
                        <p style="margin: 5px 0 0 0; padding-right: 20px;">
                            <strong>وزن:</strong> ${toPersianNumber(weight)} گرم<br>
                            <strong>قیمت:</strong> ${formatNumberWithCommas(itemPrice)} تومان<br>
                            ${itemWageToman > 0 ? `<strong>اجرت:</strong> ${formatNumberWithCommas(itemWageToman)} تومان<br>` : ''}
                        </p>
                    </div>
                `);
            });

            // Calculate Other Purchase Items
            document.querySelectorAll('#otherPurchasesContainer .item-section').forEach((itemDiv) => {
                const itemId = itemDiv.id.split('_').pop(); // Get numerical ID part
                const itemType = itemDiv.dataset.type; // Get data-type attribute

                let itemTotalCost = 0;
                let itemDescription = '';

                switch (itemType) {
                    case 'gold': // Additional Gold
                        const otherGoldWeight = parseFloat(toEnglishNumber(document.getElementById(`otherGoldWeight_${itemId}`).value) || 0);
                        itemTotalCost = otherGoldWeight * currentGoldPricePerGram;
                        const otherGoldProfit = itemTotalCost * (sellerProfitPercentage / 100);
                        itemTotalCost += otherGoldProfit; // Apply profit to additional gold
                        totalTaxableAmount += otherGoldProfit; // Add profit to taxable amount
                        itemDescription = `طلا اضافی (${toPersianNumber(otherGoldWeight)} گرم)`;
                        break;
                    case 'shemsh': // Shemsh
                        const shemshWeight = parseFloat(toEnglishNumber(document.getElementById(`shemshWeight_${itemId}`).value) || 0);
                        itemTotalCost = (shemshWeight * 995 / 750) * currentGoldPricePerGram;
                        itemDescription = `شمش (${toPersianNumber(shemshWeight)} گرم)`;
                        break;
                    case 'parsian': // Parsian Coin
                        const parsianWeight = parseFloat(toEnglishNumber(document.getElementById(`parsianWeight_${itemId}`).value) || 0);
                        itemTotalCost = parsianWeight * currentGoldPricePerGram;
                        itemDescription = `سکه پارسیان (${toPersianNumber(parsianWeight)} گرم)`;
                        break;
                    case 'coin': // Coin
                        const coinType = document.getElementById(`coinType_${itemId}`).value;
                        const coinCount = parseInt(document.getElementById(`coinCount_${itemId}`).value) || 1;
                        const coinPrice = parseFloat(toEnglishNumber(document.getElementById(`coinPrice_${itemId}`).value) || 0);
                        itemTotalCost = coinCount * coinPrice;
                        itemDescription = `سکه (${coinType}, ${toPersianNumber(coinCount)} عدد)`;
                        break;
                }
                totalOverallPrice += itemTotalCost;

                // Add to final invoice
                finalInvoiceDetailsDiv.insertAdjacentHTML('beforeend', `
                    <div class="invoice-item">
                        <span>${itemDescription}:</span>
                        <span>${formatNumberWithCommas(itemTotalCost)} تومان</span>
                    </div>
                `);

                // Add to customer invoice
                customerItemsListDiv.insertAdjacentHTML('beforeend', `
                    <div>
                        <strong>${itemDescription.split('(')[0].trim()}:</strong>
                        <p style="margin: 5px 0 0 0; padding-right: 20px;">
                            ${itemDescription.includes('مدل') ? `<strong>مدل:</strong> ${itemDescription.split('(')[1].split(',')[0]}<br>` : ''}
                            ${itemDescription.includes('وزن') ? `<strong>وزن:</strong> ${itemDescription.split('(')[1].split(',')[0]}<br>` : ''}
                            ${itemDescription.includes('تعداد') ? `<strong>تعداد:</strong> ${itemDescription.split(',')[1].replace(')', '')}<br>` : ''}
                            <strong>قیمت:</strong> ${formatNumberWithCommas(itemTotalCost)} تومان<br>
                        </p>
                    </div>
                `);
            });

            let totalTaxAmount = 0;
            if (enableTax) {
                totalTaxAmount = totalTaxableAmount * 0.10;
            }

            let manualDiscount = parseFloat(toEnglishNumber(manualDiscountInput.value) || 0);

            let finalCalculatedPrice = totalOverallPrice + totalTaxAmount - manualDiscount;

            // Update smart discount options
            updateSmartDiscountOptions(finalCalculatedPrice);

            // Update Final Invoice Display
            invoiceTaxAmountSpan.textContent = `${formatNumberWithCommas(totalTaxAmount)} تومان`;
            invoiceDiscountAmountSpan.textContent = `${formatNumberWithCommas(manualDiscount)} تومان`;
            finalTotalPriceSpan.textContent = `${formatNumberWithCommas(finalCalculatedPrice)} تومان`;

            // Update Customer Invoice Display
            updateCustomerInvoice(); // This function handles customer name/phone and final amounts
            customerInvoiceTaxSpan.textContent = `${formatNumberWithCommas(totalTaxAmount)} تومان`;
            customerInvoiceDiscountSpan.textContent = `${formatNumberWithCommas(manualDiscount)} تومان`;
            customerFinalPriceSpan.textContent = `${formatNumberWithCommas(finalCalculatedPrice)} تومان`;
        }

        function updateCustomerInvoice() {
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;

            customerInvoiceNameSpan.textContent = customerName || '---';
            customerInvoicePhoneSpan.textContent = customerPhone || '---';
            // Other details (items, tax, discount, total) are updated in calculateTotal
        }


        function updateSmartDiscountOptions(currentTotal) {
            smartDiscountOptionsDiv.innerHTML = '';
            const options = [];

            // Calculate potential discount values for rounding
            // Round to nearest 1000
            if (currentTotal >= 1000) options.push(Math.round(currentTotal / 1000) * 1000);
            // Round to nearest 50000
            if (currentTotal >= 50000) options.push(Math.round(currentTotal / 50000) * 50000);
            // Round to nearest 100000
            if (currentTotal >= 100000) options.push(Math.round(currentTotal / 100000) * 100000);
            // Round to nearest 500000
            if (currentTotal >= 500000) options.push(Math.round(currentTotal / 500000) * 500000);


            // Filter unique, positive options that are less than or equal to currentTotal
            const uniqueOptions = [...new Set(options)]
                                    .filter(opt => opt >= 0 && opt <= currentTotal)
                                    .sort((a, b) => b - a); // Sort descending

            if (uniqueOptions.length === 0 && currentTotal > 0) {
                 const button = document.createElement('button');
                 button.type = 'button';
                 button.textContent = `تخفیف هوشمند در دسترس نیست`;
                 button.disabled = true;
                 smartDiscountOptionsDiv.appendChild(button);
            } else {
                uniqueOptions.forEach(option => {
                    const discountAmount = currentTotal - option;
                    if (discountAmount >= 0) { // Only show options that result in a non-negative discount
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.textContent = `رند به ${formatNumberWithCommas(option)} (تخفیف ${formatNumberWithCommas(discountAmount)} تومان)`;
                        button.onclick = () => {
                            manualDiscountInput.value = formatNumberWithCommas(discountAmount);
                            calculateTotal();
                        };
                        smartDiscountOptionsDiv.appendChild(button);
                    }
                });
            }
        }


        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            addGoldItem(); // Add an initial gold item
            calculateTotal(); // Perform initial calculation
        });

        // Event delegation for input fields inside dynamically added sections
        document.addEventListener('input', (event) => {
            const target = event.target;
            // Re-evaluate on specific input changes that affect calculations
            if (target.matches('[id^="goldPrice"]') ||
                target.matches('[id^="goldWeight_"]') ||
                target.matches('[id^="wage_"]') ||
                target.matches('[id^="otherGoldWeight_"]') ||
                target.matches('[id^="shemshWeight_"]') ||
                target.matches('[id^="parsianWeight_"]') ||
                target.matches('[id^="coinCount_"]') ||
                target.matches('[id^="coinPrice_"]') ||
                target.matches('[id^="manualDiscount"]'))
            {
                calculateTotal();
            }
        });

        // Event delegation for select/checkbox changes
        document.addEventListener('change', (event) => {
            const target = event.target;
            if (target.matches('[id^="goldModel_"]') ||
                target.matches('[id^="coinType_"]') ||
                target.matches('#sellerProfit') ||
                target.matches('#enableTax')) {
                calculateTotal();
            }
        });

    </script>
</body>
</html>
