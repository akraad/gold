<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاسبه‌گر حرفه‌ای طلا و جواهر</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff; /* Light Cyan */
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        h1, h2 {
            color: #ff6347; /* Tomato */
            text-align: center;
            margin-bottom: 25px;
        }

        .section-title {
            background-color: #e0f7fa; /* Light Cyan Accent */
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #00796b; /* Teal */
            border-right: 5px solid #00acc1;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1.1em;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            color: #444;
        }

        input[type="checkbox"] {
            margin-left: 10px;
            transform: scale(1.2);
        }

        .input-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-inline input {
            flex-grow: 1;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-family: 'Vazirmatn', sans-serif;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        button.add-item {
            background-color: #1e90ff; /* Dodger Blue */
        }

        button.add-item:hover {
            background-color: #1c86ee;
        }

        button.calculate {
            background-color: #ff6347; /* Tomato */
        }

        button.calculate:hover {
            background-color: #e5533d;
        }

        .output-box {
            background-color: #e0f2f7; /* Light Blue Grey */
            border: 1px solid #b3e5fc; /* Light Blue */
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #01579b; /* Dark Blue */
            overflow-wrap: break-word; /* Allow long words to break */
            word-break: break-all; /* Break all words */
        }

        .output-box.fa-number-text {
            font-size: 1em; /* Default font size */
        }

        .output-box.fa-number-text.small-font {
            font-size: 0.8em; /* Smaller font size for long text */
        }

        .flex-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .flex-item {
            flex: 1;
            min-width: 280px; /* Minimum width for flex items */
        }

        .item-list {
            border: 1px dashed #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-top: 15px;
        }

        .item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #e3f2fd; /* Light Blue Background */
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 0.95em;
            color: #0d47a1; /* Darker Blue */
        }

        .item-row span {
            flex-basis: 30%; /* Adjust as needed */
            text-align: right;
        }

        .item-row .remove-btn {
            background-color: #ff4d4d; /* Red */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .item-row .remove-btn:hover {
            background-color: #e03c3c;
        }

        .discount-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .discount-button {
            background-color: #64b5f6; /* Light Blue */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .discount-button:hover {
            background-color: #42a5f5;
        }

        .factor-section {
            border-top: 2px dashed #bbb;
            margin-top: 30px;
            padding-top: 20px;
        }

        .factor-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .factor-item span:first-child {
            font-weight: bold;
            color: #444;
        }

        .total-price {
            font-size: 1.5em;
            font-weight: bold;
            color: #d32f2f; /* Dark Red */
            margin-top: 20px;
            text-align: center;
            background-color: #ffe0b2; /* Light Orange */
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ffb74d; /* Orange Accent */
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.5em;
            }

            .button-group button {
                width: 100%;
                margin-bottom: 10px;
            }

            .flex-container {
                flex-direction: column;
            }

            .item-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .item-row span {
                text-align: right;
                width: 100%;
            }

            .item-row .remove-btn {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>محاسبه‌گر حرفه‌ای طلا و جواهر</h1>
        ---
        <h2 class="section-title">اطلاعات پایه طلا</h2>
        <div class="flex-container">
            <div class="form-group flex-item">
                <label for="goldPrice">قیمت لحظه‌ای طلا (تومان، ۷ رقم)</label>
                <input type="text" id="goldPrice" inputmode="numeric" pattern="[0-9]{1,7}" maxlength="7" onkeyup="formatGoldPrice(this); convertNumberToPersian(this.value);" dir="ltr">
            </div>
            <div class="form-group flex-item">
                <label for="goldPriceText">قیمت طلا به حروف</label>
                <div id="goldPriceText" class="output-box fa-number-text"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="section-title">محاسبه قیمت طلا</h2>
        <div id="goldItemsContainer">
            <div class="item-list" id="goldItemTemplate">
                <div class="form-group">
                    <label>وزن طلا (گرم، فارسی)</label>
                    <input type="text" class="gold-weight" placeholder="مثال: ۱.۵" dir="rtl">
                </div>
                <div class="form-group">
                    <label>مدل طلا</label>
                    <select class="gold-model">
                        <option value="سرویس">سرویس</option>
                        <option value="النگو">النگو</option>
                        <option value="نیم‌ست">نیم‌ست</option>
                        <option value="دستبند">دستبند</option>
                        <option value="زنجیر">زنجیر</option>
                        <option value="گردنبند">گردنبند</option>
                        <option value="گوشواره">گوشواره</option>
                        <option value="مدال">مدال</option>
                        <option value="پلاک">پلاک</option>
                        <option value="خلخال">خلخال</option>
                        <option value="آویز ساعت">آویز ساعت</option>
                        <option value="رو لباسی">رو لباسی</option>
                        <option value="سفارشی">سفارشی</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>اجرت</label>
                    <div class="input-inline">
                        <input type="text" class="labor-cost" placeholder="مثال: ۷.۵ یا ۵۰۰۰" dir="rtl">
                        <select class="labor-type">
                            <option value="%">%</option>
                            <option value="$">تومان</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="remove-btn">حذف این آیتم</button>
            </div>
        </div>
        <button type="button" class="add-item" onclick="addGoldItem()">+ افزودن طلا</button>
    </div>

    <div class="container">
        <h2 class="section-title">بخش خرید طلا، سکه و شمش</h2>
        <div id="purchaseItemsContainer">
            <div class="item-list" id="purchaseItemTemplate">
                <div class="form-group">
                    <label>نوع خرید</label>
                    <select class="purchase-type" onchange="togglePurchaseFields(this)">
                        <option value="">انتخاب کنید...</option>
                        <option value="gold">خرید طلا (فقط وزن)</option>
                        <option value="bar">خرید شمش (فقط وزن)</option>
                        <option value="parsian">خرید سکه پارسیان (فقط وزن)</option>
                        <option value="coin">خرید سکه (مدل و مبلغ)</option>
                    </select>
                </div>

                <div class="form-group purchase-field gold-field bar-field parsian-field" style="display:none;">
                    <label>وزن (گرم، فارسی)</label>
                    <input type="text" class="purchase-weight" placeholder="مثال: ۲.۵" dir="rtl">
                </div>

                <div class="form-group purchase-field coin-field" style="display:none;">
                    <label>مدل سکه</label>
                    <select class="coin-model">
                        <option value="ربع ۸۶">ربع ۸۶</option>
                        <option value="نیم ۸۶">نیم ۸۶</option>
                        <option value="امامی ۸۶">امامی ۸۶</option>
                        <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                        <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                        <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                        <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                    </select>
                </div>
                <div class="form-group purchase-field coin-field" style="display:none;">
                    <label>مبلغ خرید سکه (تومان)</label>
                    <input type="text" class="coin-price" placeholder="مبلغ خرید" onkeyup="formatGoldPrice(this)" dir="ltr">
                </div>
                <button type="button" class="remove-btn">حذف این آیتم</button>
            </div>
        </div>
        <button type="button" class="add-item" onclick="addPurchaseItem()">+ افزودن آیتم خرید</button>
    </div>

    <div class="container">
        <h2 class="section-title">تنظیمات نهایی</h2>
        <div class="form-group">
            <label for="sellerProfit">سود فروشنده (درصد، پیش‌فرض ۷%)</label>
            <input type="number" id="sellerProfit" min="1" max="7" value="7">
        </div>

        <div class="form-group">
            <input type="checkbox" id="enableTax" checked>
            <label for="enableTax">اعمال مالیات ۱۰% (بر سود و اجرت)</label>
        </div>

        <div class="form-group">
            <label for="discountAmount">تخفیف دستی (تومان)</label>
            <input type="text" id="discountAmount" onkeyup="formatGoldPrice(this)" dir="ltr">
        </div>

        <div class="form-group">
            <label>تخفیف هوشمند (رندسازی)</label>
            <div id="smartDiscountOptions" class="discount-options">
                </div>
        </div>
    </div>

    <div class="button-group">
        <button type="button" class="calculate" onclick="calculateFinalPrice()">محاسبه قیمت نهایی</button>
    </div>

    <div class="container factor-section">
        <h2>فاکتور نهایی</h2>
        <div id="finalFactorOutput">
            <div class="factor-item">
                <span>قیمت طلا و اجرت:</span>
                <span id="goldAndLaborTotal">۰ تومان</span>
            </div>
            <div class="factor-item">
                <span>قیمت خرید سکه/شمش/پارسیان:</span>
                <span id="purchaseTotal">۰ تومان</span>
            </div>
            <div class="factor-item">
                <span>سود فروشنده:</span>
                <span id="sellerProfitAmount">۰ تومان</span>
            </div>
            <div class="factor-item" id="taxRow" style="display:none;">
                <span>مالیات (۱۰%):</span>
                <span id="taxAmount">۰ تومان</span>
            </div>
            <div class="factor-item" id="discountRow" style="display:none;">
                <span>تخفیف:</span>
                <span id="discountOutput">۰ تومان</span>
            </div>
            <div class="total-price">
                <span>قیمت نهایی:</span>
                <span id="finalPriceTotal">۰ تومان</span>
            </div>
        </div>
    </div>

    <div class="container factor-section">
        <h2>فاکتور فروش مشتری</h2>
        <div class="form-group">
            <label for="customerName">نام خریدار:</label>
            <input type="text" id="customerName" dir="rtl">
        </div>
        <div class="form-group">
            <label for="customerPhone">شماره تماس (اختیاری):</label>
            <input type="text" id="customerPhone" dir="ltr">
        </div>

        <h3>جزئیات خرید:</h3>
        <div id="customerFactorDetails">
            <p>طلا خریداری شده:</p>
            <ul id="purchasedGoldList">
                </ul>
            <p>سکه/شمش/پارسیان خریداری شده:</p>
            <ul id="purchasedOtherList">
                </ul>
        </div>

        <div class="factor-item">
            <span>مالیات (درصورت فعال بودن):</span>
            <span id="customerTaxOutput">۰ تومان</span>
        </div>
        <div class="factor-item">
            <span>تخفیف (درصورت فعال بودن):</span>
            <span id="customerDiscountOutput">۰ تومان</span>
        </div>
        <div class="total-price">
            <span>قیمت کل:</span>
            <span id="customerFinalPriceOutput">۰ تومان</span>
        </div>
    </div>

    <script>
        // --- Utility Functions ---

        // Converts English numbers in a string to Persian numbers
        function toPersianNumber(input) {
            if (!input) return '';
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return String(input).replace(/[0-9]/g, digit => persianDigits[digit]);
        }

        // Converts Persian numbers in a string to English numbers
        function toEnglishNumber(input) {
            if (!input) return '';
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            let output = '';
            for (let i = 0; i < input.length; i++) {
                const char = input[i];
                const index = persianDigits.indexOf(char);
                if (index !== -1) {
                    output += index;
                } else {
                    output += char;
                }
            }
            return output;
        }

        // Formats number with commas and limits to 7 digits
        function formatGoldPrice(inputElement) {
            let value = toEnglishNumber(inputElement.value).replace(/,/g, '');
            if (value.length > 7) {
                value = value.substring(0, 7);
            }
            inputElement.value = toPersianNumber(value.replace(/\B(?=(\d{3})+(?!\d))/g, ','));
        }

        // Converts a number to Persian words (Simplified)
        // This is a complex function, providing a basic one. For full accuracy,
        // a more robust library might be needed.
        function convertNumberToPersian(numStr) {
            const num = parseInt(toEnglishNumber(numStr.replace(/,/g, '')), 10);
            const units = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
            const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
            const tens = ["", "", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
            const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
            const thousands = ["", "هزار", "میلیون", "میلیارد", "تریلیون"];

            if (isNaN(num) || num === 0) {
                document.getElementById('goldPriceText').innerText = "صفر تومان";
                document.getElementById('goldPriceText').classList.remove('small-font');
                return;
            }

            function convertThreeDigits(n) {
                let text = "";
                const h = Math.floor(n / 100);
                const t = Math.floor((n % 100) / 10);
                const u = n % 10;

                if (h > 0) {
                    text += hundreds[h];
                }
                if (t > 0 || u > 0) {
                    if (text !== "") text += " و ";
                    if (t === 1) {
                        text += teens[u];
                    } else {
                        text += tens[t];
                        if (u > 0) {
                            if (text !== "") text += " و ";
                            text += units[u];
                        }
                    }
                }
                return text;
            }

            let result = "";
            let chunkIndex = 0;
            let tempNum = num;

            if (num < 0) {
                result = "منفی ";
                tempNum = Math.abs(num);
            }

            if (tempNum === 0) {
                result = "صفر";
            }

            while (tempNum > 0) {
                const chunk = tempNum % 1000;
                if (chunk > 0) {
                    let convertedChunk = convertThreeDigits(chunk);
                    if (chunkIndex > 0) {
                        if (convertedChunk !== "") convertedChunk += " " + thousands[chunkIndex];
                    }
                    if (result === "") {
                        result = convertedChunk;
                    } else {
                        result = convertedChunk + " و " + result;
                    }
                }
                tempNum = Math.floor(tempNum / 1000);
                chunkIndex++;
            }

            const goldPriceTextElement = document.getElementById('goldPriceText');
            let finalText = result + " تومان";
            goldPriceTextElement.innerText = finalText;

            // Adjust font size based on text length
            if (finalText.length > 40) { // Arbitrary threshold
                goldPriceTextElement.classList.add('small-font');
            } else {
                goldPriceTextElement.classList.remove('small-font');
            }
        }

        // --- Dynamic Item Management ---
        let goldItemCounter = 0;
        let purchaseItemCounter = 0;

        function addGoldItem() {
            goldItemCounter++;
            const template = document.getElementById('goldItemTemplate');
            const clone = template.cloneNode(true);
            clone.id = `goldItem-${goldItemCounter}`;
            clone.style.display = 'block'; // Make it visible
            clone.querySelector('.gold-weight').value = '';
            clone.querySelector('.labor-cost').value = '';
            clone.querySelector('.remove-btn').onclick = function() { removeGoldItem(clone.id); };
            document.getElementById('goldItemsContainer').appendChild(clone);
        }

        function removeGoldItem(id) {
            const item = document.getElementById(id);
            if (item) {
                item.remove();
            }
        }

        function addPurchaseItem() {
            purchaseItemCounter++;
            const template = document.getElementById('purchaseItemTemplate');
            const clone = template.cloneNode(true);
            clone.id = `purchaseItem-${purchaseItemCounter}`;
            clone.style.display = 'block'; // Make it visible
            clone.querySelector('.purchase-type').value = ''; // Reset selection
            clone.querySelectorAll('.purchase-field').forEach(field => field.style.display = 'none'); // Hide all fields initially
            clone.querySelector('.purchase-weight').value = '';
            clone.querySelector('.coin-price').value = '';
            clone.querySelector('.remove-btn').onclick = function() { removePurchaseItem(clone.id); };
            document.getElementById('purchaseItemsContainer').appendChild(clone);
        }

        function removePurchaseItem(id) {
            const item = document.getElementById(id);
            if (item) {
                item.remove();
            }
        }

        function togglePurchaseFields(selectElement) {
            const parentItem = selectElement.closest('.item-list');
            const type = selectElement.value;

            parentItem.querySelectorAll('.purchase-field').forEach(field => field.style.display = 'none');

            if (type === 'gold' || type === 'bar' || type === 'parsian') {
                parentItem.querySelector('.purchase-field.gold-field').style.display = 'block';
                // Use a general class for weight field, then specific for type if needed
                if (type === 'gold') {
                    parentItem.querySelector('.purchase-weight').placeholder = "وزن طلای خرید (گرم)";
                } else if (type === 'bar') {
                    parentItem.querySelector('.purchase-weight').placeholder = "وزن شمش (گرم)";
                } else if (type === 'parsian') {
                    parentItem.querySelector('.purchase-weight').placeholder = "وزن سکه پارسیان (گرم)";
                }
            } else if (type === 'coin') {
                parentItem.querySelector('.purchase-field.coin-field:nth-of-type(1)').style.display = 'block'; // coin-model
                parentItem.querySelector('.purchase-field.coin-field:nth-of-type(2)').style.display = 'block'; // coin-price
            }
        }

        // --- Core Calculation Logic ---
        function calculateFinalPrice() {
            const goldPricePerGram = parseFloat(toEnglishNumber(document.getElementById('goldPrice').value.replace(/,/g, '')));
            if (isNaN(goldPricePerGram) || goldPricePerGram <= 0) {
                alert("لطفاً قیمت لحظه‌ای طلا را به درستی وارد کنید.");
                return;
            }

            let totalGoldAndLaborCost = 0;
            let totalSellerProfitAmount = 0;
            let totalTaxAmount = 0;
            let totalPurchaseCost = 0;
            const purchasedGoldDetails = [];
            const purchasedOtherDetails = [];

            // Calculate Gold Items
            document.querySelectorAll('#goldItemsContainer .item-list').forEach(itemDiv => {
                if (itemDiv.id === 'goldItemTemplate') return; // Skip template

                const weightInput = itemDiv.querySelector('.gold-weight');
                const modelSelect = itemDiv.querySelector('.gold-model');
                const laborInput = itemDiv.querySelector('.labor-cost');
                const laborTypeSelect = itemDiv.querySelector('.labor-type');

                const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')));
                const model = modelSelect.value;
                let laborCost = parseFloat(toEnglishNumber(laborInput.value.replace(/,/g, '')));
                const laborType = laborTypeSelect.value;

                if (isNaN(weight) || weight <= 0) {
                    alert("لطفاً وزن طلا را به درستی وارد کنید.");
                    return;
                }

                let currentItemCost = weight * goldPricePerGram;
                let currentItemLabor = 0;

                if (!isNaN(laborCost) && laborCost >= 0) {
                    if (laborType === '%') {
                        currentItemLabor = currentItemCost * (laborCost / 100);
                    } else { // تومان
                        currentItemLabor = laborCost * weight; // Assuming labor cost is per gram if in Toman
                    }
                }
                currentItemCost += currentItemLabor;

                const sellerProfitPercent = parseFloat(document.getElementById('sellerProfit').value) || 7;
                let currentItemProfit = currentItemCost * (sellerProfitPercent / 100);

                totalGoldAndLaborCost += currentItemCost;
                totalSellerProfitAmount += currentItemProfit;

                // For customer factor
                purchasedGoldDetails.push({
                    model: model,
                    weight: toPersianNumber(weight.toFixed(3)),
                    price: toPersianNumber(Math.round(currentItemCost).toLocaleString()), // Price before profit
                    labor: toPersianNumber(Math.round(currentItemLabor).toLocaleString())
                });
            });

            // Calculate Purchase Items (Sike, Shamsh, Parsian)
            document.querySelectorAll('#purchaseItemsContainer .item-list').forEach(itemDiv => {
                if (itemDiv.id === 'purchaseItemTemplate') return; // Skip template

                const purchaseTypeSelect = itemDiv.querySelector('.purchase-type');
                const purchaseType = purchaseTypeSelect.value;

                let currentPurchaseItemCost = 0;
                let detailText = '';

                if (purchaseType === 'gold') {
                    const weightInput = itemDiv.querySelector('.purchase-weight');
                    const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')));
                    if (!isNaN(weight) && weight > 0) {
                        currentPurchaseItemCost = weight * goldPricePerGram;
                        detailText = `طلا - وزن: ${toPersianNumber(weight.toFixed(3))} گرم`;
                    }
                } else if (purchaseType === 'bar') {
                    const weightInput = itemDiv.querySelector('.purchase-weight');
                    const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')));
                    if (!isNaN(weight) && weight > 0) {
                        currentPurchaseItemCost = (weight * 995 / 750) * goldPricePerGram;
                        detailText = `شمش - وزن: ${toPersianNumber(weight.toFixed(3))} گرم`;
                    }
                } else if (purchaseType === 'parsian') {
                    const weightInput = itemDiv.querySelector('.purchase-weight');
                    const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')));
                    if (!isNaN(weight) && weight > 0) {
                        currentPurchaseItemCost = weight * goldPricePerGram;
                        detailText = `سکه پارسیان - وزن: ${toPersianNumber(weight.toFixed(3))} گرم`;
                    }
                } else if (purchaseType === 'coin') {
                    const coinModelSelect = itemDiv.querySelector('.coin-model');
                    const coinPriceInput = itemDiv.querySelector('.coin-price');
                    const coinPrice = parseFloat(toEnglishNumber(coinPriceInput.value.replace(/,/g, '')));
                    const coinModel = coinModelSelect.value;
                    if (!isNaN(coinPrice) && coinPrice > 0) {
                        currentPurchaseItemCost = coinPrice;
                        detailText = `سکه - مدل: ${coinModel}`;
                    }
                }
                totalPurchaseCost += currentPurchaseItemCost;
                if (detailText) {
                    purchasedOtherDetails.push({
                        type: detailText,
                        price: toPersianNumber(Math.round(currentPurchaseItemCost).toLocaleString())
                    });
                }
            });

            let totalBeforeDiscount = totalGoldAndLaborCost + totalSellerProfitAmount + totalPurchaseCost;

            // Calculate Tax
            const enableTax = document.getElementById('enableTax').checked;
            if (enableTax) {
                // Tax is on profit and labor. We need to re-iterate or store labor cost per item.
                // For simplicity here, let's assume total labor was part of totalGoldAndLaborCost
                // and seller profit is clearly separate.
                let totalLaborForTax = 0;
                document.querySelectorAll('#goldItemsContainer .item-list').forEach(itemDiv => {
                    if (itemDiv.id === 'goldItemTemplate') return;
                    const laborInput = itemDiv.querySelector('.labor-cost');
                    const laborTypeSelect = itemDiv.querySelector('.labor-type');
                    let laborCost = parseFloat(toEnglishNumber(laborInput.value.replace(/,/g, '')));
                    const laborType = laborTypeSelect.value;
                    const weight = parseFloat(toEnglishNumber(itemDiv.querySelector('.gold-weight').value.replace(/,/g, '')));

                    if (!isNaN(laborCost) && laborCost >= 0 && !isNaN(weight) && weight > 0) {
                        if (laborType === '%') {
                             // This part is tricky. Labor % is on initial gold cost.
                             // We need original gold cost per item to calculate labor.
                             // Let's re-calculate it based on initial gold price * weight
                            const initialGoldCostPerItem = weight * goldPricePerGram;
                            totalLaborForTax += initialGoldCostPerItem * (laborCost / 100);
                        } else {
                            totalLaborForTax += laborCost * weight; // Toman per gram
                        }
                    }
                });

                totalTaxAmount = (totalLaborForTax + totalSellerProfitAmount) * 0.10; // 10% on total labor + total profit
                document.getElementById('taxRow').style.display = 'flex';
            } else {
                document.getElementById('taxRow').style.display = 'none';
            }

            // Apply Discount
            let discountAmount = parseFloat(toEnglishNumber(document.getElementById('discountAmount').value.replace(/,/g, ''))) || 0;

            let finalPrice = totalBeforeDiscount + totalTaxAmount - discountAmount;

            // --- Update UI ---
            document.getElementById('goldAndLaborTotal').innerText = toPersianNumber(Math.round(totalGoldAndLaborCost).toLocaleString()) + ' تومان';
            document.getElementById('purchaseTotal').innerText = toPersianNumber(Math.round(totalPurchaseCost).toLocaleString()) + ' تومان';
            document.getElementById('sellerProfitAmount').innerText = toPersianNumber(Math.round(totalSellerProfitAmount).toLocaleString()) + ' تومان';
            document.getElementById('taxAmount').innerText = toPersianNumber(Math.round(totalTaxAmount).toLocaleString()) + ' تومان';

            if (discountAmount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discountOutput').innerText = toPersianNumber(Math.round(discountAmount).toLocaleString()) + ' تومان';
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            document.getElementById('finalPriceTotal').innerText = toPersianNumber(Math.round(finalPrice).toLocaleString()) + ' تومان';

            // --- Smart Discount Options ---
            generateSmartDiscountOptions(finalPrice);

            // --- Customer Factor Update ---
            updateCustomerFactor(purchasedGoldDetails, purchasedOtherDetails, totalTaxAmount, discountAmount, finalPrice);
        }

        function generateSmartDiscountOptions(currentTotalPrice) {
            const optionsContainer = document.getElementById('smartDiscountOptions');
            optionsContainer.innerHTML = ''; // Clear previous options

            if (isNaN(currentTotalPrice) || currentTotalPrice <= 0) {
                return;
            }

            const options = [];
            let price = Math.round(currentTotalPrice);

            // Option 1: Round to nearest 1000
            options.push(Math.floor(price / 1000) * 1000);
            // Option 2: Round to nearest 5000 (if possible)
            options.push(Math.floor(price / 5000) * 5000);
            // Option 3: Round to nearest 10000 (if possible)
            options.push(Math.floor(price / 10000) * 10000);
            // Option 4: Round to nearest 50000 (if possible)
            options.push(Math.floor(price / 50000) * 50000);

            // Filter out duplicates and options higher than current price
            const uniqueOptions = [...new Set(options)].filter(opt => opt <= currentTotalPrice).sort((a,b) => b-a);

            uniqueOptions.forEach(opt => {
                const discountValue = currentTotalPrice - opt;
                if (discountValue >= 0) {
                    const button = document.createElement('button');
                    button.classList.add('discount-button');
                    button.type = 'button';
                    button.innerText = `تخفیف ${toPersianNumber(Math.round(discountValue).toLocaleString())} به ${toPersianNumber(Math.round(opt).toLocaleString())}`;
                    button.onclick = () => {
                        document.getElementById('discountAmount').value = toPersianNumber(Math.round(discountValue).toLocaleString());
                        calculateFinalPrice(); // Recalculate with this discount
                    };
                    optionsContainer.appendChild(button);
                }
            });
        }

        function updateCustomerFactor(goldDetails, otherDetails, tax, discount, finalPrice) {
            const purchasedGoldList = document.getElementById('purchasedGoldList');
            const purchasedOtherList = document.getElementById('purchasedOtherList');

            purchasedGoldList.innerHTML = '';
            purchasedOtherList.innerHTML = '';

            if (goldDetails.length === 0 && otherDetails.length === 0) {
                purchasedGoldList.innerHTML = '<li>اطلاعات طلای خریداری شده وارد نشده است.</li>';
            } else {
                goldDetails.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>مدل:</strong> ${item.model}<br>
                        <strong>وزن:</strong> ${item.weight} گرم<br>
                        <strong>قیمت:</strong> ${item.price} تومان<br>
                        <strong>اجرت:</strong> ${item.labor} تومان
                    `;
                    purchasedGoldList.appendChild(li);
                });
                otherDetails.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>نوع خرید:</strong> ${item.type}<br>
                        <strong>قیمت:</strong> ${item.price} تومان
                    `;
                    purchasedOtherList.appendChild(li);
                });
            }

            document.getElementById('customerTaxOutput').innerText = toPersianNumber(Math.round(tax).toLocaleString()) + ' تومان';
            document.getElementById('customerDiscountOutput').innerText = toPersianNumber(Math.round(discount).toLocaleString()) + ' تومان';
            document.getElementById('customerFinalPriceOutput').innerText = toPersianNumber(Math.round(finalPrice).toLocaleString()) + ' تومان';
        }

        // --- Initial setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Add initial gold item
            addGoldItem();
            // Hide the templates
            document.getElementById('goldItemTemplate').style.display = 'none';
            document.getElementById('purchaseItemTemplate').style.display = 'none';

            // Attach event listener for formatting gold price input
            const goldPriceInput = document.getElementById('goldPrice');
            goldPriceInput.addEventListener('input', () => {
                formatGoldPrice(goldPriceInput);
                convertNumberToPersian(goldPriceInput.value);
            });

            // Make sure initial smart discount options are generated (e.g., if a default price is there)
            // or after the first calculation.
        });
    </script>
</body>
</html>
