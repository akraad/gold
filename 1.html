<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>فاکتور طلاجات موعود</title>
<style>
  @font-face {
    font-family: 'Vazir';
    src: url('https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.woff2') format('woff2');
  }
  body {
    font-family: 'Vazir', sans-serif;
    margin: 0; padding: 1rem;
    background: #f5f5f5;
    color: #333;
  }
  h2, h3 {
    color: #4a4a4a;
    border-right: 5px solid #9c27b0;
    padding-right: 0.5rem;
  }
  .section {
    background: #fff;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin: 0.5rem 0 0.2rem;
    font-size: 0.95rem;
  }
  input, select {
    width: 100%;
    padding: 0.5rem;
    font-family: 'Vazir';
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 0.5rem;
  }
  .highlight-blue { color: #2196f3; font-weight: bold; }
  .highlight-green { color: #4caf50; font-weight: bold; }
  .highlight-red { color: #f44336; font-weight: bold; }
  .highlight-purple { color: #9c27b0; font-weight: bold; }
  .smart-discount button {
    margin: 0.2rem;
    padding: 0.3rem 0.7rem;
    background: #e8f5e9;
    border: 1px solid #4caf50;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .smart-discount button.active {
    background: #4caf50;
    color: white;
  }
  .summary {
    font-size: 1.1rem;
    margin-top: 1rem;
    border-top: 1px dashed #999;
    padding-top: 1rem;
  }
  .summary .row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.4rem;
  }
  .bold-blue {
    color: #2196f3;
    font-weight: bold;
    font-size: 1.2rem;
  }
  .flex-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .flex-row > * {
    flex: 1 1 200px;
  }
  .input-small {
    width: 100px;
  }
  .colored-bar {
    width: 5px;
    background-color: #2196f3;
    margin-left: 0.5rem;
    border-radius: 0 3px 3px 0;
  }
  .label-with-bar {
    display: flex;
    align-items: center;
  }
  .label-with-bar > label {
    flex: 1;
  }
  /* Responsive font size for price text */
  .price-text {
    font-weight: bold;
    font-size: 1.2rem;
  }
  .price-text.small-font {
    font-size: 0.8rem !important;
  }
</style>
</head>
<body>
<h2>فاکتور طلاجات موعود</h2>

<div class="section">
  <h3><span class="colored-bar"></span> مشخصات مشتری</h3>
  <label class="label-with-bar"><label>نام خریدار:</label><div class="colored-bar" style="background:#9c27b0"></div></label>
  <input type="text" id="buyerName" placeholder="فقط حروف وارد کنید" oninput="validateName(this)" autocomplete="off" />
  <label class="label-with-bar"><label>شماره تماس (اختیاری):</label><div class="colored-bar" style="background:#2196f3"></div></label>
  <input type="tel" id="buyerPhone" placeholder="حداکثر 11 رقم" maxlength="11" oninput="validatePhone(this)" autocomplete="off" />
</div>

<div class="section">
  <h3><span class="colored-bar"></span> قیمت طلا (تومان)</h3>
  <label class="label-with-bar"><label>قیمت طلا (۷ رقم):</label><div class="colored-bar" style="background:#2196f3"></div></label>
  <input type="text" id="goldPrice" maxlength="9" oninput="onGoldPriceInput(this)" autocomplete="off" />
  <div id="goldPriceWords" class="highlight-purple" style="margin-top:0.5rem;"></div>
</div>

<div class="section">
  <h3><span class="colored-bar"></span> افزودن آیتم طلا</h3>
  <div id="goldItemsContainer"></div>
  <button type="button" onclick="addGoldItem()" style="margin-top:10px;padding:0.5rem 1rem; border-radius:0.5rem; border:none; background:#2196f3; color:#fff; cursor:pointer;">➕ افزودن آیتم طلا</button>
</div>

<div class="section">
  <h3><span class="colored-bar"></span> خرید از مشتری</h3>
  <div class="flex-row">
    <div>
      <label>خرید طلا (وزن):</label>
      <input type="text" id="buyGoldWeight" oninput="formatPersianNumber(this)" placeholder="مثلاً 12.5" autocomplete="off" />
    </div>
    <div>
      <label>خرید شمش (وزن):</label>
      <input type="text" id="buyShamshWeight" oninput="formatPersianNumber(this)" placeholder="مثلاً 10" autocomplete="off" />
    </div>
    <div>
      <label>خرید پارسیان (وزن):</label>
      <input type="text" id="buyParsianWeight" oninput="formatPersianNumber(this)" placeholder="مثلاً 8" autocomplete="off" />
    </div>
  </div>
  <label style="margin-top:10px;">خرید سکه (انتخاب مدل):</label>
  <select id="buyCoinSelect" multiple size="5" style="width: 100%; max-height:120px; font-family: 'Vazir'">
    <option value="ربع ۸۶">ربع ۸۶</option>
    <option value="نیم ۸۶">نیم ۸۶</option>
    <option value="امامی ۸۶">امامی ۸۶</option>
    <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
    <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
    <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
    <option value="یک گرمی بانکی">یک گرمی بانکی</option>
  </select>
  <label style="margin-top:10px;">مبلغ سکه‌ها (تومان):</label>
  <input type="text" id="buyCoinPrice" maxlength="9" oninput="onCoinPriceInput(this)" autocomplete="off" placeholder="مثلاً 5000000" />
</div>

<div class="section">
  <h3><span class="colored-bar"></span> تنظیمات مالی</h3>
  <label for="sellerProfit">سود فروشنده (%): <span id="profitValue">۷٪</span></label>
  <input type="range" id="sellerProfit" min="1" max="7" value="7" oninput="onProfitInput()" />
  <label><input type="checkbox" id="taxToggle" checked /> اعمال مالیات ۱۰٪</label>
</div>

<div class="section">
  <h3><span class="colored-bar"></span> تخفیف</h3>
  <label>تخفیف دستی (تومان):</label>
  <input type="text" id="manualDiscount" maxlength="9" oninput="onDiscountInput(this)" autocomplete="off" placeholder="مثلاً 100000" />
  <div class="smart-discount" style="margin-top:10px;">
    <p class="highlight-green">تخفیف هوشمند:</p>
    <button type="button" onclick="toggleSmartDiscount(0)">۱۷۸۹۰۰۰۰</button>
    <button type="button" onclick="toggleSmartDiscount(1)">۱۷۸۵۰۰۰۰</button>
    <button type="button" onclick="toggleSmartDiscount(2)">۱۷۸۰۰۰۰۰</button>
    <button type="button" onclick="toggleSmartDiscount(3)">۱۷۵۰۰۰۰۰</button>
  </div>
</div>

<div class="section summary">
  <h3><span class="colored-bar"></span> فاکتور نهایی</h3>
  <div id="invoiceSummary">
    <div class="row"><span>مدل طلا:</span><span id="finalModel">-</span></div>
    <div class="row"><span>اجرت:</span><span id="finalAjrat">-</span></div>
    <div class="row"><span>مالیات:</span><span id="finalTax">-</span></div>
    <div class="row highlight-red"><span>تخفیف:</span><span id="finalDiscount">-</span></div>
    <div class="row bold-blue"><span>قیمت نهایی:</span><span id="finalPrice">-</span></div>
  </div>
</div>

<script>
// تبدیل اعداد انگلیسی به فارسی
function toFarsiDigits(str) {
  const map = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  return str.replace(/\d/g, x => map[x]);
}

// حذف اعداد از نام
function validateName(input) {
  input.value = input.value.replace(/[0-9]/g, '').replace(/[^آ-ی\s]/g,'');
}

// فقط اعداد بپذیر و حداکثر 11 رقم
function validatePhone(input) {
  input.value = input.value.replace(/[^0-9]/g, '').slice(0,11);
}

// فرمت ورودی قیمت طلا: فقط عدد و اعشار و جداسازی هزارگان
function onGoldPriceInput(input) {
  let val = input.value.replace(/[^0-9]/g, '').slice(0,7);
  if(val.length > 3){
    val = val.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  input.value = val;
  document.getElementById("goldPriceWords").innerText = numberToWords(parseInt(val.replace(/,/g,''))) + " تومان";
  calculateFinal();
}

// فرمت ورودی مبلغ سکه
function onCoinPriceInput(input) {
  let val = input.value.replace(/[^0-9]/g, '').slice(0,7);
  if(val.length > 3){
    val = val.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  input.value = val;
  calculateFinal();
}

// فرمت تخفیف دستی
function onDiscountInput(input) {
  let val = input.value.replace(/[^0-9]/g, '').slice(0,9);
  if(val.length > 3){
    val = val.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  input.value = val;
  calculateFinal();
}

// فرمت عدد فارسی با نقطه اعشار مجاز
function formatPersianNumber(input) {
  let val = input.value.replace(/[^\d.]/g, '');
  // اجازه فقط یک نقطه
  const parts = val.split('.');
  if(parts.length > 2) val = parts[0] + '.' + parts[1];
  input.value = val;
  calculateFinal();
}

// اضافه کردن آیتم طلا
function addGoldItem() {
  const container = document.getElementById("goldItemsContainer");
  const div = document.createElement("div");
  div.style.border = "1px solid #ccc";
  div.style.padding = "10px";
  div.style.marginBottom = "10px";
  div.style.borderRadius = "10px";
  div.innerHTML = `
    <div class="flex-row">
      <div>
        <label>مدل طلا:</label>
        <select class="gold-model">
          <option>سرویس</option><option>النگو</option><option>نیم‌ست</option><option>دستبند</option>
          <option>زنجیر</option><option>گردنبند</option><option>گوشواره</option><option>مدال</option>
          <option>پلاک</option><option>خلخال</option><option>آویز ساعت</option><option>رو لباسی</option><option>سفارشی</option>
        </select>
      </div>
      <div>
        <label>وزن طلا:</label>
        <input type="text" class="gold-weight" oninput="formatPersianNumber(this)" placeholder="مثلاً 12.5" autocomplete="off" />
      </div>
      <div>
        <label>اجرت (٪ یا تومان):</label>
        <input type="text"
        <input type="text" class="ajrat" placeholder="مثلاً 5% یا 50000" oninput="formatAjratInput(this)" autocomplete="off" />
      </div>
      <div>
        <button type="button" onclick="removeGoldItem(this)" style="margin-top:24px;background:#f44336;color:#fff;border:none;border-radius:5px;cursor:pointer;">حذف</button>
      </div>
    </div>
  `;
  container.appendChild(div);
  calculateFinal();
}

function removeGoldItem(btn) {
  btn.closest("div").remove();
  calculateFinal();
}

function formatAjratInput(input) {
  let val = input.value.trim();
  if(val.endsWith('%')) {
    val = val.replace(/[^0-9]/g, '').slice(0,2) + '%';
    if(parseInt(val) > 30) val = '30%';
  } else {
    val = val.replace(/[^0-9]/g, '').slice(0,7);
  }
  input.value = val;
  calculateFinal();
}

// تابع محاسبه نهایی
function calculateFinal() {
  const goldPriceInput = document.getElementById("goldPrice").value.replace(/,/g, '');
  const goldPrice = parseInt(goldPriceInput) || 0;
  if(goldPrice <= 0) {
    setFinalSummary("-", "-", "-", "-", "-");
    return;
  }

  // آیتم های طلا
  const items = document.querySelectorAll("#goldItemsContainer > div");
  let models = [];
  let ajrats = [];
  let totalPrice = 0;
  let totalAjrat = 0;
  let totalTax = 0;

  // سود فروشنده
  const profitPercent = parseInt(document.getElementById("sellerProfit").value) || 7;
  // مالیات فعال؟
  const taxEnabled = document.getElementById("taxToggle").checked;
  // تخفیف دستی
  const manualDiscountInput = document.getElementById("manualDiscount").value.replace(/,/g, '');
  let manualDiscount = parseInt(manualDiscountInput) || 0;

  // پردازش هر آیتم طلا
  items.forEach(div => {
    const model = div.querySelector(".gold-model").value || "طلا";
    let weight = parseFloat(div.querySelector(".gold-weight").value.replace(/,/g, '')) || 0;
    let ajratStr = div.querySelector(".ajrat").value.trim();
    let ajratValue = 0;
    let ajratType = "none"; // درصد یا مبلغ

    if(ajratStr.endsWith('%')) {
      ajratType = "percent";
      ajratValue = parseInt(ajratStr.replace('%','')) || 0;
      if(ajratValue > 30) ajratValue = 30;
    } else if(ajratStr.length > 0) {
      ajratType = "amount";
      ajratValue = parseInt(ajratStr) || 0;
      if(ajratValue > 9999999) ajratValue = 9999999;
    }

    models.push(model);

    // قیمت طلا برای وزن
    const goldPriceForItem = goldPrice * weight;

    // محاسبه اجرت
    let ajratAmount = 0;
    if(ajratType === "percent") ajratAmount = goldPriceForItem * ajratValue / 100;
    else if(ajratType === "amount") ajratAmount = ajratValue;

    totalAjrat += ajratAmount;

    // سود فروشنده
    const profitAmount = (goldPriceForItem + ajratAmount) * profitPercent / 100;

    // مالیات ۱۰٪ روی سود + اجرت
    let taxAmount = 0;
    if(taxEnabled) taxAmount = (ajratAmount + profitAmount) * 0.1;

    // جمع کل قیمت آیتم
    const itemTotal = goldPriceForItem + ajratAmount + profitAmount + taxAmount;
    totalPrice += itemTotal;
    totalTax += taxAmount;

    ajrats.push(ajratType === "percent" ? ajratValue + "%" : ajratType === "amount" ? toFarsiDigits(ajratAmount.toFixed(0)) + " تومان" : "-");
  });

  // بخش خرید طلا از مشتری
  // خرید طلا وزن
  const buyGoldWeight = parseFloat(document.getElementById("buyGoldWeight").value.replace(/,/g, '')) || 0;
  totalPrice += buyGoldWeight * goldPrice;

  // خرید شمش وزن
  const buyShamshWeight = parseFloat(document.getElementById("buyShamshWeight").value.replace(/,/g, '')) || 0;
  totalPrice += buyShamshWeight * 995 / 750 * goldPrice;

  // خرید پارسیان وزن
  const buyParsianWeight = parseFloat(document.getElementById("buyParsianWeight").value.replace(/,/g, '')) || 0;
  totalPrice += buyParsianWeight * goldPrice;

  // خرید سکه (قیمت دستی)
  const buyCoinPriceStr = document.getElementById("buyCoinPrice").value.replace(/,/g, '');
  const buyCoinPrice = parseInt(buyCoinPriceStr) || 0;
  totalPrice += buyCoinPrice;

  // تخفیف هوشمند
  const smartButtons = document.querySelectorAll(".smart-discount button");
  let smartDiscount = 0;
  smartButtons.forEach((btn, idx) => {
    if(btn.classList.contains("active")) {
      const val = parseInt(btn.textContent.replace(/,/g, '')) || 0;
      smartDiscount = totalPrice - val;
    }
  });

  // مجموع تخفیف
  let totalDiscount = manualDiscount + smartDiscount;
  if(totalDiscount > totalPrice) totalDiscount = totalPrice;

  // قیمت نهایی
  let finalPrice = totalPrice - totalDiscount;
  if(finalPrice < 0) finalPrice = 0;

  setFinalSummary(
    models.join(" + ") || "-",
    ajrats.join(" + ") || "-",
    taxEnabled ? toFarsiDigits(totalTax.toFixed(0)) + " تومان" : "-",
    totalDiscount > 0 ? toFarsiDigits(totalDiscount) + " تومان" : "-",
    toFarsiDigits(finalPrice.toFixed(0)) + " تومان"
  );
}

function setFinalSummary(model, ajrat, tax, discount, price) {
  document.getElementById("finalModel").innerText = model;
  document.getElementById("finalAjrat").innerText = ajrat;
  document.getElementById("finalTax").innerText = tax;
  document.getElementById("finalDiscount").innerText = discount;
  document.getElementById("finalPrice").innerText = price;
}

// تابع تبدیل عدد به حروف فارسی (ساده)
function numberToWords(num) {
  if(!num || num <= 0) return "";
  const ones = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
  const tens = ["", "ده", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
  const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
  const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
  const thousands = ["", "هزار", "میلیون", "میلیارد"];

  function chunkToWords(chunk) {
    let str = "";
    const h = Math.floor(chunk / 100);
    const t = Math.floor((chunk % 100) / 10);
    const o = chunk % 10;

    if(h > 0) str += hundreds[h] + " و ";
    if(t > 1) str += tens[t] + (o > 0 ? " و " + ones[o] : "");
    else if(t === 1) str += teens[o];
    else if(o > 0) str += ones[o];
    return str;
  }

  let parts = [];
  let i = 0;
  while(num > 0) {
    let chunk = num % 1000;
    if(chunk) parts.unshift(chunkToWords(chunk) + " " + thousands[i]);
    num = Math.floor(num / 1000);
    i++;
  }
  return parts.join(" و ").replace(/ و $/, "");
}

// تابع برای فعال/غیرفعال کردن تخفیف هوشمند
function toggleSmartDiscount(idx) {
  const buttons = document.querySelectorAll(".smart-discount button");
  if(buttons[idx].classList.contains("active")) {
    buttons[idx].classList.remove("active");
  } else {
    buttons.forEach(b => b.classList.remove("active"));
    buttons[idx].classList.add("active");
  }
  calculateFinal();
}

// آپدیت سود فروشنده
function onProfitInput() {
  const val = document.getElementById("sellerProfit").value;
  document.getElementById("profitValue").innerText = val + "٪";
  calculateFinal();
}

// رویداد کلیک و ورودی برای وزن و اجرت‌ها
document.addEventListener('input', function(e) {
  if(e.target.classList.contains('gold-weight') || e.target.classList.contains('ajrat')) {
    calculateFinal();
  }
});

// رویداد برای تغییرات در بخش خرید از مشتری
['buyGoldWeight','buyShamshWeight','buyParsianWeight','buyCoinPrice','buyCoinSelect','taxToggle','manualDiscount'].forEach(id => {
  document.getElementById(id).addEventListener('input', calculateFinal);
});
document.getElementById('taxToggle').addEventListener('change', calculateFinal);

// تابع برای تبدیل اعداد فارسی به انگلیسی در ورودی وزن و اجرت
function convertToEnglishNumber(str) {
  const persianNumbers = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  const englishNumbers = ['0','1','2','3','4','5','6','7','8','9'];
  let newStr = '';
  for(let i=0; i<str.length; i++){
    const ch = str[i];
    const index = persianNumbers.indexOf(ch);
    newStr += index >= 0 ? englishNumbers[index] : ch;
  }
  return newStr;
}

// تبدیل عدد فارسی به انگلیسی برای وزن‌ها و اجرت‌ها
document.addEventListener('input', function(e) {
  if(e.target.classList.contains('gold-weight') || e.target.classList.contains('ajrat') ||
     e.target.id === 'buyGoldWeight' || e.target.id === 'buyShamshWeight' || e.target.id === 'buyParsianWeight') {
    e.target.value = convertToEnglishNumber(e.target.value);
  }
});

// شروع اولیه
function init() {
  addGoldItem();
  calculateFinal();
}

window.onload = init;

</script>

</body>
</html>
