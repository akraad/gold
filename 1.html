<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاکتور طلا</title>
    <style>
        /* Define Persian Fonts */
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Bold.woff2') format('woff2');
            font-weight: bold;
            font-style: normal;
        }

        /* General Styles */
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 20px 10px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            direction: rtl; /* Right-to-left for Persian text */
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 25px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.9rem;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 15px;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 18px;
            font-size: 1.4rem;
            border-bottom: 1px dashed #e0e0e0;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95rem;
        }

        input[type="text"],
        select {
            width: calc(100% - 20px);
            padding: 12px 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            color: #333;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Include padding in element's total width and height */
            background-color: #fdfdfd;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .input-inline-display {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
            direction: ltr; /* Ensure numbers-in-words are LTR */
            text-align: right;
        }

        /* Item Row Styles (Sold Items) */
        .item-container {
            border: 1px dashed #ddd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            background-color: #f9f9f9;
        }

        .item-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px dotted #eee;
            align-items: flex-end; /* Align inputs to the bottom */
            position: relative;
        }

        .item-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .item-row .form-group {
            margin-bottom: 0; /* Remove bottom margin for form groups inside item-row */
        }

        .wage-type-selector {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .wage-type-selector label {
            font-weight: normal;
            font-size: 0.9rem;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .wage-type-selector input[type="radio"] {
            margin-left: 5px;
            width: auto;
            transform: scale(1.1);
        }

        .remove-item-button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            top: 5px;
            left: 5px;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            line-height: 1; /* For better alignment of the 'x' */
            height: 30px;
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-item-button:hover {
            background-color: #ffebe6;
        }

        .add-item-button,
        .add-coin-button,
        .generate-invoice-button,
        .print-invoice-button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }

        .add-item-button:hover,
        .add-coin-button:hover,
        .generate-invoice-button:hover {
            background-color: #218838;
        }

        .print-invoice-button {
            background-color: #007bff;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }

        .print-invoice-button:hover {
            background-color: #0056b3;
        }

        /* Buy Section Styles (Collapsible) */
        .buy-section-container {
            margin-top: 30px;
            border: 1px solid #dcdcdc;
            border-radius: 10px;
            background-color: #fefefe;
            overflow: hidden; /* For collapsible effect */
        }

        .buy-section-header {
            background-color: #e9ecef;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 1.2rem;
            color: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dcdcdc;
        }

        .buy-section-header:hover {
            background-color: #e2e6ea;
        }

        .buy-section-header .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .buy-section-header.expanded .toggle-icon {
            transform: rotate(90deg); /* Rotate for expanded state */
        }

        .buy-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 0 20px; /* Padding for content when expanded */
        }

        .buy-section-content.expanded {
            max-height: 1000px; /* Large enough value to cover content */
            padding-top: 15px;
            padding-bottom: 15px;
        }

        .buy-option-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
            position: relative;
        }

        .buy-option-group .form-group {
            flex: 1; /* Allow form groups to take equal space */
            margin-bottom: 0;
        }

        .buy-option-group.single-item {
            flex-wrap: wrap;
        }

        .buy-option-group.single-item .form-group {
            flex: none; /* Prevent single items from expanding */
            width: 100%; /* Take full width */
        }

        .buy-option-input {
            width: calc(100% - 20px);
            font-size: 0.95rem;
            padding: 10px;
        }

        .remove-buy-item-button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.3rem;
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            line-height: 1;
            height: 25px;
            width: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-buy-item-button:hover {
            background-color: #ffebe6;
        }

        .coin-item-group {
            border: 1px dashed #ececec;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fcfcfc;
            position: relative;
        }

        .coin-sub-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }

        .coin-sub-item .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .coin-sub-item select,
        .coin-sub-item input {
            padding: 8px;
            font-size: 0.9rem;
        }

        .coin-remove-button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
        }

        .add-item-icon-button {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: auto; /* Push to the left in RTL */
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .add-item-icon-button:hover {
            background-color: #218838;
        }

        /* Checkbox Group */
        .checkbox-group {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }

        .checkbox-group div {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-left: 10px;
            transform: scale(1.1);
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 0.95rem;
            cursor: pointer;
        }

        /* Discount Section */
        .suggested-discounts-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }

        .suggested-discounts-section h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: #0056b3;
            margin-bottom: 12px;
        }

        .discount-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .discount-suggestion-item {
            background-color: #cce9ff;
            color: #004085;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap; /* Prevent wrapping for long numbers */
        }

        .discount-suggestion-item:hover {
            background-color: #aaddff;
        }

        .discount-suggestion-item.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        /* Result Section */
        .result-section {
            margin-top: 30px;
            border-top: 2px solid #007bff;
            padding-top: 20px;
            background-color: #e7f3ff;
            border-radius: 0 0 10px 10px; /* Rounded bottom corners if section is expanded */
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 15px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.05rem;
            padding-bottom: 5px;
            border-bottom: 1px dotted #d0eaff;
        }

        .result-item:last-of-type {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2rem;
            color: #0056b3;
            margin-top: 15px;
        }

        .result-label {
            color: #444;
        }

        .result-value {
            color: #000;
            direction: ltr; /* For numbers */
            text-align: left;
        }

        .payout-info {
            background-color: #fff3cd; /* Warning yellow */
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 1.1rem;
            text-align: center;
        }

        /* Invoice Output Section */
        .invoice-output-wrapper {
            margin-top: 30px;
            border: 1px solid #dcdcdc;
            border-radius: 10px;
            background-color: #fefefe;
            overflow: hidden;
        }

        .invoice-output-header {
            background-color: #e9ecef;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 1.2rem;
            color: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dcdcdc;
        }

        .invoice-output-header:hover {
            background-color: #e2e6ea;
        }

        .invoice-output-header .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .invoice-output-header.expanded .toggle-icon {
            transform: rotate(90deg);
        }

        .invoice-output-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 0 20px;
        }

        .invoice-output-content.expanded {
            max-height: 1500px; /* Adjust as needed for invoice content */
            padding-top: 15px;
            padding-bottom: 15px;
        }

        .generated-invoice-display {
            border: 1px dashed #ccc;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #fff;
            white-space: pre-wrap; /* Preserve formatting and wrap text */
            font-family: 'Vazirmatn', sans-serif; /* Ensure invoice text uses Vazirmatn */
            font-size: 0.95rem;
            line-height: 1.8;
            color: #222;
            direction: rtl;
        }

        .invoice-section-title {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1.1rem;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }

        .invoice-item-line, .invoice-bought-item-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .invoice-item-label {
            flex-basis: 60%;
            text-align: right;
        }

        .invoice-item-value {
            flex-basis: 40%;
            text-align: left;
            direction: ltr;
        }

        .invoice-summary-line {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            margin-top: 8px;
        }
        .invoice-summary-line.total {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 15px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        .invoice-note {
            font-size: 0.85rem;
            color: #666;
            margin-top: 20px;
            text-align: center;
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 15px;
                border-radius: 8px;
            }

            h1 {
                font-size: 1.6rem;
                margin-bottom: 20px;
            }

            h2 {
                font-size: 1.2rem;
                margin-top: 25px;
            }

            input[type="text"],
            select {
                padding: 10px;
                font-size: 0.95rem;
            }

            .item-row {
                grid-template-columns: 1fr; /* Stack columns on small screens */
                gap: 10px;
            }

            .wage-type-selector {
                flex-direction: column;
                gap: 5px;
            }

            .remove-item-button {
                font-size: 1.3rem;
                height: 25px;
                width: 25px;
            }

            .add-item-button,
            .add-coin-button,
            .generate-invoice-button,
            .print-invoice-button {
                padding: 10px 15px;
                font-size: 1rem;
            }

            .buy-section-header,
            .invoice-output-header {
                font-size: 1.1rem;
                padding: 12px 15px;
            }

            .buy-section-content,
            .invoice-output-content {
                padding: 0 15px;
            }

            .buy-option-group {
                flex-direction: column;
                gap: 10px;
            }

            .buy-option-input {
                padding: 8px;
                font-size: 0.9rem;
            }

            .coin-sub-item {
                flex-direction: column;
                gap: 8px;
            }

            .result-item {
                font-size: 1rem;
            }

            .result-item:last-of-type {
                font-size: 1.1rem;
            }

            .generated-invoice-display {
                padding: 15px;
                font-size: 0.85rem;
            }

            .invoice-section-title {
                font-size: 1rem;
            }
            .invoice-summary-line {
                font-size: 0.95rem;
            }
            .invoice-summary-line.total {
                font-size: 1.05rem;
            }
        }

        /* Print Media Query */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
                color: #000;
                font-size: 12pt;
            }

            .container,
            .invoice-output-wrapper {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                max-width: 100%;
                width: 100%;
                float: none !important; /* Ensure it takes full width and doesn't float */
            }

            /* Hide all UI elements except the generated invoice */
            body > *:not(#invoiceContainer) {
                display: none !important;
            }

            #invoiceContainer {
                display: block !important;
                position: relative !important;
                margin: 0;
                padding: 0;
                max-width: 100%;
                box-shadow: none;
                border-radius: 0;
                background-color: #fff;
            }

            /* Only show generated invoice display and its parent wrapper */
            #invoiceOutputWrapper {
                display: block !important;
            }

            #invoiceOutputWrapper > *:not(#generatedInvoiceDisplay) {
                display: none !important;
            }

            #generatedInvoiceDisplay {
                display: block !important;
                border: none;
                padding: 20px;
                background-color: #fff;
                font-size: 12pt;
                line-height: 1.6;
            }
            
            /* Ensure text direction is correct in print */
            .generated-invoice-display, .invoice-section-title,
            .invoice-item-line, .invoice-bought-item-line, .invoice-summary-line,
            .invoice-note {
                direction: rtl !important;
                text-align: right !important;
            }

            .invoice-item-value, .result-value {
                direction: ltr !important;
                text-align: left !important;
            }

            /* Ensure Persian fonts are used in print */
            body, .generated-invoice-display {
                font-family: 'Vazirmatn', sans-serif !important;
            }
        }

    </style>
</head>
<body>
    <div class="container" id="invoiceContainer">
        <h1>فاکتور طلا</h1>

        <div class="form-group">
            <label for="goldPrice">قیمت هر گرم طلای ۱۸ عیار (مظنه - تومان):</label>
            <input type="text" id="goldPrice" inputmode="numeric" oninput="updateGoldPriceDisplay(); calculateFactor();" onblur="formatInput(this)">
            <span class="input-inline-display" id="goldPriceInWords"></span>
        </div>

        <h2>آیتم‌های فروخته شده (به مشتری)</h2>
        <div class="item-container" id="itemContainer">
            <div class="item-row" data-item-id="1">
                <button type="button" class="remove-item-button" onclick="removeItem(this)">✖</button>
                <div class="form-group">
                    <label>وزن طلا (گرم):</label>
                    <input type="text" class="gold-weight buy-option-input" inputmode="decimal" oninput="calculateFactor();" onblur="formatInput(this)">
                </div>
                <div class="form-group">
                    <label>نوع محصول (اختیاری):</label>
                    <input type="text" class="product-type buy-option-input">
                </div>
                <div class="form-group">
                    <label>اجرت:</label>
                    <div class="wage-type-selector">
                        <label><input type="radio" name="wageType_1" value="percent" checked onchange="toggleWageInput(this); calculateFactor();"> درصد</label>
                        <label><input type="radio" name="wageType_1" value="toman" onchange="toggleWageInput(this); calculateFactor();"> تومان</label>
                    </div>
                    <input type="text" class="gold-wage buy-option-input" inputmode="numeric" oninput="updateWageInWordsDisplay(this); calculateFactor();" onblur="formatInput(this)">
                    <span class="input-inline-display wage-in-words"></span>
                </div>
            </div>
        </div>
        <button type="button" class="add-item-button" onclick="addItem()">افزودن آیتم جدید</button>

        <hr>

        <div class="buy-section-container" id="buyGoldSection">
            <h2 class="buy-section-header" onclick="toggleBuySection(this, 'buyGoldContent')">
                خرید طلا (از مشتری - آب‌شده/متفرقه)
                <span class="toggle-icon">▶</span>
            </h2>
            <div class="buy-section-content" id="buyGoldContent">
                <div class="buy-option-group single-item" data-buy-item-id="gold1">
                    <button type="button" class="remove-buy-item-button" onclick="removeBuyItem(this)">✖</button>
                    <div class="form-group">
                        <label>وزن طلا (گرم):</label>
                        <input type="text" id="buyGoldWeight1" class="buy-option-input" inputmode="decimal" oninput="calculateFactor();" onblur="formatInput(this)">
                    </div>
                </div>
            </div>
        </div>

        <div class="buy-section-container" id="buyCoinSection">
            <h2 class="buy-section-header" onclick="toggleBuySection(this, 'buyCoinContent')">
                خرید سکه (از مشتری)
                <span class="add-item-icon-button" onclick="event.stopPropagation(); addCoinGroup()">+</span>
                <span class="toggle-icon">▶</span>
            </h2>
            <div class="buy-section-content" id="buyCoinContent">
                <div class="coin-item-container" id="buyCoinItemContainer">
                    <div class="coin-item-group" data-coin-group-id="1">
                        <button type="button" class="remove-buy-item-button" onclick="removeCoinGroup(this)">✖</button>
                        <div class="coin-sub-item" data-coin-id="1-1">
                            <div class="form-group">
                                <label>مدل سکه:</label>
                                <select class="coin-model-select buy-option-input" onchange="calculateFactor()">
                                    <option value="none">انتخاب کنید</option>
                                    <option value="تمام بهار آزادی">تمام بهار آزادی</option>
                                    <option value="نیم بهار آزادی">نیم بهار آزادی</option>
                                    <option value="ربع بهار آزادی">ربع بهار آزادی</option>
                                    <option value="سکه گرمی">سکه گرمی</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>قیمت سکه (تومان):</label>
                                <input type="text" class="coin-price-input buy-option-input" inputmode="numeric" oninput="calculateFactor();" onblur="formatInput(this)">
                            </div>
                            <button type="button" class="coin-remove-button" onclick="removeCoin(this)">✖</button>
                        </div>
                        <button type="button" class="add-coin-button" onclick="addCoin(this)">افزودن سکه جدید</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="buy-section-container" id="buyParsianIngotSection">
            <h2 class="buy-section-header" onclick="toggleBuySection(this, 'buyParsianIngotContent')">
                خرید پارسیان و شمش (از مشتری)
                <span class="toggle-icon">▶</span>
            </h2>
            <div class="buy-section-content" id="buyParsianIngotContent">
                <div class="buy-option-group single-item" data-buy-item-id="parsian1">
                    <button type="button" class="remove-buy-item-button" onclick="removeBuyItem(this)">✖</button>
                    <div class="form-group">
                        <label>وزن سکه پارسیان (گرم):</label>
                        <input type="text" id="buyParsianWeight1" class="buy-option-input" inputmode="decimal" oninput="calculateFactor();" onblur="formatInput(this)">
                    </div>
                </div>
                <div class="buy-option-group single-item" data-buy-item-id="ingot1">
                    <button type="button" class="remove-buy-item-button" onclick="removeBuyItem(this)">✖</button>
                    <div class="form-group">
                        <label>وزن شمش (گرم - عیار 995):</label>
                        <input type="text" id="buyIngotWeight1" class="buy-option-input" inputmode="decimal" oninput="calculateFactor();" onblur="formatInput(this)">
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <div class="form-group">
            <label for="profitRate">سود فروشنده:</label>
            <select id="profitRate" onchange="calculateFactor()">
                <option value="0.07" selected>7%</option>
                <option value="0.05">5%</option>
                <option value="0.03">3%</option>
                <option value="0.02">2%</option>
                <option value="0">0%</option>
            </select>
        </div>

        <div class="checkbox-group">
            <div>
                <input type="checkbox" id="includeTax" onchange="calculateFactor()">
                <label for="includeTax">محاسبه مالیات (10% بر اجرت و سود)</label>
            </div>
            <div>
                <input type="checkbox" id="buyDiffGoldWithDiscount" onchange="calculateFactor()">
                <label for="buyDiffGoldWithDiscount">خرید ما به تفاوت طلای مشتری به مظنه (کسر 2%)</label>
            </div>
        </div>

        <div class="form-group">
            <label for="discount">تخفیف دستی (تومان):</label>
            <input type="text" id="discount" inputmode="numeric" oninput="clearSuggestedDiscountHighlight(); calculateFactor();" onblur="formatInput(this)">
        </div>

        <div class="suggested-discounts-section" id="suggestedDiscountsSection">
            <h3>تخفیفات پیشنهادی (برای رند کردن):</h3>
            <div class="discount-suggestions" id="discountSuggestions">
                </div>
        </div>

        <hr>

        <div class="result-section" id="resultSection">
            <h2>نتایج محاسبات</h2>
            <div class="result-item">
                <span class="result-label">مجموع قیمت آیتم‌های فروش (بدون مالیات):</span>
                <span class="result-value" id="totalSoldItemsPrice">0 تومان</span>
            </div>
            <div class="result-item">
                <span class="result-label">مجموع مالیات بر ارزش افزوده:</span>
                <span class="result-value" id="totalTax">0 تومان</span>
            </div>
            <div class="result-item">
                <span class="result-label">مجموع خرید از مشتری:</span>
                <span class="result-value" id="totalBoughtFromCustomer">0 تومان</span>
            </div>
            <div class="result-item" id="buyDiffGoldDisplay" style="display: none;">
                <span class="result-label">ما به تفاوت طلای خام خریداری شده:</span>
                <span class="result-value" id="buyDiffGoldAmount">0 تومان</span>
            </div>
            <div class="result-item total">
                <span class="result-label" id="finalResultLabel">مبلغ نهایی قابل پرداخت:</span>
                <span class="result-value" id="finalTotalPrice">0 تومان</span>
            </div>
            <div class="payout-info" id="payoutInfo" style="display: none;">
                <span>فروشنده باید مبلغ <strong id="customerPayoutAmount">0 تومان</strong> به مشتری پرداخت کند.</span>
            </div>
        </div>

        <div class="invoice-output-wrapper" id="invoiceOutputWrapper">
            <h2 class="invoice-output-header" onclick="toggleInvoiceOutput()">
                ارائه فاکتور فروش
                <span class="toggle-icon">▶</span>
            </h2>
            <div class="invoice-output-content" id="invoiceOutputContent">
                <div class="form-group">
                    <label for="customerName">نام خریدار:</label>
                    <input type="text" id="customerName">
                </div>
                <div class="form-group">
                    <label for="customerPhone">شماره تماس خریدار (اختیاری):</label>
                    <input type="text" id="customerPhone" inputmode="numeric">
                </div>
                <button type="button" class="generate-invoice-button" onclick="generateInvoiceDisplay()">نمایش فاکتور</button>
                <div class="generated-invoice-display" id="generatedInvoiceDisplay">
                    </div>
                <button type="button" class="print-invoice-button" id="printInvoiceButton" onclick="printInvoice()">چاپ فاکتور</button>
            </div>
        </div>

    </div>

    <script>
        let goldPriceInput = document.getElementById('goldPrice');
        let goldPriceInWordsDisplay = document.getElementById('goldPriceInWords');
        let itemContainer = document.getElementById('itemContainer');
        let buyGoldWeightInput = document.getElementById('buyGoldWeight1');
        let buyParsianWeightInput = document.getElementById('buyParsianWeight1');
        let buyIngotWeightInput = document.getElementById('buyIngotWeight1');
        let buyCoinItemContainer = document.getElementById('buyCoinItemContainer');
        let profitRateSelect = document.getElementById('profitRate');
        let includeTaxCheckbox = document.getElementById('includeTax');
        let buyDiffGoldWithDiscountCheckbox = document.getElementById('buyDiffGoldWithDiscount');
        let discountInput = document.getElementById('discount');
        let suggestedDiscountsSection = document.getElementById('suggestedDiscountsSection');
        let discountSuggestions = document.getElementById('discountSuggestions');

        let totalSoldItemsPriceDisplay = document.getElementById('totalSoldItemsPrice');
        let totalTaxDisplay = document.getElementById('totalTax');
        let totalBoughtFromCustomerDisplay = document.getElementById('totalBoughtFromCustomer');
        let buyDiffGoldDisplay = document.getElementById('buyDiffGoldDisplay');
        let buyDiffGoldAmountDisplay = document.getElementById('buyDiffGoldAmount');
        let finalTotalPriceDisplay = document.getElementById('finalTotalPrice');
        let finalResultLabel = document.getElementById('finalResultLabel');
        let payoutInfo = document.getElementById('payoutInfo');
        let customerPayoutAmountDisplay = document.getElementById('customerPayoutAmount');

        let generatedInvoiceDisplay = document.getElementById('generatedInvoiceDisplay');
        let printInvoiceButton = document.getElementById('printInvoiceButton');
        let customerNameInput = document.getElementById('customerName');
        let customerPhoneInput = document.getElementById('customerPhone');

        let itemCounter = 1;
        let coinGroupCounter = 1;

        let activeDiscountValue = 0;
        let activeDiscountType = ''; // 'suggested' or 'manual'

        // Global object to store final calculated data for invoice generation
        let finalCalculatedData = {};

        // --- Utility Functions for Persian Numbers and Formatting ---

        const farsiDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

        function convertToFarsiDigits(input) {
            if (typeof input !== 'string') input = input.toString();
            return input.replace(/\d/g, x => farsiDigits[parseInt(x)]);
        }

        function convertToEnglishDigits(input) {
            if (typeof input !== 'string') input = input.toString();
            return input.replace(/[۰-۹]/g, x => englishDigits.indexOf(x));
        }

        function formatNumberWithCommas(number) {
            if (isNaN(number)) return '';
            let parts = number.toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        function formatCurrency(amount) {
            if (isNaN(amount) || amount === null) return '۰ تومان';
            return convertToFarsiDigits(formatNumberWithCommas(Math.abs(Math.round(amount)))) + ' تومان';
        }

        function convertNumberToWords(num) {
            num = Math.floor(Math.abs(num)); // Handle absolute integer value
            if (num === 0) return 'صفر';

            const units = ['', 'هزار', 'میلیون', 'میلیارد', 'تریلیون'];
            const teens = ['یازده', 'دوازده', 'سیزده', 'چهارده', 'پانزده', 'شانزده', 'هفده', 'هجده', 'نوزده'];
            const tens = ['', 'ده', 'بیست', 'سی', 'چهل', 'پنجاه', 'شصت', 'هفتاد', 'هشتاد', 'نود'];
            const hundreds = ['', 'صد', 'دویست', 'سیصد', 'چهارصد', 'پانصد', 'ششصد', 'هفتصد', 'هشتصد', 'نهصد'];
            const ones = ['', 'یک', 'دو', 'سه', 'چهار', 'پنج', 'شش', 'هفت', 'هشت', 'نه'];

            function convertLessThanThousand(n) {
                let s = '';
                let h = Math.floor(n / 100);
                let t = Math.floor((n % 100) / 10);
                let o = n % 10;

                if (h > 0) {
                    s += hundreds[h];
                }

                if (t === 1 && o > 0) { // 11-19
                    if (s) s += ' و ';
                    s += teens[o - 1];
                } else if (t > 0 || o > 0) { // 1-10, 20-99
                    if (s) s += ' و ';
                    if (t > 0) {
                        s += tens[t];
                    }
                    if (o > 0) {
                        if (t > 0) s += ' و ';
                        s += ones[o];
                    }
                }
                return s;
            }

            let words = [];
            let i = 0;
            if (num < 1000) {
                words.push(convertLessThanThousand(num));
            } else {
                while (num > 0) {
                    let chunk = num % 1000;
                    if (chunk > 0) {
                        let chunkWords = convertLessThanThousand(chunk);
                        if (i > 0) { // Don't add unit if it's the first chunk (ones)
                            chunkWords += ' ' + units[i];
                        }
                        words.unshift(chunkWords); // Add to the beginning
                    }
                    num = Math.floor(num / 1000);
                    i++;
                }
            }

            return words.join(' و ');
        }

        function formatInput(inputElement) {
            let value = convertToEnglishDigits(inputElement.value).replace(/,/g, '');
            let parsedValue = parseFloat(value);
            if (!isNaN(parsedValue)) {
                inputElement.value = formatNumberWithCommas(parsedValue);
            } else {
                inputElement.value = '';
            }
        }

        // --- Dynamic UI Management ---

        function addInputEventListeners(container) {
            container.querySelectorAll('input[type="text"], select, input[type="checkbox"], input[type="radio"]').forEach(input => {
                // Ensure event listeners are not duplicated
                input.removeEventListener('input', calculateFactor);
                input.removeEventListener('change', calculateFactor);
                input.removeEventListener('blur', () => formatInput(input));
                
                input.addEventListener('input', calculateFactor);
                input.addEventListener('change', calculateFactor);
                input.addEventListener('blur', () => formatInput(input));
            });

            // Specific listeners for 'oninput' only needed for display
            container.querySelectorAll('.gold-wage').forEach(input => {
                input.removeEventListener('input', updateWageInWordsDisplay);
                input.addEventListener('input', () => updateWageInWordsDisplay(input));
            });
        }


        function addItem() {
            itemCounter++;
            let newItemRowHtml = `
                <div class="item-row" data-item-id="${itemCounter}">
                    <button type="button" class="remove-item-button" onclick="removeItem(this)">✖</button>
                    <div class="form-group">
                        <label>وزن طلا (گرم):</label>
                        <input type="text" class="gold-weight buy-option-input" inputmode="decimal" oninput="calculateFactor();" onblur="formatInput(this)">
                    </div>
                    <div class="form-group">
                        <label>نوع محصول (اختیاری):</label>
                        <input type="text" class="product-type buy-option-input">
                    </div>
                    <div class="form-group">
                        <label>اجرت:</label>
                        <div class="wage-type-selector">
                            <label><input type="radio" name="wageType_${itemCounter}" value="percent" checked onchange="toggleWageInput(this); calculateFactor();"> درصد</label>
                            <label><input type="radio" name="wageType_${itemCounter}" value="toman" onchange="toggleWageInput(this); calculateFactor();"> تومان</label>
                        </div>
                        <input type="text" class="gold-wage buy-option-input" inputmode="numeric" oninput="updateWageInWordsDisplay(this); calculateFactor();" onblur="formatInput(this)">
                        <span class="input-inline-display wage-in-words"></span>
                    </div>
                </div>
            `;
            itemContainer.insertAdjacentHTML('beforeend', newItemRowHtml);
            updateRemoveButtonsVisibility();
            // Add listeners to the newly added elements
            addInputEventListeners(itemContainer.lastElementChild);
            // Ensure the wage input starts correctly (for percent)
            itemContainer.lastElementChild.querySelector('.gold-wage').dataset.wageType = 'percent';
        }

        function removeItem(button) {
            const itemRow = button.closest('.item-row');
            if (itemContainer.querySelectorAll('.item-row').length > 1) {
                itemRow.remove();
            } else {
                // If only one item, clear fields instead of removing
                itemRow.querySelector('.gold-weight').value = '';
                itemRow.querySelector('.product-type').value = '';
                itemRow.querySelector('.gold-wage').value = '';
                itemRow.querySelector('.wage-in-words').textContent = '';
                itemRow.querySelector('input[name^="wageType_"][value="percent"]').checked = true;
                itemRow.querySelector('.gold-wage').dataset.wageType = 'percent'; // Reset data attribute
            }
            calculateFactor();
            updateRemoveButtonsVisibility();
        }

        function addCoinGroup() {
            coinGroupCounter++;
            let newCoinGroupHtml = `
                <div class="coin-item-group" data-coin-group-id="${coinGroupCounter}">
                    <button type="button" class="remove-buy-item-button" onclick="removeCoinGroup(this)">✖</button>
                    <div class="coin-sub-item" data-coin-id="${coinGroupCounter}-1">
                        <div class="form-group">
                            <label>مدل سکه:</label>
                            <select class="coin-model-select buy-option-input" onchange="calculateFactor()">
                                <option value="none">انتخاب کنید</option>
                                <option value="تمام بهار آزادی">تمام بهار آزادی</option>
                                <option value="نیم بهار آزادی">نیم بهار آزادی</option>
                                <option value="ربع بهار آزادی">ربع بهار آزادی</option>
                                <option value="سکه گرمی">سکه گرمی</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>قیمت سکه (تومان):</label>
                            <input type="text" class="coin-price-input buy-option-input" inputmode="numeric" oninput="calculateFactor();" onblur="formatInput(this)">
                        </div>
                        <button type="button" class="coin-remove-button" onclick="removeCoin(this)">✖</button>
                    </div>
                    <button type="button" class="add-coin-button" onclick="addCoin(this)">افزودن سکه جدید</button>
                </div>
            `;
            buyCoinItemContainer.insertAdjacentHTML('beforeend', newCoinGroupHtml);
            updateRemoveBuyButtonsVisibility();
            addInputEventListeners(buyCoinItemContainer.lastElementChild);
            // Ensure buyCoinContent is expanded
            document.getElementById('buyCoinContent').classList.add('expanded');
            document.querySelector('#buyCoinSection .buy-section-header').classList.add('expanded');
        }

        function removeCoinGroup(button) {
            const coinGroup = button.closest('.coin-item-group');
            if (buyCoinItemContainer.querySelectorAll('.coin-item-group').length > 1) {
                coinGroup.remove();
            } else {
                // If only one coin group, clear fields instead of removing
                coinGroup.querySelectorAll('.coin-model-select').forEach(select => select.value = 'none');
                coinGroup.querySelectorAll('.coin-price-input').forEach(input => {
                    input.value = '';
                    input.blur(); // Trigger formatInput
                });
            }
            calculateFactor();
            updateRemoveBuyButtonsVisibility();
        }

        function addCoin(button) {
            const coinGroup = button.closest('.coin-item-group');
            const coinGroupId = coinGroup.dataset.coinGroupId;
            const currentCoinCount = coinGroup.querySelectorAll('.coin-sub-item').length;
            const newCoinId = `${coinGroupId}-${currentCoinCount + 1}`;

            let newCoinHtml = `
                <div class="coin-sub-item" data-coin-id="${newCoinId}">
                    <div class="form-group">
                        <label>مدل سکه:</label>
                        <select class="coin-model-select buy-option-input" onchange="calculateFactor()">
                            <option value="none">انتخاب کنید</option>
                            <option value="تمام بهار آزادی">تمام بهار آزادی</option>
                            <option value="نیم بهار آزادی">نیم بهار آزادی</option>
                            <option value="ربع بهار آزادی">ربع بهار آزادی</option>
                            <option value="سکه گرمی">سکه گرمی</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>قیمت سکه (تومان):</label>
                        <input type="text" class="coin-price-input buy-option-input" inputmode="numeric" oninput="calculateFactor();" onblur="formatInput(this)">
                    </div>
                    <button type="button" class="coin-remove-button" onclick="removeCoin(this)">✖</button>
                </div>
            `;
            button.insertAdjacentHTML('beforebegin', newCoinHtml); // Insert before the add button
            updateRemoveBuyButtonsVisibility();
            addInputEventListeners(coinGroup.lastElementChild);
        }

        function removeCoin(button) {
            const coinSubItem = button.closest('.coin-sub-item');
            const coinGroup = button.closest('.coin-item-group');
            if (coinGroup.querySelectorAll('.coin-sub-item').length > 1) {
                coinSubItem.remove();
            } else {
                // If only one coin in group, clear fields instead of removing
                coinSubItem.querySelector('.coin-model-select').value = 'none';
                coinSubItem.querySelector('.coin-price-input').value = '';
                coinSubItem.querySelector('.coin-price-input').blur();
            }
            calculateFactor();
            updateRemoveBuyButtonsVisibility();
        }

        function updateRemoveButtonsVisibility() {
            const itemRows = itemContainer.querySelectorAll('.item-row');
            itemRows.forEach(row => {
                const removeBtn = row.querySelector('.remove-item-button');
                if (itemRows.length === 1) {
                    removeBtn.style.display = 'none';
                } else {
                    removeBtn.style.display = 'flex';
                }
            });
        }

        function updateRemoveBuyButtonsVisibility() {
            // Gold
            const goldBuyOptionGroup = document.querySelector('#buyGoldContent .buy-option-group');
            const goldRemoveBtn = goldBuyOptionGroup.querySelector('.remove-buy-item-button');
            if (buyGoldWeightInput.value.replace(/,/g, '').trim() === '') {
                goldRemoveBtn.style.display = 'none';
            } else {
                goldRemoveBtn.style.display = 'flex';
            }

            // Parsian
            const parsianBuyOptionGroup = document.querySelector('#buyParsianIngotContent [data-buy-item-id="parsian1"]');
            const parsianRemoveBtn = parsianBuyOptionGroup.querySelector('.remove-buy-item-button');
            if (buyParsianWeightInput.value.replace(/,/g, '').trim() === '') {
                parsianRemoveBtn.style.display = 'none';
            } else {
                parsianRemoveBtn.style.display = 'flex';
            }

            // Ingot
            const ingotBuyOptionGroup = document.querySelector('#buyParsianIngotContent [data-buy-item-id="ingot1"]');
            const ingotRemoveBtn = ingotBuyOptionGroup.querySelector('.remove-buy-item-button');
            if (buyIngotWeightInput.value.replace(/,/g, '').trim() === '') {
                ingotRemoveBtn.style.display = 'none';
            } else {
                ingotRemoveBtn.style.display = 'flex';
            }

            // Coin Groups
            const coinGroups = buyCoinItemContainer.querySelectorAll('.coin-item-group');
            coinGroups.forEach(group => {
                const removeGroupBtn = group.querySelector('.remove-buy-item-button');
                const coinSubItems = group.querySelectorAll('.coin-sub-item');
                if (coinGroups.length === 1 && coinSubItems.length === 1 && coinSubItems[0].querySelector('.coin-price-input').value.replace(/,/g, '').trim() === '') {
                    removeGroupBtn.style.display = 'none';
                } else {
                    removeGroupBtn.style.display = 'flex';
                }

                // Coin sub-items
                coinSubItems.forEach(item => {
                    const removeCoinBtn = item.querySelector('.coin-remove-button');
                    if (coinSubItems.length === 1) {
                        removeCoinBtn.style.display = 'none';
                    } else {
                        removeCoinBtn.style.display = 'flex';
                    }
                });
            });
        }

        function toggleWageInput(radio) {
            const itemRow = radio.closest('.item-row');
            const wageInput = itemRow.querySelector('.gold-wage');
            const wageInWordsSpan = itemRow.querySelector('.wage-in-words');

            wageInput.dataset.wageType = radio.value;

            // Clear the value and re-evaluate if the type changes
            wageInput.value = '';
            wageInWordsSpan.textContent = '';
            calculateFactor(); // Recalculate if type changes, value is cleared
        }

        function updateGoldPriceDisplay() {
            let price = parseFloat(convertToEnglishDigits(goldPriceInput.value.replace(/,/g, '')));
            if (!isNaN(price)) {
                goldPriceInWordsDisplay.textContent = `${convertNumberToWords(price)} تومان`;
            } else {
                goldPriceInWordsDisplay.textContent = '';
            }
        }

        function updateWageInWordsDisplay(inputElement) {
            let wage = parseFloat(convertToEnglishDigits(inputElement.value.replace(/,/g, '')));
            const wageType = inputElement.dataset.wageType;
            const wageInWordsSpan = inputElement.nextElementSibling; // The span after the input

            if (!isNaN(wage)) {
                if (wageType === 'toman') {
                    wageInWordsSpan.textContent = `${convertNumberToWords(wage)} تومان`;
                } else { // percent
                    wageInWordsSpan.textContent = `${convertToFarsiDigits(wage)} درصد`;
                }
            } else {
                wageInWordsSpan.textContent = '';
            }
        }

        function toggleBuySection(header, contentId) {
            const content = document.getElementById(contentId);
            const headerElement = header.closest('.buy-section-container').querySelector('.buy-section-header');
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                headerElement.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                headerElement.classList.add('expanded');
            }
        }

        function toggleInvoiceOutput() {
            const content = document.getElementById('invoiceOutputContent');
            const headerElement = document.getElementById('invoiceOutputWrapper').querySelector('.invoice-output-header');
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                headerElement.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                headerElement.classList.add('expanded');
            }
        }

        function clearSuggestedDiscountHighlight() {
            activeDiscountValue = 0;
            activeDiscountType = '';
            document.querySelectorAll('.discount-suggestion-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        // --- Core Calculation Logic ---

        function calculateFactor() {
            let rawGoldPrice = parseFloat(convertToEnglishDigits(goldPriceInput.value.replace(/,/g, '')));
            if (isNaN(rawGoldPrice)) {
                rawGoldPrice = 0;
            }

            let totalOverallPriceWithoutTax = 0; // Total of basePrice + wage + profit for sold items
            let totalCalculatedTax = 0; // Total tax for sold items
            let soldGoldWeight = 0; // Total weight of gold sold to customer

            const soldItemsData = []; // For invoice

            // Calculate for Sold Items
            itemContainer.querySelectorAll('.item-row').forEach(itemRow => {
                const weightInput = itemRow.querySelector('.gold-weight');
                const productTypeInput = itemRow.querySelector('.product-type');
                const wageInput = itemRow.querySelector('.gold-wage');
                const wageTypeRadio = itemRow.querySelector('input[name^="wageType_"]:checked');

                let weight = parseFloat(convertToEnglishDigits(weightInput.value.replace(/,/g, '')));
                if (isNaN(weight) || weight <= 0) weight = 0;
                soldGoldWeight += weight;

                let productType = productTypeInput.value.trim();

                let baseItemPrice = rawGoldPrice * weight;
                let wageAmount = 0;
                let profitRate = parseFloat(profitRateSelect.value); // e.g., 0.07

                if (wageTypeRadio && wageInput.value.trim() !== '') {
                    if (wageTypeRadio.value === 'percent') {
                        let wagePercent = parseFloat(convertToEnglishDigits(wageInput.value.replace(/,/g, ''))) / 100;
                        if (!isNaN(wagePercent)) wageAmount = baseItemPrice * wagePercent;
                    } else { // toman
                        let wageToman = parseFloat(convertToEnglishDigits(wageInput.value.replace(/,/g, '')));
                        if (!isNaN(wageToman)) wageAmount = wageToman;
                    }
                }
                
                let profitAmount = (baseItemPrice + wageAmount) * profitRate;

                let itemPriceWithoutTax = baseItemPrice + wageAmount + profitAmount;
                let itemTax = 0;

                if (includeTaxCheckbox.checked) {
                    let itemTaxableAmount = wageAmount + profitAmount;
                    itemTax = itemTaxableAmount * 0.10; // 10% VAT
                }

                let itemFinalPrice = itemPriceWithoutTax + itemTax;

                totalOverallPriceWithoutTax += itemPriceWithoutTax;
                totalCalculatedTax += itemTax;

                if (weight > 0 || wageAmount > 0) { // Only add to invoice data if item has value
                    soldItemsData.push({
                        weight: weight,
                        productType: productType,
                        wageType: wageTypeRadio ? wageTypeRadio.value : '',
                        wageValue: wageInput.value.trim(),
                        wageAmount: wageAmount,
                        profitAmount: profitAmount,
                        itemTax: itemTax,
                        itemFinalPrice: itemFinalPrice
                    });
                }
            });

            let totalBoughtValue = 0;
            let totalBoughtGoldWeightForDiff = 0; // For buyDiffGoldWithDiscount calculation
            const boughtItemsData = []; // For invoice

            // Calculate for Bought Gold (raw/scrap)
            let buyGoldWeight = parseFloat(convertToEnglishDigits(buyGoldWeightInput.value.replace(/,/g, '')));
            if (isNaN(buyGoldWeight) || buyGoldWeight < 0) buyGoldWeight = 0;
            if (buyGoldWeight > 0) {
                let buyGoldPrice = buyGoldWeight * rawGoldPrice;
                totalBoughtGoldWeightForDiff += buyGoldWeight;
                boughtItemsData.push({ type: 'طلا (آب‌شده/متفرقه)', weight: buyGoldWeight, price: buyGoldPrice });
            }


            // Calculate for Bought Coins
            buyCoinItemContainer.querySelectorAll('.coin-item-group').forEach(group => {
                group.querySelectorAll('.coin-sub-item').forEach(coinItem => {
                    const coinModelSelect = coinItem.querySelector('.coin-model-select');
                    const coinPriceInput = coinItem.querySelector('.coin-price-input');

                    let coinModel = coinModelSelect.value;
                    let coinPrice = parseFloat(convertToEnglishDigits(coinPriceInput.value.replace(/,/g, '')));
                    if (isNaN(coinPrice) || coinPrice < 0) coinPrice = 0;

                    if (coinModel !== 'none' && coinPrice > 0) {
                        boughtItemsData.push({ type: 'سکه', model: coinModel, price: coinPrice });
                    }
                });
            });

            // Calculate for Bought Parsian
            let buyParsianWeight = parseFloat(convertToEnglishDigits(buyParsianWeightInput.value.replace(/,/g, '')));
            if (isNaN(buyParsianWeight) || buyParsianWeight < 0) buyParsianWeight = 0;
            if (buyParsianWeight > 0) {
                let parsianPrice = buyParsianWeight * rawGoldPrice;
                boughtItemsData.push({ type: 'پارسیان', weight: buyParsianWeight, price: parsianPrice });
            }

            // Calculate for Bought Ingot
            let buyIngotWeight = parseFloat(convertToEnglishDigits(buyIngotWeightInput.value.replace(/,/g, '')));
            if (isNaN(buyIngotWeight) || buyIngotWeight < 0) buyIngotWeight = 0;
            if (buyIngotWeight > 0) {
                // Formula for converting 995 purity ingot to 750 (18k) equivalent for goldPrice
                // (Ingot Weight * Ingot Purity / 18k Purity) * Gold Price
                let ingotEquivalentWeight = (buyIngotWeight * 995 / 750);
                let ingotPrice = ingotEquivalentWeight * rawGoldPrice;
                boughtItemsData.push({ type: 'شمش', weight: buyIngotWeight, price: ingotPrice });
            }

            let buyDiffGoldAmountWithDiscount = 0;
            let buyGoldAmountAtMuzanne = 0;
            let netGoldWeightDiff = 0;

            if (buyDiffGoldWithDiscountCheckbox.checked && totalBoughtGoldWeightForDiff > soldGoldWeight && soldGoldWeight > 0) {
                netGoldWeightDiff = totalBoughtGoldWeightForDiff - soldGoldWeight;
                let priceWithDiscount = rawGoldPrice * (1 - 0.02); // 2% discount
                buyDiffGoldAmountWithDiscount = netGoldWeightDiff * priceWithDiscount;

                // Gold bought up to soldGoldWeight is at full muzanne
                buyGoldAmountAtMuzanne = soldGoldWeight * rawGoldPrice;

                // Update boughtItemsData for gold to reflect this special calculation
                // For simplicity in invoice, we can replace the gold bought entry with this breakdown.
                // Or, we can just use the combined value here for the totalBoughtValue.
                // For now, we'll calculate totalBoughtValue based on this logic.
                // The detailed breakdown in invoice will come from `boughtItemsData` modified below.

                // Remove original gold entry from boughtItemsData and add the new two
                boughtItemsData.forEach((item, index) => {
                    if (item.type === 'طلا (آب‌شده/متفرقه)') {
                        boughtItemsData.splice(index, 1); // Remove the original gold item
                    }
                });
                if (buyGoldAmountAtMuzanne > 0) boughtItemsData.push({ type: 'طلای آب‌شده (بابت فروش)', weight: soldGoldWeight, price: buyGoldAmountAtMuzanne });
                if (buyDiffGoldAmountWithDiscount > 0) boughtItemsData.push({ type: 'مابه‌التفاوت طلای آب‌شده (کسر 2%)', weight: netGoldWeightDiff, price: buyDiffGoldAmountWithDiscount });
                
                totalBoughtValue = buyGoldAmountAtMuzanne + buyDiffGoldAmountWithDiscount;

            } else {
                // If special discount is not applied or conditions not met, sum up bought gold directly
                totalBoughtValue = boughtItemsData.reduce((sum, item) => sum + item.price, 0);
            }

            // Sum up other bought items (coins, parsian, ingot)
            totalBoughtValue += boughtItemsData.filter(item => item.type !== 'طلا (آب‌شده/متفرقه)' && item.type !== 'طلای آب‌شده (بابت فروش)' && item.type !== 'مابه‌التفاوت طلای آب‌شده (کسر 2%)').reduce((sum, item) => sum + item.price, 0);


            let baseTotalFinalPriceBeforeDiscount = totalOverallPriceWithoutTax + totalCalculatedTax;
            let totalFinalPriceBeforeDiscountAndPayoutCheck = baseTotalFinalPriceBeforeDiscount - totalBoughtValue;

            let currentManualDiscount = parseFloat(convertToEnglishDigits(discountInput.value.replace(/,/g, '')));
            if (isNaN(currentManualDiscount) || currentManualDiscount < 0) currentManualDiscount = 0;

            let discountToApply = activeDiscountValue > 0 && activeDiscountType === 'suggested' ? activeDiscountValue : currentManualDiscount;

            let finalPriceAfterDiscount = totalFinalPriceBeforeDiscountAndPayoutCheck - discountToApply;

            let isCustomerPayout = false;
            let customerPayoutAmount = 0;
            let finalTotalAmount = 0;

            if (finalPriceAfterDiscount < 0) {
                isCustomerPayout = true;
                customerPayoutAmount = Math.abs(finalPriceAfterDiscount);
                finalTotalAmount = 0; // The customer pays nothing, seller pays.
            } else {
                isCustomerPayout = false;
                finalTotalAmount = finalPriceAfterDiscount;
            }

            // Update UI
            totalSoldItemsPriceDisplay.textContent = formatCurrency(totalOverallPriceWithoutTax);
            totalTaxDisplay.textContent = formatCurrency(totalCalculatedTax);
            totalBoughtFromCustomerDisplay.textContent = formatCurrency(totalBoughtValue);

            if (buyDiffGoldWithDiscountCheckbox.checked && totalBoughtGoldWeightForDiff > soldGoldWeight && soldGoldWeight > 0) {
                buyDiffGoldDisplay.style.display = 'flex';
                buyDiffGoldAmountDisplay.textContent = formatCurrency(buyDiffGoldAmountWithDiscount);
            } else {
                buyDiffGoldDisplay.style.display = 'none';
            }

            if (isCustomerPayout) {
                finalResultLabel.textContent = 'مبلغ نهایی قابل پرداخت (توسط فروشنده به مشتری):';
                finalTotalPriceDisplay.textContent = ''; // Clear customer's total
                payoutInfo.style.display = 'block';
                customerPayoutAmountDisplay.textContent = formatCurrency(customerPayoutAmount);
            } else {
                finalResultLabel.textContent = 'مبلغ نهایی قابل پرداخت (توسط مشتری به فروشنده):';
                finalTotalPriceDisplay.textContent = formatCurrency(finalTotalAmount);
                payoutInfo.style.display = 'none';
            }

            // Store for invoice generation
            finalCalculatedData = {
                rawGoldPrice,
                soldItemsData,
                totalOverallPriceWithoutTax,
                totalCalculatedTax,
                boughtItemsData,
                totalBoughtValue,
                buyDiffGoldWithDiscountApplied: buyDiffGoldWithDiscountCheckbox.checked && totalBoughtGoldWeightForDiff > soldGoldWeight && soldGoldWeight > 0,
                netGoldWeightDiff,
                buyDiffGoldAmountWithDiscount,
                isCustomerPayout,
                customerPayoutAmount,
                finalTotalAmount,
                discountToApply
            };
            
            updateSuggestedDiscounts(totalFinalPriceBeforeDiscountAndPayoutCheck);
            updateRemoveBuyButtonsVisibility(); // Update visibility after calculation based on values
            updateRemoveButtonsVisibility();
        }

        function updateSuggestedDiscounts(amount) {
            discountSuggestions.innerHTML = ''; // Clear previous suggestions
            suggestedDiscountsSection.style.display = 'none';

            if (amount <= 0) return; // Only suggest for positive amounts

            suggestedDiscountsSection.style.display = 'block';

            const originalDiscount = parseFloat(convertToEnglishDigits(discountInput.value.replace(/,/g, '')));
            if (isNaN(originalDiscount)) {
                originalDiscount = 0;
            }

            const thresholds = [10000, 50000, 100000];
            const suggestions = [];

            for (const threshold of thresholds) {
                const remainder = amount % threshold;
                if (remainder > 0) {
                    const suggestedDiscount = remainder;
                    if (suggestedDiscount > 0) {
                        suggestions.push({
                            value: suggestedDiscount,
                            text: `رند کردن به ${formatCurrency(amount - suggestedDiscount)}`
                        });
                    }
                }
            }

            // Sort suggestions by discount value (smallest first)
            suggestions.sort((a, b) => a.value - b.value);

            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'discount-suggestion-item';
                div.textContent = `${formatCurrency(suggestion.value)} - ${suggestion.text}`;
                div.onclick = () => {
                    clearSuggestedDiscountHighlight();
                    div.classList.add('active');
                    activeDiscountValue = suggestion.value;
                    activeDiscountType = 'suggested';
                    discountInput.value = formatNumberWithCommas(suggestion.value);
                    calculateFactor();
                };
                discountSuggestions.appendChild(div);
            });

            // If the current manual discount matches a suggested one, highlight it
            const currentDiscountValue = parseFloat(convertToEnglishDigits(discountInput.value.replace(/,/g, '')));
            if (activeDiscountType === 'suggested' && activeDiscountValue === currentDiscountValue) {
                document.querySelectorAll('.discount-suggestion-item').forEach(item => {
                    if (item.textContent.includes(formatCurrency(currentDiscountValue))) {
                        item.classList.add('active');
                    }
                });
            } else if (activeDiscountType !== 'suggested') {
                clearSuggestedDiscountHighlight(); // Clear if it was set by manual input
            }
        }


        // --- Invoice Generation ---
        function generateInvoiceDisplay() {
            calculateFactor(); // Ensure all calculations are up-to-date

            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const currentDate = new Date().toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let invoiceContent = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">فاکتور فروش طلا و جواهر</h3>
                    <p style="margin: 5px 0 0; font-size: 0.9em;">تاریخ: ${currentDate}</p>
                </div>
                <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed #ccc;">
                    <p style="margin: 5px 0;"><strong>نام خریدار:</strong> ${customerName || '---'}</p>
                    <p style="margin: 5px 0;"><strong>شماره تماس:</strong> ${customerPhone || '---'}</p>
                    <p style="margin: 5px 0;"><strong>قیمت هر گرم طلای ۱۸ عیار:</strong> ${formatCurrency(finalCalculatedData.rawGoldPrice)}</p>
                </div>
            `;

            if (finalCalculatedData.soldItemsData.length > 0) {
                invoiceContent += `<div class="invoice-section-title">جزئیات آیتم‌های فروش:</div>`;
                finalCalculatedData.soldItemsData.forEach((item, index) => {
                    invoiceContent += `
                        <div class="invoice-item-line">
                            <span class="invoice-item-label"> ${convertToFarsiDigits(index + 1)}. ${item.productType || 'طلا/جواهر'} (${formatNumberWithCommas(item.weight)} گرم)</span>
                            <span class="invoice-item-value">${formatCurrency(item.itemFinalPrice)}</span>
                        </div>
                        <div style="font-size: 0.8em; margin-right: 20px; color: #555;">
                            ${item.wageValue && item.wageValue.trim() !== '' ? `اجرت: ${item.wageType === 'percent' ? convertToFarsiDigits(item.wageValue) + '%' : formatCurrency(item.wageAmount)}` : ''}
                            ${item.profitAmount > 0 ? `، سود: ${formatCurrency(item.profitAmount)}` : ''}
                            ${item.itemTax > 0 ? `، مالیات: ${formatCurrency(item.itemTax)}` : ''}
                        </div>
                    `;
                });
                invoiceContent += `<hr style="border: none; border-top: 1px dotted #ccc; margin: 15px 0;">`;
            }

            if (finalCalculatedData.boughtItemsData.length > 0) {
                invoiceContent += `<div class="invoice-section-title">جزئیات خرید از مشتری:</div>`;
                finalCalculatedData.boughtItemsData.forEach((item, index) => {
                    invoiceContent += `
                        <div class="invoice-bought-item-line">
                            <span class="invoice-item-label">${convertToFarsiDigits(index + 1)}. ${item.type} 
                                ${item.weight ? `(${formatNumberWithCommas(item.weight)} گرم)` : ''}
                                ${item.model ? `(${item.model})` : ''}
                            </span>
                            <span class="invoice-item-value">${formatCurrency(item.price)}</span>
                        </div>
                    `;
                });
                invoiceContent += `<hr style="border: none; border-top: 1px dotted #ccc; margin: 15px 0;">`;
            }

            invoiceContent += `
                <div class="invoice-summary-line">
                    <span class="invoice-item-label">مجموع قیمت آیتم‌های فروش (با مالیات):</span>
                    <span class="invoice-item-value">${formatCurrency(finalCalculatedData.totalOverallPriceWithoutTax + finalCalculatedData.totalCalculatedTax)}</span>
                </div>
                <div class="invoice-summary-line">
                    <span class="invoice-item-label">مجموع خرید از مشتری:</span>
                    <span class="invoice-item-value">${formatCurrency(finalCalculatedData.totalBoughtValue)}</span>
                </div>
            `;
            
            if (finalCalculatedData.buyDiffGoldWithDiscountApplied) {
                invoiceContent += `
                    <div class="invoice-summary-line">
                        <span class="invoice-item-label">مابه‌التفاوت طلای خام خریداری شده:</span>
                        <span class="invoice-item-value">${formatCurrency(finalCalculatedData.buyDiffGoldAmountWithDiscount)}</span>
                    </div>
                `;
            }

            if (finalCalculatedData.discountToApply > 0) {
                invoiceContent += `
                    <div class="invoice-summary-line">
                        <span class="invoice-item-label">تخفیف اعمال شده:</span>
                        <span class="invoice-item-value">${formatCurrency(finalCalculatedData.discountToApply)}</span>
                    </div>
                `;
            }

            invoiceContent += `
                <div class="invoice-summary-line total">
                    <span class="invoice-item-label">مبلغ نهایی:</span>
                    <span class="invoice-item-value">
                        ${finalCalculatedData.isCustomerPayout ?
                            `<strong>${formatCurrency(finalCalculatedData.customerPayoutAmount)}</strong> (پرداخت توسط فروشنده به مشتری)` :
                            `<strong>${formatCurrency(finalCalculatedData.finalTotalAmount)}</strong> (پرداخت توسط مشتری به فروشنده)`
                        }
                    </span>
                </div>
                <div class="invoice-note">با آرزوی بهترین‌ها برای شما</div>
            `;

            generatedInvoiceDisplay.innerHTML = invoiceContent;
            printInvoiceButton.style.display = 'block'; // Show print button
            // Ensure invoice output content is expanded
            document.getElementById('invoiceOutputContent').classList.add('expanded');
            document.querySelector('#invoiceOutputWrapper .invoice-output-header').classList.add('expanded');
        }

        function printInvoice() {
            window.print();
        }

        // --- Initial Setup on Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup for removing buttons visibility
            updateRemoveButtonsVisibility();
            updateRemoveBuyButtonsVisibility();

            // Add event listeners to initial elements
            addInputEventListeners(document);

            // Set initial wage type for the first item row to percent
            const firstItemWageInput = document.querySelector('.item-row[data-item-id="1"] .gold-wage');
            if (firstItemWageInput) {
                firstItemWageInput.dataset.wageType = 'percent';
            }

            // Collapse sections by default
            document.getElementById('buyGoldContent').classList.remove('expanded');
            document.querySelector('#buyGoldSection .buy-section-header').classList.remove('expanded');
            document.getElementById('buyCoinContent').classList.remove('expanded');
            document.querySelector('#buyCoinSection .buy-section-header').classList.remove('expanded');
            document.getElementById('buyParsianIngotContent').classList.remove('expanded');
            document.querySelector('#buyParsianIngotSection .buy-section-header').classList.remove('expanded');
            document.getElementById('invoiceOutputContent').classList.remove('expanded');
            document.querySelector('#invoiceOutputWrapper .invoice-output-header').classList.remove('expanded');

            // Perform initial calculation
            calculateFactor();
