<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاسبه‌گر طلا و سکه</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* استایل‌های عمومی، رنگ‌بندی، ریسپانسیو برای موبایل */
        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            text-align: right;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff; /* رنگ پس‌زمینه شاد */
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #4a90e2; /* رنگ عنوان جذاب */
            text-align: center;
            margin-bottom: 25px;
        }
        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .input-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            width: 100%;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }
        .input-group input[type="checkbox"] {
            margin-left: 10px;
            transform: scale(1.2);
        }
        .add-item-button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .add-item-button:hover {
            background-color: #4cae4c;
        }
        .section-separator {
            border-top: 1px dashed #ccc;
            margin: 30px 0;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        .radio-group label {
            background-color: #e0f7fa;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .radio-group label:hover {
            background-color: #b2ebf2;
        }
        .radio-group input[type="radio"],
        .radio-group input[type="checkbox"] {
            margin-left: 8px;
        }
        .price-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-top: 10px;
        }
        .price-display span {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .price-display .text-price {
            font-size: 0.9em;
            color: #666;
            max-width: 50%;
            overflow-wrap: break-word; /* برای شکستن متن در صورت طولانی شدن */
        }
        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .invoice-summary {
            background-color: #e6f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid #cceeff;
        }
        .invoice-summary div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .invoice-summary div span:first-child {
            font-weight: bold;
        }
        .final-price {
            font-size: 1.5em;
            font-weight: bold;
            color: #d9534f;
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #c9302c;
        }
        /* استایل برای کنترل اندازه فونت متن تبدیل شده به حروف */
        .text-price.small-font {
            font-size: 0.7em; /* کوچکتر کردن فونت برای جلوگیری از همپوشانی */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>محاسبه‌گر طلا و سکه</h1>

        <div class="input-group">
            <label for="goldPrice">قیمت هر گرم طلای ۱۸ عیار (تومان):</label>
            <div class="price-display">
                <input type="text" id="goldPrice" placeholder="مثال: ۱,۷۸۹,۳۰۰" inputmode="numeric">
                <span id="goldPriceText" class="text-price">صفر تومان</span>
            </div>
        </div>

        <hr class="section-separator">

        <h2>محاسبه طلای فیزیکی</h2>
        <div id="goldItemsContainer">
            <div class="gold-item" id="goldItem_1">
                <div class="input-group">
                    <label for="goldWeight_1">وزن طلا (گرم):</label>
                    <input type="text" id="goldWeight_1" placeholder="مثال: ۱.۵">
                </div>
                <div class="input-group">
                    <label for="goldModel_1">مدل طلا:</label>
                    <select id="goldModel_1">
                        <option value="سرویس">سرویس</option>
                        <option value="النگو">النگو</option>
                        <option value="نیم‌ست">نیم‌ست</option>
                        <option value="دستبند">دستبند</option>
                        <option value="زنجیر">زنجیر</option>
                        <option value="گردنبند">گردنبند</option>
                        <option value="گوشواره">گوشواره</option>
                        <option value="مدال">مدال</option>
                        <option value="پلاک">پلاک</option>
                        <option value="خلخال">خلخال</option>
                        <option value="آویز ساعت">آویز ساعت</option>
                        <option value="رو لباسی">رو لباسی</option>
                        <option value="سفارشی">سفارشی</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="goldWage_1">اجرت:</label>
                    <div class="flex-row">
                        <input type="text" id="goldWage_1" placeholder="اختیاری - مثال: ۵.۵ یا ۲۰,۰۰۰">
                        <select id="goldWageType_1">
                            <option value="percent">%</option>
                            <option value="toman">$</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="add-item-button" id="addGoldItem">افزودن آیتم طلا</button>

        <hr class="section-separator">

        <h2>بخش خرید</h2>

        <div class="input-group">
            <label>خرید طلا:</label>
            <input type="text" id="buyGoldWeight" placeholder="وزن طلا (اختیاری)">
        </div>

        <div class="input-group">
            <label>خرید شمش:</label>
            <input type="text" id="buyBarWeight" placeholder="وزن شمش (اختیاری)">
        </div>

        <div class="input-group">
            <label>خرید پارسیان:</label>
            <input type="text" id="buyParsianWeight" placeholder="وزن پارسیان (اختیاری)">
        </div>

        <div class="input-group">
            <label>خرید سکه:</label>
            <div id="coinSelectionContainer">
                <div class="coin-item">
                    <select class="coin-type">
                        <option value="">انتخاب نوع سکه</option>
                        <option value="ربع ۸۶">ربع ۸۶</option>
                        <option value="نیم ۸۶">نیم ۸۶</option>
                        <option value="امامی ۸۶">امامی ۸۶</option>
                        <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                        <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                        <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                        <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                    </select>
                    <input type="text" class="coin-price" placeholder="مبلغ (اختیاری)" inputmode="numeric">
                </div>
            </div>
            <button type="button" class="add-item-button" id="addCoinItem">افزودن سکه</button>
        </div>

        <hr class="section-separator">

        <h2>تنظیمات نهایی</h2>
        <div class="input-group">
            <label for="sellerProfit">سود فروشنده (درصد):</label>
            <input type="number" id="sellerProfit" min="1" max="7" value="7">
        </div>

        <div class="input-group flex-row">
            <input type="checkbox" id="enableTax" checked>
            <label for="enableTax">اعمال مالیات ۱۰ درصد (بر روی سود و اجرت)</label>
        </div>

        <div class="input-group">
            <label for="discountAmount">تخفیف دستی (تومان):</label>
            <input type="text" id="discountAmount" placeholder="مبلغ تخفیف (اختیاری)" inputmode="numeric">
        </div>

        <div class="input-group">
            <label>تخفیف هوشمند:</label>
            <div class="radio-group" id="smartDiscountOptions">
                </div>
        </div>

        <hr class="section-separator">

        <h2>فاکتور نهایی</h2>
        <div class="invoice-summary" id="invoiceSummary">
            <div>
                <span>مالیات:</span>
                <span id="totalTax">۰ تومان</span>
            </div>
            <div>
                <span>تخفیف:</span>
                <span id="totalDiscount">۰ تومان</span>
            </div>
        </div>
        <div class="final-price">
            <span>قیمت نهایی:</span>
            <span id="finalTotalPrice">۰ تومان</span>
        </div>
    </div>

    <script>
        // Placeholder for JavaScript logic
        // All the calculation and dynamic UI updates will go here
        // Due to the complexity, a full implementation is not feasible in this text response.
        // I will outline the key functions and event listeners needed.
        document.addEventListener('DOMContentLoaded', () => {
            const goldPriceInput = document.getElementById('goldPrice');
            const goldPriceText = document.getElementById('goldPriceText');
            const goldItemsContainer = document.getElementById('goldItemsContainer');
            const addGoldItemButton = document.getElementById('addGoldItem');
            const addCoinItemButton = document.getElementById('addCoinItem');
            const coinSelectionContainer = document.getElementById('coinSelectionContainer');
            const sellerProfitInput = document.getElementById('sellerProfit');
            const enableTaxCheckbox = document.getElementById('enableTax');
            const discountAmountInput = document.getElementById('discountAmount');
            const smartDiscountOptions = document.getElementById('smartDiscountOptions');
            const invoiceSummary = document.getElementById('invoiceSummary');
            const totalTaxSpan = document.getElementById('totalTax');
            const totalDiscountSpan = document.getElementById('totalDiscount');
            const finalTotalPriceSpan = document.getElementById('finalTotalPrice');

            let goldItemCount = 1;
            let coinItemCount = 1;

            // Utility function to convert numbers to Farsi text
            function numToFarsi(num) {
                const units = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
                const tens = ["", "ده", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
                const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
                const thousands = ["", "هزار", "میلیون", "میلیارد", "تریلیون"];

                if (num === 0) return "صفر";

                let result = "";
                let i = 0;

                while (num > 0) {
                    let chunk = num % 1000;
                    num = Math.floor(num / 1000);

                    if (chunk === 0) {
                        i++;
                        continue;
                    }

                    let chunkText = "";
                    let h = Math.floor(chunk / 100);
                    let t = Math.floor((chunk % 100) / 10);
                    let u = chunk % 10;

                    if (h > 0) chunkText += hundreds[h];
                    if (t > 1) chunkText += (h > 0 ? " و " : "") + tens[t];
                    else if (t === 1) chunkText += (h > 0 ? " و " : "") + (units[u] === "" ? "" : " " + units[u]) + tens[t];
                    if (t !== 1 && u > 0) chunkText += (h > 0 || t > 0 ? " و " : "") + units[u];

                    result = chunkText + (chunkText !== "" ? " " + thousands[i] : "") + (result !== "" ? " و " : "") + result;
                    i++;
                }
                return result.trim() + " تومان";
            }

            // Function to format numbers with commas and Farsi numerals
            function formatNumberToFarsi(num) {
                if (!num) return '';
                // Convert to string and replace Latin digits with Farsi ones
                let farsiNum = String(num).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
                // Add commas for every three digits from the right
                return farsiNum.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }

            // Function to normalize input (remove commas, convert Farsi to Latin digits, handle decimal)
            function normalizeInput(input) {
                if (!input) return '';
                let cleanInput = input.replace(/,/g, ''); // Remove commas
                cleanInput = cleanInput.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); // Convert Farsi to Latin digits
                cleanInput = cleanInput.replace(/٫/g, '.'); // Convert Farsi decimal point to Latin
                return cleanInput;
            }

            // --- Event Listeners and Core Logic ---

            // 1. Gold Price Input
            goldPriceInput.addEventListener('input', (e) => {
                let value = normalizeInput(e.target.value);
                // Allow only numbers and a single decimal point if it's for weight
                if (value.includes('.')) {
                    value = value.replace(/(\..*)\./g, '$1'); // Only one decimal point
                }
                value = value.replace(/[^0-9.]/g, ''); // Remove non-numeric except dot

                // Format for display (commas, Farsi digits)
                let parts = value.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                e.target.value = parts.join('.').replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);


                // Convert to Farsi text and adjust font size
                const numericValue = parseFloat(value.replace(/,/g, ''));
                if (!isNaN(numericValue)) {
                    const farsiText = numToFarsi(numericValue);
                    goldPriceText.textContent = farsiText;
                    // Check text length and apply small-font class
                    if (farsiText.length > 25) { // Adjust threshold as needed
                        goldPriceText.classList.add('small-font');
                    } else {
                        goldPriceText.classList.remove('small-font');
                    }
                } else {
                    goldPriceText.textContent = 'صفر تومان';
                    goldPriceText.classList.remove('small-font');
                }
                calculateOverallTotal();
            });

            // 2. Add Gold Item
            addGoldItemButton.addEventListener('click', () => {
                goldItemCount++;
                const newItemHtml = `
                    <div class="gold-item" id="goldItem_${goldItemCount}">
                        <hr style="margin: 20px 0; border-top: 1px dotted #eee;">
                        <div class="input-group">
                            <label for="goldWeight_${goldItemCount}">وزن طلا (گرم):</label>
                            <input type="text" id="goldWeight_${goldItemCount}" placeholder="مثال: ۱.۵">
                        </div>
                        <div class="input-group">
                            <label for="goldModel_${goldItemCount}">مدل طلا:</label>
                            <select id="goldModel_${goldItemCount}">
                                <option value="سرویس">سرویس</option>
                                <option value="النگو">النگو</option>
                                <option value="نیم‌ست">نیم‌ست</option>
                                <option value="دستبند">دستبند</option>
                                <option value="زنجیر">زنجیر</option>
                                <option value="گردنبند">گردنبند</option>
                                <option value="گوشواره">گوشواره</option>
                                <option value="مدال">مدال</option>
                                <option value="پلاک">پلاک</option>
                                <option value="خلخال">خلخال</option>
                                <option value="آویز ساعت">آویز ساعت</option>
                                <option value="رو لباسی">رو لباسی</option>
                                <option value="سفارشی">سفارشی</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="goldWage_${goldItemCount}">اجرت:</label>
                            <div class="flex-row">
                                <input type="text" id="goldWage_${goldItemCount}" placeholder="اختیاری - مثال: ۵.۵ یا ۲۰,۰۰۰">
                                <select id="goldWageType_${goldItemCount}">
                                    <option value="percent">%</option>
                                    <option value="toman">$</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                goldItemsContainer.insertAdjacentHTML('beforeend', newItemHtml);
                // Attach event listeners to new elements
                document.getElementById(`goldWeight_${goldItemCount}`).addEventListener('input', calculateOverallTotal);
                document.getElementById(`goldWage_${goldItemCount}`).addEventListener('input', calculateOverallTotal);
                document.getElementById(`goldWageType_${goldItemCount}`).addEventListener('change', calculateOverallTotal);
                document.getElementById(`goldModel_${goldItemCount}`).addEventListener('change', calculateOverallTotal);
            });

            // 3. Add Coin Item
            addCoinItemButton.addEventListener('click', () => {
                coinItemCount++;
                const newCoinHtml = `
                    <div class="coin-item" style="margin-top: 15px;">
                        <select class="coin-type" id="coinType_${coinItemCount}">
                            <option value="">انتخاب نوع سکه</option>
                            <option value="ربع ۸۶">ربع ۸۶</option>
                            <option value="نیم ۸۶">نیم ۸۶</option>
                            <option value="امامی ۸۶">امامی ۸۶</option>
                            <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                            <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                            <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                            <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                        </select>
                        <input type="text" class="coin-price" id="coinPrice_${coinItemCount}" placeholder="مبلغ (اختیاری)" inputmode="numeric">
                    </div>
                `;
                coinSelectionContainer.insertAdjacentHTML('beforeend', newCoinHtml);
                document.getElementById(`coinType_${coinItemCount}`).addEventListener('change', calculateOverallTotal);
                document.getElementById(`coinPrice_${coinItemCount}`).addEventListener('input', calculateOverallTotal);
            });

            // 4. Input listeners for calculation triggers
            document.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                if (input.id !== 'goldPrice') { // goldPrice has its own listener
                    input.addEventListener('input', calculateOverallTotal);
                    input.addEventListener('change', calculateOverallTotal);
                }
            });
            enableTaxCheckbox.addEventListener('change', calculateOverallTotal);
            sellerProfitInput.addEventListener('input', calculateOverallTotal);


            // --- Calculation Logic (Placeholder for full implementation) ---

            function calculateOverallTotal() {
                const currentGoldPrice = parseFloat(normalizeInput(goldPriceInput.value)) || 0;
                let totalGoldValue = 0;
                let totalWage = 0;
                let totalProfit = 0;
                let totalTax = 0;
                let currentItemSummaries = []; // To store summaries for the invoice

                // 1. Calculate for physical gold items
                document.querySelectorAll('.gold-item').forEach((item, index) => {
                    const weightInput = item.querySelector(`input[id^="goldWeight_"]`);
                    const wageInput = item.querySelector(`input[id^="goldWage_"]`);
                    const wageTypeSelect = item.querySelector(`select[id^="goldWageType_"]`);
                    const modelSelect = item.querySelector(`select[id^="goldModel_"]`);

                    const weight = parseFloat(normalizeInput(weightInput.value)) || 0;
                    let wage = parseFloat(normalizeInput(wageInput.value)) || 0;
                    const wageType = wageTypeSelect ? wageTypeSelect.value : '%'; // Default to percent

                    if (weight === 0 || currentGoldPrice === 0) return;

                    let itemBasePrice = weight * currentGoldPrice;
                    let calculatedWage = 0;

                    if (wageType === '%') {
                        calculatedWage = itemBasePrice * (wage / 100);
                    } else { // toman
                        calculatedWage = wage * weight; // Wage is per gram in Toman
                    }

                    const itemProfitPercentage = parseFloat(sellerProfitInput.value) || 7;
                    const itemProfit = (itemBasePrice + calculatedWage) * (itemProfitPercentage / 100);

                    const itemTotal = itemBasePrice + calculatedWage + itemProfit;

                    totalGoldValue += itemBasePrice;
                    totalWage += calculatedWage;
                    totalProfit += itemProfit;

                    // Add to current item summaries for invoice
                    currentItemSummaries.push({
                        description: `طلای ${modelSelect ? modelSelect.value : 'ناشناس'} (وزن: ${weight} گرم)`,
                        price: itemTotal
                    });
                });

                // 2. Calculate for Buy Gold/Bar/Parsian
                const buyGoldWeight = parseFloat(normalizeInput(document.getElementById('buyGoldWeight').value)) || 0;
                if (buyGoldWeight > 0 && currentGoldPrice > 0) {
                    const itemBasePrice = buyGoldWeight * currentGoldPrice;
                    const itemProfitPercentage = parseFloat(sellerProfitInput.value) || 7;
                    const itemProfit = itemBasePrice * (itemProfitPercentage / 100);
                    const itemTotal = itemBasePrice + itemProfit;
                    totalGoldValue += itemBasePrice;
                    totalProfit += itemProfit;
                    currentItemSummaries.push({
                        description: `خرید طلا (وزن: ${buyGoldWeight} گرم)`,
                        price: itemTotal
                    });
                }

                const buyBarWeight = parseFloat(normalizeInput(document.getElementById('buyBarWeight').value)) || 0;
                if (buyBarWeight > 0 && currentGoldPrice > 0) {
                    const calculatedBarPrice = (buyBarWeight * 995 / 750) * currentGoldPrice;
                    const itemProfitPercentage = parseFloat(sellerProfitInput.value) || 7;
                    const itemProfit = calculatedBarPrice * (itemProfitPercentage / 100);
                    const itemTotal = calculatedBarPrice + itemProfit;
                    totalGoldValue += calculatedBarPrice; // Add to base value for overall profit calculation
                    totalProfit += itemProfit;
                    currentItemSummaries.push({
                        description: `خرید شمش (وزن: ${buyBarWeight} گرم)`,
                        price: itemTotal
                    });
                }

                const buyParsianWeight = parseFloat(normalizeInput(document.getElementById('buyParsianWeight').value)) || 0;
                if (buyParsianWeight > 0 && currentGoldPrice > 0) {
                    const calculatedParsianPrice = buyParsianWeight * currentGoldPrice;
                    const itemProfitPercentage = parseFloat(sellerProfitInput.value) || 7;
                    const itemProfit = calculatedParsianPrice * (itemProfitPercentage / 100);
                    const itemTotal = calculatedParsianPrice + itemProfit;
                    totalGoldValue += calculatedParsianPrice; // Add to base value
                    totalProfit += itemProfit;
                    currentItemSummaries.push({
                        description: `خرید سکه پارسیان (وزن: ${buyParsianWeight} گرم)`,
                        price: itemTotal
                    });
                }

                // 3. Calculate for Coin items
                document.querySelectorAll('.coin-item').forEach((item) => {
                    const coinPriceInput = item.querySelector('.coin-price');
                    const coinTypeSelect = item.querySelector('.coin-type');
                    const coinPrice = parseFloat(normalizeInput(coinPriceInput.value)) || 0;
                    const coinType = coinTypeSelect ? coinTypeSelect.value : '';

                    if (coinPrice > 0) {
                        totalGoldValue += coinPrice; // For coins, the input price is the direct price
                        currentItemSummaries.push({
                            description: `خرید سکه ${coinType || 'نامشخص'}`,
                            price: coinPrice
                        });
                    }
                });

                // Calculate total current price before discount and final tax
                let subTotalBeforeTaxAndDiscount = 0;
                currentItemSummaries.forEach(item => {
                    subTotalBeforeTaxAndDiscount += item.price;
                });


                // 4. Calculate Tax
                if (enableTaxCheckbox.checked) {
                    totalTax = (totalWage + totalProfit) * 0.10;
                }

                // 5. Apply manual discount
                const manualDiscount = parseFloat(normalizeInput(discountAmountInput.value)) || 0;

                // 6. Apply smart discount (if any selected)
                let smartDiscount = 0;
                const selectedSmartDiscountRadio = document.querySelector('input[name="smartDiscount"]:checked');
                if (selectedSmartDiscountRadio) {
                    smartDiscount = parseFloat(selectedSmartDiscountRadio.value) || 0;
                }

                const totalDiscount = manualDiscount + smartDiscount;

                // Final Calculation
                let finalPrice = subTotalBeforeTaxAndDiscount + totalTax - totalDiscount;
                if (finalPrice < 0) finalPrice = 0; // Prevent negative total

                // Update Invoice Summary
                invoiceSummary.innerHTML = ''; // Clear previous items

                currentItemSummaries.forEach(item => {
                    const div = document.createElement('div');
                    div.innerHTML = `<span>${item.description}:</span><span>${formatNumberToFarsi(item.price.toFixed(0))} تومان</span>`;
                    invoiceSummary.appendChild(div);
                });

                // Add fixed summary lines
                const taxDiv = document.createElement('div');
                taxDiv.innerHTML = `<span>مالیات:</span><span id="totalTax">${formatNumberToFarsi(totalTax.toFixed(0))} تومان</span>`;
                invoiceSummary.appendChild(taxDiv);

                const discountDiv = document.createElement('div');
                discountDiv.innerHTML = `<span>تخفیف:</span><span id="totalDiscount">${formatNumberToFarsi(totalDiscount.toFixed(0))} تومان</span>`;
                invoiceSummary.appendChild(discountDiv);

                // Update final total
                finalTotalPriceSpan.textContent = `${formatNumberToFarsi(finalPrice.toFixed(0))} تومان`;

                // Generate Smart Discount Options based on calculated `subTotalBeforeTaxAndDiscount`
                generateSmartDiscountOptions(subTotalBeforeTaxAndDiscount);
            }

            function generateSmartDiscountOptions(currentTotal) {
                smartDiscountOptions.innerHTML = ''; // Clear previous options

                if (currentTotal <= 0) return;

                const options = [
                    Math.floor(currentTotal / 1000) * 1000,
                    Math.floor(currentTotal / 5000) * 5000,
                    Math.floor(currentTotal / 10000) * 10000,
                    Math.floor(currentTotal / 50000) * 50000
                ].filter(val => val > 0 && val < currentTotal); // Filter out zero or greater than current total

                // Ensure unique values and sort in descending order
                const uniqueOptions = [...new Set(options)].sort((a, b) => b - a);

                uniqueOptions.forEach(optionValue => {
                    const discount = currentTotal - optionValue;
                    if (discount >= 0) { // Only show options that result in a non-negative discount
                        const radioHtml = `
                            <label>
                                <input type="radio" name="smartDiscount" value="${discount}">
                                ${formatNumberToFarsi(optionValue)} (${formatNumberToFarsi(discount.toFixed(0))} تخفیف)
                            </label>
                        `;
                        smartDiscountOptions.insertAdjacentHTML('beforeend', radioHtml);
                    }
                });

                // Add event listeners to newly created radio buttons
                smartDiscountOptions.querySelectorAll('input[name="smartDiscount"]').forEach(radio => {
                    radio.addEventListener('change', calculateOverallTotal);
                });
            }

            // Initial calculation on page load (if any default values)
            calculateOverallTotal();
        });

        // Helper function for Farsi number to string conversion for display, includes commas.
        // This function would be more robust in a full implementation for different scenarios.
        function formatNumberWithCommasAndFarsi(num) {
            if (num === null || num === undefined || isNaN(num)) return '';
            let numStr = num.toFixed(0); // Ensure no decimals for display, adjust as needed
            numStr = numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return numStr.replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
        }
    </script>
</body>
</html>
