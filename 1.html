<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاسبه‌گر طلا و فاکتور</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #4A90E2;
            --light-blue: #A9D1F4;
            --dark-gray: #333;
            --medium-gray: #777;
            --light-gray: #F0F0F0;
            --white: #FFFFFF;
            --success-green: #28a745;
            --error-red: #dc3545;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-sizing: border-box;
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-blue);
            margin-bottom: 25px;
            font-weight: 700;
        }

        h2 {
            border-bottom: 2px solid var(--light-blue);
            padding-bottom: 10px;
            margin-top: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--medium-gray);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 12px 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            color: var(--dark-gray);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        .input-inline {
            display: flex;
            align-items: center;
        }

        .input-inline input {
            flex-grow: 1;
        }

        .input-inline span {
            margin-right: 10px;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }

        .price-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .price-display input {
            flex-grow: 1;
        }

        .persian-price-text {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            background-color: var(--light-gray);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            word-break: break-word;
            flex-basis: 50%;
            box-sizing: border-box;
            font-size: 1rem; /* Default size */
        }

        .persian-price-text.small-font {
            font-size: 0.8rem; /* Smaller size for longer text */
        }

        .add-item-btn {
            background-color: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .add-item-btn:hover {
            background-color: #3a7fd6;
        }

        .item-section {
            border: 1px solid var(--light-blue);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            background-color: #f9fcff;
            position: relative;
        }

        .item-section:first-of-type {
            margin-top: 0;
        }

        .remove-item-btn {
            background-color: var(--error-red);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .remove-item-btn:hover {
            background-color: #c82333;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 10px;
            width: 20px;
            height: 20px;
            accent-color: var(--primary-blue);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0;
            font-weight: normal;
        }

        .radio-group input[type="radio"] {
            margin-left: 8px;
            accent-color: var(--primary-blue);
        }

        .toggle-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .toggle-group button {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--primary-blue);
            background-color: var(--white);
            color: var(--primary-blue);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .toggle-group button.active {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        .discount-options button {
            width: 100%;
            margin-top: 10px;
            background-color: var(--light-blue);
            color: var(--dark-gray);
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.3s ease;
        }

        .discount-options button:hover {
            background-color: #92c5ed;
        }

        #finalInvoice, #customerInvoice {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-top: 30px;
            border: 2px solid var(--primary-blue);
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item strong {
            color: var(--dark-gray);
        }

        .total-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-blue);
            text-align: left;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--light-blue);
        }

        .customer-info-box {
            background-color: #e6f2ff; /* Lighter blue */
            border: 1px solid var(--light-blue);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .customer-info-box label {
            color: var(--primary-blue);
        }

        .customer-invoice-details div {
            margin-bottom: 8px;
        }
        .customer-invoice-details strong {
            display: inline-block;
            min-width: 80px;
            color: var(--medium-gray);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .price-display {
                flex-direction: column;
                align-items: stretch;
            }
            .persian-price-text {
                flex-basis: auto;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>محاسبه‌گر و فاکتور طلا</h1>

        <h2>اطلاعات پایه</h2>
        <div class="form-group price-display">
            <label for="goldPrice">قیمت هر گرم طلا (تومان):</label>
            <input type="text" id="goldPrice" placeholder="فقط 7 رقم" maxlength="7" inputmode="numeric">
            <div class="persian-price-text" id="goldPriceText"></div>
        </div>

        <div class="form-group">
            <label for="sellerProfit">سود فروشنده (درصد):</label>
            <select id="sellerProfit">
                <option value="1">1%</option>
                <option value="2">2%</option>
                <option value="3">3%</option>
                <option value="4">4%</option>
                <option value="5">5%</option>
                <option value="6">6%</option>
                <option value="7" selected>7%</option>
            </select>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="enableTax" checked>
            <label for="enableTax">محاسبه مالیات 10% (از سود و اجرت)</label>
        </div>

        <hr>

        <h2>جزئیات طلا (آیتم‌ها)</h2>
        <div id="goldItemsContainer">
            </div>
        <button type="button" class="add-item-btn" onclick="addGoldItem()">+ افزودن آیتم طلای جدید</button>

        <hr>

        <h2>خرید‌های دیگر (اختیاری)</h2>
        <div id="otherPurchasesContainer">
            </div>
        <div class="form-group">
            <label>افزودن خرید جدید:</label>
            <div class="toggle-group">
                <button type="button" id="addGoldPurchaseBtn" onclick="addOtherPurchase('gold')">خرید طلا</button>
                <button type="button" id="addShemshPurchaseBtn" onclick="addOtherPurchase('shemsh')">خرید شمش</button>
                <button type="button" id="addParsianPurchaseBtn" onclick="addOtherPurchase('parsian')">خرید پارسیان</button>
                <button type="button" id="addCoinPurchaseBtn" onclick="addOtherPurchase('coin')">خرید سکه</button>
            </div>
        </div>


        <hr>

        <h2>تخفیف</h2>
        <div class="form-group">
            <label for="manualDiscount">تخفیف دستی (تومان):</label>
            <input type="text" id="manualDiscount" value="0" inputmode="numeric" onkeyup="formatNumberInput(this); calculateTotal()">
        </div>

        <div class="form-group">
            <label>تخفیف هوشمند (برای رندسازی):</label>
            <div id="smartDiscountOptions" class="discount-options">
                </div>
        </div>


        <hr>

        <h2>فاکتور نهایی</h2>
        <div id="finalInvoice">
            <h3>جزئیات فاکتور</h3>
            <div id="finalInvoiceDetails">
                </div>
            <div class="invoice-item">
                <span>**مالیات:**</span>
                <span id="invoiceTaxAmount">0 تومان</span>
            </div>
            <div class="invoice-item">
                <span>**تخفیف:**</span>
                <span id="invoiceDiscountAmount">0 تومان</span>
            </div>
            <div class="total-price">
                <span>**قیمت نهایی:**</span>
                <span id="finalTotalPrice">0 تومان</span>
            </div>
        </div>

        <hr>

        <h2>فاکتور فروش مشتری</h2>
        <div class="customer-info-box">
            <div class="form-group">
                <label for="customerName">نام خریدار:</label>
                <input type="text" id="customerName">
            </div>
            <div class="form-group">
                <label for="customerPhone">شماره تماس (اختیاری):</label>
                <input type="text" id="customerPhone" inputmode="tel">
            </div>
        </div>

        <div id="customerInvoice">
            <h3>جزئیات فاکتور مشتری</h3>
            <div id="customerInvoiceDetails" class="customer-invoice-details">
                <div class="customer-invoice-section" id="customerGoldItems">
                    </div>
                <div class="customer-invoice-section" id="customerOtherPurchases">
                    </div>
                <div><strong>مالیات:</strong> <span id="customerInvoiceTax">0 تومان</span></div>
                <div><strong>تخفیف:</strong> <span id="customerInvoiceDiscount">0 تومان</span></div>
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-blue); margin-top: 15px;">
                    <strong>قیمت کل:</strong> <span id="customerFinalPrice">0 تومان</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        const goldPriceInput = document.getElementById('goldPrice');
        const goldPriceTextDisplay = document.getElementById('goldPriceText');
        const sellerProfitSelect = document.getElementById('sellerProfit');
        const enableTaxCheckbox = document.getElementById('enableTax');
        const goldItemsContainer = document.getElementById('goldItemsContainer');
        const otherPurchasesContainer = document.getElementById('otherPurchasesContainer');
        const manualDiscountInput = document.getElementById('manualDiscount');
        const smartDiscountOptionsDiv = document.getElementById('smartDiscountOptions');
        const finalInvoiceDetailsDiv = document.getElementById('finalInvoiceDetails');
        const invoiceTaxAmountSpan = document.getElementById('invoiceTaxAmount');
        const invoiceDiscountAmountSpan = document.getElementById('invoiceDiscountAmount');
        const finalTotalPriceSpan = document.getElementById('finalTotalPrice');
        const customerInvoiceDetailsDiv = document.getElementById('customerInvoiceDetails');
        const customerGoldItemsDiv = document.getElementById('customerGoldItems');
        const customerOtherPurchasesDiv = document.getElementById('customerOtherPurchases');
        const customerInvoiceTaxSpan = document.getElementById('customerInvoiceTax');
        const customerInvoiceDiscountSpan = document.getElementById('customerInvoiceDiscount');
        const customerFinalPriceSpan = document.getElementById('customerFinalPrice');

        let goldItemCounter = 0;
        let otherPurchaseCounter = 0;

        const goldModels = [
            "سرویس", "النگو", "نیم‌ست", "دستبند", "زنجیر", "گردنبند",
            "گوشواره", "مدال", "پلاک", "خلخال", "آویز ساعت", "رو لباسی", "سفارشی"
        ];

        const coinTypes = {
            'ربع ۸۶': 1, 'نیم ۸۶': 1, 'امامی ۸۶': 1,
            'ربع زیر ۸۶': 1, 'نیم زیر ۸۶': 1, 'امامی زیر ۸۶': 1,
            'یک گرمی بانکی': 1
        };

        // Utility functions
        function toPersianNumber(num) {
            const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return String(num).split('').map(digit => persian[parseInt(digit)] || digit).join('');
        }

        function toEnglishNumber(num) {
            const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            let englishNum = String(num);
            for (let i = 0; i < persian.length; i++) {
                englishNum = englishNum.replace(new RegExp(persian[i], 'g'), i);
            }
            return englishNum;
        }

        function formatNumberWithCommas(number) {
            return new Intl.NumberFormat('fa-IR').format(number);
        }

        function formatNumberInput(input) {
            let value = input.value.replace(/,/g, ''); // Remove existing commas
            if (value === '') {
                input.value = '';
                return;
            }
            value = toEnglishNumber(value); // Convert Persian to English for calculation
            input.value = formatNumberWithCommas(value);
        }

        // Convert number to Persian text (up to billions for simplicity, can be extended)
        function numberToPersianWords(num) {
            if (num === 0) return 'صفر';
            num = Math.floor(num); // Ensure integer

            const units = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
            const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
            const tens = ["", "", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
            const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
            const thousands = ["", "هزار", "میلیون", "میلیارد", "تریلیون"];

            function convertLessThanThousand(n) {
                let s = "";
                if (n >= 100) {
                    s += hundreds[Math.floor(n / 100)];
                    n %= 100;
                    if (n > 0) s += " و ";
                }
                if (n >= 20) {
                    s += tens[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) s += " و ";
                }
                if (n >= 10) {
                    s += teens[n - 10];
                } else if (n > 0) {
                    s += units[n];
                }
                return s;
            }

            let result = "";
            let i = 0;
            while (num > 0) {
                const chunk = num % 1000;
                if (chunk > 0) {
                    const chunkWords = convertLessThanThousand(chunk);
                    result = chunkWords + (thousands[i] ? " " + thousands[i] : "") + (result ? " و " + result : "");
                }
                num = Math.floor(num / 1000);
                i++;
            }
            return result.trim();
        }

        // Gold Price Input Handling
        goldPriceInput.addEventListener('input', function() {
            let value = this.value.replace(/,/g, ''); // Remove commas for processing
            if (value.length > 7) {
                value = value.substring(0, 7);
            }
            this.value = formatNumberWithCommas(toEnglishNumber(value)); // Format with commas and convert to Persian numbers

            const numericValue = parseFloat(toEnglishNumber(value.replace(/,/g, '')) || 0);
            const persianText = numberToPersianWords(numericValue) + ' تومان';
            goldPriceTextDisplay.textContent = persianText;

            // Adjust font size if text is too long
            if (goldPriceTextDisplay.scrollWidth > goldPriceTextDisplay.clientWidth) {
                goldPriceTextDisplay.classList.add('small-font');
            } else {
                goldPriceTextDisplay.classList.remove('small-font');
            }
            calculateTotal();
        });

        // Add Gold Item
        function addGoldItem() {
            goldItemCounter++;
            const newItemHtml = `
                <div class="item-section" id="goldItem_${goldItemCounter}">
                    <button type="button" class="remove-item-btn" onclick="removeGoldItem('goldItem_${goldItemCounter}')">X</button>
                    <h3>آیتم طلای ${toPersianNumber(goldItemCounter)}</h3>
                    <div class="form-group">
                        <label for="goldModel_${goldItemCounter}">مدل طلا:</label>
                        <select id="goldModel_${goldItemCounter}" onchange="calculateTotal()">
                            ${goldModels.map(model => `<option value="${model}">${model}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="goldWeight_${goldItemCounter}">وزن طلا (گرم):</label>
                        <input type="text" id="goldWeight_${goldItemCounter}" placeholder="مثال: 12.5" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label for="wage_${goldItemCounter}">اجرت (درصد % یا تومان $):</label>
                        <div class="input-inline">
                            <input type="text" id="wage_${goldItemCounter}" value="0" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            <div class="toggle-group">
                                <button type="button" class="wage-type-btn active" data-type="percent" onclick="toggleWageType(this, 'wage_${goldItemCounter}')">%</button>
                                <button type="button" class="wage-type-btn" data-type="toman" onclick="toggleWageType(this, 'wage_${goldItemCounter}')">$</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            goldItemsContainer.insertAdjacentHTML('beforeend', newItemHtml);
            calculateTotal();
        }

        function removeGoldItem(id) {
            document.getElementById(id).remove();
            calculateTotal();
        }

        function toggleWageType(button, inputId) {
            const parent = button.closest('.toggle-group');
            parent.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            calculateTotal(); // Recalculate if wage type changes
        }

        // Add Other Purchase Item
        function addOtherPurchase(type) {
            otherPurchaseCounter++;
            let newItemHtml = '';
            const commonHtml = `
                <button type="button" class="remove-item-btn" onclick="removeOtherPurchase('otherPurchase_${otherPurchaseCounter}')">X</button>
            `;

            switch (type) {
                case 'gold':
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_${otherPurchaseCounter}">
                            ${commonHtml}
                            <h3>خرید طلا (اضافی) ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="otherGoldWeight_${otherPurchaseCounter}">وزن طلا (گرم):</label>
                                <input type="text" id="otherGoldWeight_${otherPurchaseCounter}" placeholder="مثال: 5.2" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
                case 'shemsh':
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_${otherPurchaseCounter}">
                            ${commonHtml}
                            <h3>خرید شمش ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="shemshWeight_${otherPurchaseCounter}">وزن شمش (گرم):</label>
                                <input type="text" id="shemshWeight_${otherPurchaseCounter}" placeholder="مثال: 100" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
                case 'parsian':
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_${otherPurchaseCounter}">
                            ${commonHtml}
                            <h3>خرید سکه پارسیان ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="parsianWeight_${otherPurchaseCounter}">وزن سکه پارسیان (گرم):</label>
                                <input type="text" id="parsianWeight_${otherPurchaseCounter}" placeholder="مثال: 1" inputmode="decimal" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
                case 'coin':
                    const coinOptions = Object.keys(coinTypes).map(coin => `<option value="${coin}">${coin}</option>`).join('');
                    newItemHtml = `
                        <div class="item-section" id="otherPurchase_${otherPurchaseCounter}">
                            ${commonHtml}
                            <h3>خرید سکه ${toPersianNumber(otherPurchaseCounter)}</h3>
                            <div class="form-group">
                                <label for="coinType_${otherPurchaseCounter}">مدل سکه:</label>
                                <select id="coinType_${otherPurchaseCounter}" onchange="calculateTotal()">
                                    ${coinOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="coinCount_${otherPurchaseCounter}">تعداد سکه:</label>
                                <input type="number" id="coinCount_${otherPurchaseCounter}" value="1" min="1" oninput="calculateTotal()">
                            </div>
                            <div class="form-group">
                                <label for="coinPrice_${otherPurchaseCounter}">مبلغ سکه (تومان):</label>
                                <input type="text" id="coinPrice_${otherPurchaseCounter}" value="0" inputmode="numeric" onkeyup="formatNumberInput(this); calculateTotal()">
                            </div>
                        </div>
                    `;
                    break;
            }
            otherPurchasesContainer.insertAdjacentHTML('beforeend', newItemHtml);
            calculateTotal();
        }

        function removeOtherPurchase(id) {
            document.getElementById(id).remove();
            calculateTotal();
        }

        // Main Calculation Logic
        function calculateTotal() {
            const currentGoldPricePerGram = parseFloat(toEnglishNumber(goldPriceInput.value.replace(/,/g, '')) || 0);
            const sellerProfitPercentage = parseFloat(sellerProfitSelect.value || 7);
            const enableTax = enableTaxCheckbox.checked;
            let totalOverallPrice = 0;
            let totalOverallTaxableAmount = 0; // Sum of profit and wage for tax calculation

            // Clear previous invoice details
            finalInvoiceDetailsDiv.innerHTML = '';
            customerGoldItemsDiv.innerHTML = '';
            customerOtherPurchasesDiv.innerHTML = '';

            // Calculate Gold Items
            document.querySelectorAll('#goldItemsContainer .item-section').forEach((itemDiv, index) => {
                const itemIndex = index + 1; // For display purposes
                const itemId = itemDiv.id.split('_')[1];

                const modelInput = document.getElementById(`goldModel_${itemId}`);
                const weightInput = document.getElementById(`goldWeight_${itemId}`);
                const wageInput = document.getElementById(`wage_${itemId}`);
                const wageTypeButton = itemDiv.querySelector('.wage-type-btn.active');

                const model = modelInput ? modelInput.value : 'نامشخص';
                const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')) || 0);
                let wageValue = parseFloat(toEnglishNumber(wageInput.value.replace(/,/g, '')) || 0);
                const wageType = wageTypeButton ? wageTypeButton.dataset.type : 'percent';

                let itemBasePrice = weight * currentGoldPricePerGram;
                let itemProfit = itemBasePrice * (sellerProfitPercentage / 100);
                let itemWageToman = 0;

                if (wageType === 'percent') {
                    itemWageToman = itemBasePrice * (wageValue / 100);
                } else { // toman
                    itemWageToman = wageValue;
                }

                const itemPriceBeforeTax = itemBasePrice + itemProfit + itemWageToman;
                totalOverallPrice += itemPriceBeforeTax;
                totalOverallTaxableAmount += itemProfit + itemWageToman;

                // Add to final invoice
                finalInvoiceDetailsDiv.insertAdjacentHTML('beforeend', `
                    <div class="invoice-item">
                        <span>طلا (${model}, ${toPersianNumber(weight)} گرم):</span>
                        <span>${formatNumberWithCommas(itemPriceBeforeTax)} تومان</span>
                    </div>
                `);

                // Add to customer invoice
                customerGoldItemsDiv.insertAdjacentHTML('beforeend', `
                    <div>
                        <strong>طلا خریداری شده:</strong>
                        <p style="margin: 5px 0 0 0; padding-right: 20px;">
                            <strong>مدل طلا:</strong> ${model}<br>
                            <strong>وزن:</strong> ${toPersianNumber(weight)} گرم<br>
                            <strong>قیمت:</strong> ${formatNumberWithCommas(itemPriceBeforeTax)} تومان<br>
                            ${itemWageToman > 0 ? `<strong>اجرت:</strong> ${formatNumberWithCommas(itemWageToman)} تومان<br>` : ''}
                        </p>
                    </div>
                `);
            });

            // Calculate Other Purchase Items
            document.querySelectorAll('#otherPurchasesContainer .item-section').forEach((itemDiv, index) => {
                const itemId = itemDiv.id.split('_')[1];
                let itemTotalCost = 0;
                let itemDescription = '';

                if (itemDiv.id.startsWith('otherPurchase_')) {
                    if (itemDiv.querySelector('[id^="otherGoldWeight_"]')) { // Additional Gold
                        const weightInput = document.getElementById(`otherGoldWeight_${itemId}`);
                        const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')) || 0);
                        itemTotalCost = weight * currentGoldPricePerGram;
                        const itemProfit = itemTotalCost * (sellerProfitPercentage / 100);
                        itemTotalCost += itemProfit; // Apply profit to additional gold
                        totalOverallTaxableAmount += itemProfit;
                        itemDescription = `طلا اضافی (${toPersianNumber(weight)} گرم)`;
                    } else if (itemDiv.querySelector('[id^="shemshWeight_"]')) { // Shemsh
                        const weightInput = document.getElementById(`shemshWeight_${itemId}`);
                        const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')) || 0);
                        // وزن رو ضربدر ۹۹۵ کن و تقسیم بر ۷۵۰ کن و عدد رو ضربدر قیمت طلا بالای صفحه کن
                        itemTotalCost = (weight * 995 / 750) * currentGoldPricePerGram;
                        itemDescription = `شمش (${toPersianNumber(weight)} گرم)`;
                    } else if (itemDiv.querySelector('[id^="parsianWeight_"]')) { // Parsian Coin
                        const weightInput = document.getElementById(`parsianWeight_${itemId}`);
                        const weight = parseFloat(toEnglishNumber(weightInput.value.replace(/,/g, '')) || 0);
                        itemTotalCost = weight * currentGoldPricePerGram;
                        itemDescription = `سکه پارسیان (${toPersianNumber(weight)} گرم)`;
                    } else if (itemDiv.querySelector('[id^="coinType_"]')) { // Coin
                        const coinTypeSelect = document.getElementById(`coinType_${itemId}`);
                        const coinCountInput = document.getElementById(`coinCount_${itemId}`);
                        const coinPriceInput = document.getElementById(`coinPrice_${itemId}`);

                        const coinType = coinTypeSelect.value;
                        const coinCount = parseInt(coinCountInput.value) || 1;
                        const coinPrice = parseFloat(toEnglishNumber(coinPriceInput.value.replace(/,/g, '')) || 0);

                        itemTotalCost = coinCount * coinPrice;
                        itemDescription = `سکه (${coinType}, ${toPersianNumber(coinCount)} عدد)`;
                    }
                }
                totalOverallPrice += itemTotalCost;

                // Add to final invoice
                finalInvoiceDetailsDiv.insertAdjacentHTML('beforeend', `
                    <div class="invoice-item">
                        <span>${itemDescription}:</span>
                        <span>${formatNumberWithCommas(itemTotalCost)} تومان</span>
                    </div>
                `);

                // Add to customer invoice
                customerOtherPurchasesDiv.insertAdjacentHTML('beforeend', `
                    <div>
                        <strong>خرید ${itemDescription.split(' ')[0]}:</strong>
                        <p style="margin: 5px 0 0 0; padding-right: 20px;">
                            ${itemDescription.includes('سکه') ? `<strong>مدل:</strong> ${itemDescription.split('(')[1].split(',')[0]}<br>` : ''}
                            ${itemDescription.includes('گرم') ? `<strong>وزن:</strong> ${itemDescription.split('(')[1].split(',')[0]}<br>` : ''}
                            ${itemDescription.includes('عدد') ? `<strong>تعداد:</strong> ${itemDescription.split(',')[1].replace(')', '')}<br>` : ''}
                            <strong>قیمت:</strong> ${formatNumberWithCommas(itemTotalCost)} تومان<br>
                        </p>
                    </div>
                `);
            });


            let totalTaxAmount = 0;
            if (enableTax) {
                totalTaxAmount = totalOverallTaxableAmount * 0.10;
            }

            let manualDiscount = parseFloat(toEnglishNumber(manualDiscountInput.value.replace(/,/g, '')) || 0);

            // Update smart discount options
            updateSmartDiscountOptions(totalOverallPrice + totalTaxAmount - manualDiscount);

            let finalCalculatedPrice = totalOverallPrice + totalTaxAmount - manualDiscount;


            // Update Final Invoice
            invoiceTaxAmountSpan.textContent = `${formatNumberWithCommas(totalTaxAmount)} تومان`;
            invoiceDiscountAmountSpan.textContent = `${formatNumberWithCommas(manualDiscount)} تومان`;
            finalTotalPriceSpan.textContent = `${formatNumberWithCommas(finalCalculatedPrice)} تومان`;

            // Update Customer Invoice
            document.getElementById('customerName').addEventListener('input', updateCustomerInvoice);
            document.getElementById('customerPhone').addEventListener('input', updateCustomerInvoice);
            updateCustomerInvoice(); // Initial update


            customerInvoiceTaxSpan.textContent = `${formatNumberWithCommas(totalTaxAmount)} تومان`;
            customerInvoiceDiscountSpan.textContent = `${formatNumberWithCommas(manualDiscount)} تومان`;
            customerFinalPriceSpan.textContent = `${formatNumberWithCommas(finalCalculatedPrice)} تومان`;
        }

        function updateCustomerInvoice() {
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;

            // Update customer invoice header if needed, or ensure dynamic elements are in place
            let customerInfoHtml = `
                <div><strong>نام خریدار:</strong> ${customerName || '---'}</div>
                <div><strong>شماره تماس:</strong> ${customerPhone || '---'}</div>
            `;
            // This is just an example, the structure for customer invoice details is already set up in calculateTotal
            // We're mostly linking the tax, discount and final price, and the dynamically added items
        }

        function updateSmartDiscountOptions(currentTotal) {
            smartDiscountOptionsDiv.innerHTML = '';
            const options = [];

            // Example rounding logic, adjust as needed
            // Round to nearest 1000 (e.g., 17893000 -> 17890000)
            options.push(Math.floor(currentTotal / 1000) * 1000);
            // Round to nearest 50000 (e.g., 17893000 -> 17850000)
            options.push(Math.floor(currentTotal / 50000) * 50000);
            // Round to nearest 100000 (e.g., 17893000 -> 17800000)
            options.push(Math.floor(currentTotal / 100000) * 100000);
            // Round to nearest 500000 (e.g., 17893000 -> 17500000)
            options.push(Math.floor(currentTotal / 500000) * 500000);

            // Filter unique and valid options, sort descending
            const uniqueOptions = [...new Set(options)].filter(opt => opt >= 0 && opt <= currentTotal).sort((a, b) => b - a);

            uniqueOptions.forEach(option => {
                const discountAmount = currentTotal - option;
                if (discountAmount >= 0) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = `رند به ${formatNumberWithCommas(option)} (تخفیف ${formatNumberWithCommas(discountAmount)} تومان)`;
                    button.onclick = () => {
                        manualDiscountInput.value = formatNumberWithCommas(discountAmount);
                        calculateTotal();
                    };
                    smartDiscountOptionsDiv.appendChild(button);
                }
            });
            if (uniqueOptions.length === 0 && currentTotal > 0) {
                 const button = document.createElement('button');
                 button.type = 'button';
                 button.textContent = `تخفیف هوشمند در دسترس نیست`;
                 button.disabled = true;
                 smartDiscountOptionsDiv.appendChild(button);
            }
        }


        // Event Listeners
        goldPriceInput.addEventListener('change', calculateTotal);
        sellerProfitSelect.addEventListener('change', calculateTotal);
        enableTaxCheckbox.addEventListener('change', calculateTotal);
        manualDiscountInput.addEventListener('change', calculateTotal);

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            addGoldItem(); // Add an initial gold item
            calculateTotal(); // Perform initial calculation
        });

        // Ensure recalculation on any relevant input change
        document.addEventListener('input', (event) => {
            const id = event.target.id;
            if (id.startsWith('goldModel_') || id.startsWith('goldWeight_') || id.startsWith('wage_') ||
                id.startsWith('otherGoldWeight_') || id.startsWith('shemshWeight_') || id.startsWith('parsianWeight_') ||
                id.startsWith('coinType_') || id.startsWith('coinCount_') || id.startsWith('coinPrice_')) {
                calculateTotal();
            }
        });
        document.addEventListener('change', (event) => {
            const id = event.target.id;
             if (id.startsWith('goldModel_') || id.startsWith('coinType_')) {
                calculateTotal();
            }
        });

    </script>
</body>
</html>
