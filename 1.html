<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاکتور طلا</title>
    <style>
        /* Import Vazirmatn font */
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        /* Base styles */
        body {
            font-family: 'Vazirmatn', sans-serif; /* Consistent Vazirmatn font */
            background-color: #f8f9fa; /* Lighter background for modern feel */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            box-sizing: border-box;
            color: #343a40; /* Darker text for better readability */
        }

        .container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); /* Softer, deeper shadow */
            width: 100%;
            max-width: 550px; /* Slightly wider container for better spacing */
            box-sizing: border-box;
            border: 1px solid #e9ecef; /* Subtle border */
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em; /* Slightly larger heading */
            position: relative;
            font-weight: 700; /* Bolder for emphasis */
        }

        h1::after {
            content: '';
            width: 70px; /* Wider underline */
            height: 4px; /* Thicker underline */
            background-color: #007bff; /* Primary blue for accent */
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600; /* Semi-bold labels */
            color: #495057;
            font-size: 0.98em;
        }

        /* Input and Select field general styles */
        input:not([type="radio"]):not([type="checkbox"]),
        select {
            width: 100%;
            padding: 12px 18px; /* More padding for larger touch area */
            border: 1px solid #ced4da; /* Subtle border */
            border-radius: 10px; /* More rounded corners */
            box-sizing: border-box;
            font-size: 1.05em; /* Slightly larger font */
            color: #343a40;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fdfdfd;
            font-family: 'Vazirmatn', sans-serif; /* Ensure Vazirmatn for all inputs/selects */
            text-align: right; /* Default to right align for number inputs */
        }

        input[type="text"],
        input[type="tel"],
        input[inputmode="decimal"] {
            direction: rtl; /* Ensure RTL for numeric inputs */
        }

        input:focus,
        select:focus {
            border-color: #007bff; /* Blue focus border */
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25); /* Glow effect on focus */
            outline: none;
        }

        /* Specific styles for smaller input in buy sections */
        .buy-option-input {
            width: 100%;
            padding: 10px 14px; /* Slightly smaller padding */
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 0.95em;
            color: #343a40;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fdfdfd;
            font-family: 'Vazirmatn', sans-serif;
            text-align: right;
            direction: rtl; /* Ensure RTL for buy inputs */
        }

        .coin-model-select,
        .coin-price-input {
            font-size: 0.9em;
            padding: 9px 12px;
        }

        .input-inline-wrapper {
            position: relative;
            width: 100%;
        }

        .input-inline-display {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em;
            color: #888;
            pointer-events: none;
            direction: rtl;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 70px);
            z-index: 2;
            transition: font-size 0.2s ease-out;
            font-family: 'Vazirmatn', sans-serif; /* Ensure Vazirmatn for inline display */
        }

        input#goldPrice,
        .gold-wage {
            padding-left: 70px;
        }

        .add-item-button {
            background-color: #28a745; /* Green for add primary button */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            width: auto;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: block;
            margin: 30px auto 0 auto;
            font-family: 'Vazirmatn', sans-serif;
        }

        .add-item-button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .item-row {
            border: 1px solid #e0e0e0; /* Solid, lighter border */
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            background-color: #fefefe;
            position: relative;
            animation: fadeIn 0.5s ease-out;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .item-row .remove-item {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #f8d7da; /* Light red background */
            border: none;
            color: #dc3545; /* Darker red icon */
            font-size: 1.1em;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }

        .item-row .remove-item:hover {
            background-color: #dc3545;
            color: white;
        }

        .item-row .form-group {
            margin-bottom: 18px; /* Slightly more space */
        }

        .flex-group {
            display: flex;
            gap: 20px; /* Increased gap */
        }

        .flex-group > div {
            flex: 1;
        }

        .currency-toggle {
            display: flex;
            align-items: center;
            gap: 15px; /* Increased gap */
            margin-bottom: 15px;
            font-family: 'Vazirmatn', sans-serif; /* Consistent font */
        }

        .currency-toggle label {
            margin-bottom: 0;
            font-weight: normal;
            color: #343a40;
            cursor: pointer;
        }

        .currency-toggle input[type="radio"] {
            width: auto;
            margin-left: 8px;
            accent-color: #007bff; /* Primary blue for radio buttons */
            transform: scale(1.1); /* Slightly larger radio buttons */
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px 30px; /* More generous spacing */
            align-items: center;
            margin-bottom: 25px;
            justify-content: space-between;
            padding: 10px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            font-family: 'Vazirmatn', sans-serif; /* Consistent font */
        }

        .checkbox-group > div {
            display: flex;
            align-items: center;
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            color: #444;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px; /* Larger checkboxes */
            height: 20px;
            margin-left: 10px;
            accent-color: #007bff;
            transform: scale(1.1);
        }

        .result-section {
            background-color: #e9f0f7; /* Lighter blue-grey background */
            padding: 22px;
            border-radius: 10px;
            margin-top: 35px;
            border-left: 6px solid #007bff; /* Primary blue accent */
            font-family: 'Vazirmatn', sans-serif;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.08); /* Subtle blue shadow */
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #cce5ff; /* Lighter dashed border */
            font-size: 1.15em;
            font-family: 'Vazirmatn', sans-serif;
        }

        .result-item:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.25em;
            margin-top: 18px;
        }
        .result-item.total-tax {
            color: #fd7e14; /* Orange */
        }
        .result-item.final-total {
            color: #28a745; /* Green */
        }
        .result-item.buy-gold-amount,
        .result-item.buy-diff-gold-amount {
            color: #dc3545; /* Red */
            font-size: 1.05em;
        }
        .result-item.buy-item span:first-child {
            color: #dc3545; /* Red for distinction */
            font-weight: bold;
        }
        .result-item.buy-item span:last-child {
            color: #dc3545; /* Red for distinction */
        }
        .result-item.discount-amount {
            color: #dc3545; /* Red */
            font-size: 1.05em;
        }
        .result-item.customer-payout {
            color: #dc3545; /* Red for payout */
            font-weight: bold;
        }

        .result-item span:first-child {
            color: #495057;
        }

        .result-item span:last-child {
            color: #007bff;
            direction: ltr; /* Ensure numbers are LTR */
            font-weight: 500;
        }
        .result-item.buy-gold-amount span:last-child,
        .result-item.buy-diff-gold-amount span:last-child {
            color: #dc3545;
        }
        .result-item.final-total span:last-child {
            color: #28a745;
        }
        .result-item.discount-amount span:last-child {
            color: #dc3545;
        }

        select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20256%22%3E%3Cpath%20fill%3D%22%23495057%22%20d%3D%22M205.66%2099.66L128%20177.34%2050.34%2099.66z%22%2F%3E%3C%2Fsvg%3E'); /* Darker arrow */
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 14px; /* Slightly larger arrow */
            padding-left: 45px; /* More space for arrow */
        }

        .suggested-discounts-section {
            background-color: #e6f7ea; /* Lighter green */
            border: 1px solid #d4edda;
            border-left: 6px solid #28a745; /* Green accent */
            padding: 18px;
            margin-top: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
        }

        .suggested-discount-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px dashed #c8e6c9; /* Light green dashed border */
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 6px;
        }
        .suggested-discount-item:last-child {
            border-bottom: none;
        }
        .suggested-discount-item:hover {
            background-color: #d8f1dc;
        }

        .suggested-discount-item.active {
            background-color: #c3e6cb;
            border: 1px solid #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.3);
        }

        .suggested-discount-text {
            font-size: 1em;
            color: #155724; /* Darker green text */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            font-family: 'Vazirmatn', sans-serif;
        }
        .suggested-discount-text .amount {
            font-weight: bold;
            color: #218838;
        }
        .suggested-discount-text .final-price {
            font-size: 0.88em;
            color: #6a767d;
            margin-top: 4px;
            direction: rtl;
        }
        .suggested-discount-text .final-price span {
            direction: ltr;
        }

        /* Invoice Output Section */
        .invoice-output-wrapper {
            background-color: #eaf6f6; /* Light teal background */
            padding: 20px;
            border-radius: 10px;
            margin-top: 35px;
            border-left: 6px solid #17a2b8; /* Teal accent */
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(23, 162, 184, 0.1);
        }

        .invoice-output-header {
            text-align: right;
            color: #2c3e50;
            font-size: 1.6em; /* Larger header */
            margin: 0 0 15px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #cce5ff; /* Light blue border */
            transition: all 0.3s ease;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 600;
        }

        .invoice-output-header:hover {
            color: #138496; /* Darker teal on hover */
        }

        .invoice-output-header .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .invoice-output-header.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .invoice-output-content {
            max-height: 0;
            transition: max-height 0.6s ease-out, padding 0.6s ease-out; /* Slower transition */
            padding: 0 10px;
            box-sizing: border-box;
        }

        .invoice-output-content.expanded {
            max-height: 1200px; /* Large enough */
            padding: 15px 10px;
        }

        .invoice-output-content .form-group {
            margin-bottom: 18px;
        }

        .generated-invoice-display {
            border: 1px dashed #a0d9b4;
            background-color: #f6fdf6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            font-family: 'Vazirmatn', sans-serif;
            color: #343a40;
            line-height: 1.8;
            direction: rtl;
        }

        .generated-invoice-display p {
            margin: 6px 0;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .generated-invoice-display strong {
            color: #28a745; /* Green for emphasis */
            font-weight: 700;
        }
        
        .generated-invoice-display .invoice-item-group {
            border-bottom: 1px dotted #e0e0e0;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        .generated-invoice-display .invoice-item-group:last-of-type {
            border-bottom: none;
        }

        .generated-invoice-display .invoice-section-divider {
            border-top: 1px solid #c0c0c0;
            margin: 20px 0;
            padding-top: 12px;
            font-weight: 600;
            color: #555;
            font-size: 1.05em;
        }

        .generated-invoice-display .total-price-line {
            font-size: 1.15em;
            font-weight: bold;
            color: #28a745;
            margin-top: 20px;
            border-top: 2px solid #28a745;
            padding-top: 12px;
        }
        .generated-invoice-display .discount-value {
            color: #dc3545;
            font-weight: bold;
        }
        .generated-invoice-display .total-final-value {
            color: #007bff;
            font-weight: bold;
        }
        .generated-invoice-display .buy-item-value {
            color: #dc3545;
            font-weight: bold;
        }
        .generated-invoice-display .buy-item-value span {
            direction: ltr;
            font-size: 0.9em;
        }


        .generate-invoice-button,
        .print-invoice-button {
            background-color: #007bff; /* Primary blue */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            width: auto;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: block;
            margin: 20px auto 0 auto;
            font-family: 'Vazirmatn', sans-serif;
        }

        .generate-invoice-button:hover,
        .print-invoice-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        /* Buy Sections */
        .buy-section-container {
            margin-top: 30px;
            border-radius: 10px;
            overflow: hidden; /* Ensures rounded corners apply to content */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Unified shadow for sections */
            border: 1px solid #e0e0e0; /* Subtle border */
        }

        .buy-section-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #34495e;
            padding: 15px 20px;
            background-color: #f0f4f7; /* Lighter background */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #d8e4f0;
            transition: background-color 0.3s ease;
            font-family: 'Vazirmatn', sans-serif;
        }

        .buy-section-header:hover {
            background-color: #e2e8ee;
        }

        .buy-section-header .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .buy-section-header.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .buy-section-content {
            max-height: 0;
            transition: max-height 0.6s ease-out, padding 0.6s ease-out;
            overflow: hidden;
            padding: 0 20px; /* Horizontal padding for content */
            box-sizing: border-box;
            background-color: #fbfdff; /* Very light background for content */
        }
        .buy-section-content.expanded {
            max-height: 1200px;
            padding-bottom: 20px; /* Bottom padding when expanded */
        }
        
        .buy-option-group {
            margin-top: 15px; /* Margin at top of each group */
            padding: 15px 20px;
            border: 1px solid #e9ecef; /* Subtle border for groups */
            border-left: 5px solid #6c757d; /* Muted gray accent */
            background-color: #ffffff;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .buy-option-group:first-child {
            margin-top: 0; /* No top margin for first group inside content */
        }
        .buy-option-group:last-child {
            margin-bottom: 0;
        }

        .buy-option-group.single-item .remove-buy-item {
            display: none !important;
        }

        .buy-option-group .remove-buy-item {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #f8d7da;
            border: none;
            color: #dc3545;
            font-size: 1.1em;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }
        .buy-option-group .remove-buy-item:hover {
            background-color: #dc3545;
            color: white;
        }

        .coin-item-group {
            margin-top: 15px;
            padding: 15px 20px;
            border: 1px solid #e9ecef;
            border-left: 5px solid #6c757d;
            background-color: #ffffff;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .coin-item-group:first-child {
            margin-top: 0;
        }
        .coin-item-group:last-child {
            margin-bottom: 0;
        }

        .coin-item-group .remove-buy-item {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #f8d7da;
            border: none;
            color: #dc3545;
            font-size: 1.1em;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }
        .coin-item-group .remove-buy-item:hover {
            background-color: #dc3545;
            color: white;
        }

        .coin-sub-item {
            display: flex;
            align-items: center;
            gap: 12px; /* Consistent gap */
            margin-bottom: 12px; /* Spacing between coin rows */
            padding: 0;
            border-radius: 5px;
        }
        .coin-sub-item:last-of-type {
            margin-bottom: 0;
        }
        .coin-sub-item .coin-remove-button {
            background: #f8d7da;
            border: none;
            color: #dc3545;
            font-size: 1em;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .coin-sub-item .coin-remove-button:hover {
            background-color: #dc3545;
            color: white;
        }

        .add-item-icon-button {
            background-color: #007bff;
            color: white;
            width: 35px; /* Larger circular button */
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6em; /* Larger plus sign */
            line-height: 1;
            padding: 0;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            float: left;
            margin-left: 15px; /* More space */
            margin-top: -5px; /* Adjusted to align */
            box-shadow: 0 3px 8px rgba(0,0,0,0.15); /* More prominent shadow */
        }
        .add-item-icon-button:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }
        .add-item-icon-button::before {
            content: '+';
        }

        .add-coin-button {
            background-color: #28a745;
            color: white;
            padding: 8px 15px; /* More padding */
            border: none;
            border-radius: 6px; /* Slightly more rounded */
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 15px; /* More margin */
            transition: background-color 0.3s ease;
            display: block;
            margin-left: auto;
            margin-right: auto;
            font-family: 'Vazirmatn', sans-serif;
        }
        .add-coin-button:hover {
            background-color: #218838;
        }
        
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }

        /* Print specific styles */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
                display: block;
                min-height: auto;
                font-size: 12pt;
            }
            .container {
                box-shadow: none;
                max-width: none;
                width: 100%;
                border-radius: 0;
                padding: 0;
            }
            #invoiceContainer > *:not(#invoiceOutputWrapper):not(#itemContainer),
            .add-item-button,
            .checkbox-group,
            .form-group:has(#profitRate),
            .form-group:has(#discount),
            .suggested-discounts-section,
            .result-section {
                display: none !important;
            }
            #itemContainer {
                display: block !important;
                margin-top: 0 !important;
            }
            #itemContainer .item-row {
                display: block !important;
                border: none !important;
                padding: 0 !important;
                margin-top: 0 !important;
                background-color: transparent !important;
                box-shadow: none !important;
            }
            #itemContainer .item-row .remove-item,
            #itemContainer .item-row .flex-group > div.form-group:last-child,
            #itemContainer .item-row .form-group:has(.currency-toggle) {
                display: none !important;
            }
            #itemContainer .item-row .form-group {
                margin-bottom: 5px !important;
            }
            #itemContainer label {
                font-weight: bold !important;
                margin-bottom: 3px !important;
                display: inline-block !important;
            }
            #itemContainer input, #itemContainer select {
                border: none !important;
                padding: 0 !important;
                width: auto !important;
                display: inline-block !important;
                background-color: transparent !important;
                font-size: 1em !important;
                color: #000 !important;
            }
            #itemContainer .input-inline-wrapper {
                display: inline !important;
            }
            #itemContainer .input-inline-display {
                display: none !important;
            }
            
            .invoice-output-wrapper {
                border: none;
                margin-top: 0;
                padding: 0;
                background-color: #fff;
                box-shadow: none;
            }
            .invoice-output-header,
            .invoice-output-content .form-group,
            .generate-invoice-button,
            .print-invoice-button {
                display: none !important;
            }
            .invoice-output-content.expanded {
                max-height: fit-content;
                padding: 0;
            }
            .generated-invoice-display {
                border: none;
                padding: 0;
                background-color: #fff;
                margin-top: 0;
            }
            ::-webkit-scrollbar {
                width: 0 !important;
                height: 0 !important;
            }
            .invoice-output-header .toggle-icon {
                display: none;
            }
            .buy-section-container {
                display: block !important;
                box-shadow: none;
                max-width: none;
                width: 100%;
                border-radius: 0;
                padding: 0;
                border: none;
                background-color: #fff;
            }
            .buy-section-container .buy-section-header {
                display: none !important;
            }
            .buy-section-content {
                max-height: fit-content !important;
                padding: 0 !important;
            }
            .buy-option-group, .coin-item-group {
                border: none;
                padding: 0;
                margin-bottom: 5px;
                background-color: #fff;
                box-shadow: none;
            }
            .buy-option-group p, .coin-item-group p {
                margin: 2px 0;
            }
            .buy-option-group .remove-buy-item,
            .add-item-icon-button, 
            .coin-item-group .remove-buy-item,
            .add-coin-button,
            .coin-sub-item .coin-remove-button,
            .buy-option-input {
                display: none !important;
            }
            .buy-option-group strong, .coin-item-group strong {
                font-weight: bold;
                color: #e74c3c;
            }
        }

        /* Mobile-specific adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 18px;
                width: 90%; /* Use 90% of mobile screen width */
            }
            h1 {
                font-size: 1.8em;
            }
            .form-group label {
                font-size: 0.92em;
            }
            input:not([type="radio"]):not([type="checkbox"]),
            select {
                padding: 10px 14px;
                font-size: 1em;
            }
            .buy-option-input {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            .coin-model-select,
            .coin-price-input {
                font-size: 0.85em;
                padding: 7px 9px;
            }

            .add-item-button {
                padding: 10px 20px;
                font-size: 1em;
            }
            .add-item-icon-button {
                width: 30px;
                height: 30px;
                font-size: 1.4em;
                margin-left: 10px;
                margin-top: -3px;
            }
            .add-coin-button {
                padding: 6px 10px;
                font-size: 0.8em;
            }

            .result-item {
                font-size: 1.05em;
            }
            .result-item:last-child {
                font-size: 1.15em;
            }
            .flex-group {
                flex-direction: column;
                gap: 15px;
            }
            .suggested-discount-item {
                flex-direction: column; /* Stack items vertically */
                align-items: flex-start;
                gap: 8px;
                padding: 8px 10px;
            }
            .suggested-discount-text {
                align-items: flex-start;
            }
            .checkbox-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .checkbox-group > div {
                width: 100%;
            }
            .invoice-output-header {
                font-size: 1.4em;
            }
            .generated-invoice-display {
                padding: 15px;
            }
            .generated-invoice-display p {
                font-size: 0.9em;
            }
            .buy-section-header {
                font-size: 1.1em;
                padding: 12px 15px;
            }
            .buy-section-content {
                padding: 0 15px;
            }
            .buy-option-group, .coin-item-group {
                padding: 12px 15px;
            }
            .buy-option-group .remove-buy-item,
            .coin-item-group .remove-buy-item {
                top: 8px;
                left: 8px;
                font-size: 1em;
                padding: 4px;
            }
            .coin-sub-item .coin-remove-button {
                font-size: 0.9em;
                padding: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="invoiceContainer">
        <h1>فاکتور طلا</h1>

        <div class="form-group">
            <label for="goldPrice">قیمت هر گرم طلا (تومان):</label>
            <div class="input-inline-wrapper">
                <input type="text" id="goldPrice" maxlength="9" required>
                <span class="input-inline-display" id="goldPriceInWords"></span>
            </div>
        </div>

        <div id="itemContainer">
            <div class="item-row" data-item-id="1">
                <button type="button" class="remove-item" onclick="removeItem(this)">✖</button>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="weight1">وزن طلا (گرم):</label>
                        <input type="text" id="weight1" class="gold-weight" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label for="productType1">نوع محصول:</label>
                        <select id="productType1" class="product-type-select">
                            <option value="">انتخاب کنید</option>
                            <option value="زنجیر">زنجیر</option>
                            <option value="دستبند">دستبند</option>
                            <option value="النگو">النگو</option>
                            <option value="سرویس">سرویس</option>
                            <option value="نیم‌ست">نیم‌ست</option>
                            <option value="گوشواره">گوشواره</option>
                            <option value="مدال">مدال</option>
                            <option value="گردنبند">گردنبند</option>
                            <option value="خلخال">خلخال</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="wage1">اجرت:</label>
                    <div class="currency-toggle">
                        <label>
                            <input type="radio" name="wageType1" value="percent" checked onchange="toggleWageInput(this)"> درصد
                        </label>
                        <label>
                            <input type="radio" name="wageType1" value="amount" onchange="toggleWageInput(this)"> تومان
                        </label>
                    </div>
                    <div class="input-inline-wrapper">
                        <input type="text" id="wage1" class="gold-wage">
                        <span class="input-inline-display" id="wageInWords1"></span>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="add-item-button" onclick="addItem()">افزودن آیتم جدید</button>

        <div class="buy-section-container" id="buyGoldSection">
            <h2 class="buy-section-header clearfix" onclick="toggleBuySection('buyGoldSection')">
                خرید طلا (از مشتری) <span class="toggle-icon">▼</span>
            </h2>
            <div class="buy-section-content">
                <div id="buyGoldItemContainer">
                    <div class="buy-option-group single-item" data-buy-item-id="gold1">
                        <button type="button" class="remove-buy-item" onclick="removeBuyItem(this)">✖</button>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="buyGoldWeight1" style="margin-bottom: 5px;">وزن طلا (گرم):</label>
                            <input type="text" id="buyGoldWeight1" class="buy-option-input gold-buy-weight" inputmode="decimal">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="buy-section-container" id="buyCoinSection">
            <h2 class="buy-section-header clearfix" onclick="toggleBuySection('buyCoinSection')">
                خرید سکه (از مشتری)
                <button type="button" class="add-item-icon-button" onclick="event.stopPropagation(); addBuyCoinItem()"></button>
                <span class="toggle-icon">▼</span>
            </h2>
            <div class="buy-section-content">
                <div id="buyCoinItemContainer">
                    <div class="coin-item-group" data-buy-item-id="coin1">
                        <button type="button" class="remove-buy-item" onclick="removeBuyItem(this)">✖</button>
                        <div id="coinSelectsCoin1">
                            <div class="coin-sub-item">
                                <select class="buy-option-input coin-model-select" onchange="updateCoinPriceInput(this, 'coin1')">
                                    <option value="">انتخاب مدل سکه</option>
                                    <option value="ربع ۸۶">ربع ۸۶</option>
                                    <option value="نیم ۸۶">نیم ۸۶</option>
                                    <option value="امامی ۸۶">امامی ۸۶</option>
                                    <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                                    <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                                    <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                                    <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                                </select>
                                <input type="text" class="buy-option-input coin-price-input" placeholder="قیمت سکه" oninput="calculateFactor()" style="flex-grow: 1;">
                                <button type="button" class="coin-remove-button" onclick="removeCoinSubItem(this)">✖</button>
                            </div>
                        </div>
                        <button type="button" class="add-coin-button" onclick="addCoinSelect('coin1')">افزودن سکه جدید</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="buy-section-container" id="buyParsianIngotSection">
            <h2 class="buy-section-header clearfix" onclick="toggleBuySection('buyParsianIngotSection')">
                خرید پارسیان و شمش (از مشتری) <span class="toggle-icon">▼</span>
            </h2>
            <div class="buy-section-content">
                <div class="buy-option-group single-item" data-buy-item-id="parsian1">
                    <button type="button" class="remove-buy-item" onclick="removeBuyItem(this)">✖</button>
                    <div class="form-group parsian-input-wrapper" style="margin-bottom: 0;">
                        <label for="buyParsianWeight1" style="margin-bottom: 5px;">وزن سکه پارسیان (گرم):</label>
                        <input type="text" id="buyParsianWeight1" class="buy-option-input parsian-buy-weight" inputmode="decimal">
                    </div>
                </div>
                <div class="buy-option-group single-item" data-buy-item-id="ingot1">
                    <button type="button" class="remove-buy-item" onclick="removeBuyItem(this)">✖</button>
                    <div class="form-group ingot-input-wrapper" style="margin-bottom: 0;">
                        <label for="buyIngotWeight1" style="margin-bottom: 5px;">وزن شمش (گرم):</label>
                        <input type="text" id="buyIngotWeight1" class="buy-option-input ingot-buy-weight" inputmode="decimal">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="profitRate">سود فروشنده:</label>
            <select id="profitRate">
                <option value="1">1%</option>
                <option value="2">2%</option>
                <option value="3">3%</option>
                <option value="4">4%</option>
                <option value="5">5%</option>
                <option value="6">6%</option>
                <option value="7" selected>7%</option>
            </select>
        </div>

        <div class="checkbox-group">
            <div>
                <label for="includeTax">
                    <input type="checkbox" id="includeTax" checked> محاسبه مالیات (10%)
                </label>
            </div>
            <div>
                <label for="buyDiffGoldWithDiscount">
                    <input type="checkbox" id="buyDiffGoldWithDiscount"> خرید ما به تفاوت طلا مشتری به مظنه (کسر 2%)
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="discount">تخفیف (تومان):</label>
            <input type="text" id="discount" class="discount-input">
        </div>

        <div id="suggestedDiscountsSection" class="suggested-discounts-section" style="display: none;">
        </div>

        <div class="result-section" id="resultSection">
        </div>

        <div class="invoice-output-wrapper" id="invoiceOutputWrapper">
            <h2 class="invoice-output-header" onclick="toggleInvoiceOutput()">
                ارائه فاکتور فروش <span class="toggle-icon">▼</span>
            </h2>
            <div class="invoice-output-content" id="invoiceOutputContent">
                <div class="form-group">
                    <label for="customerName">نام خریدار:</label>
                    <input type="text" id="customerName" class="customer-input">
                </div>
                <div class="form-group">
                    <label for="customerPhone">شماره تماس (اختیاری):</label>
                    <input type="tel" id="customerPhone" class="customer-input">
                </div>
                <button type="button" class="generate-invoice-button" onclick="generateInvoiceDisplay()"> نمایش فاکتور </button>
                <div class="generated-invoice-display" id="generatedInvoiceDisplay">
                </div>
                <button type="button" class="print-invoice-button" id="printInvoiceButton" onclick="printInvoice()" style="display: none; margin-top: 15px;"> چاپ فاکتور </button>
            </div>
        </div>
    </div>
    <script>
        const farsiDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

        function convertToEnglishDigits(input) {
            if (input === null || input === undefined) return '';
            let output = input.toString();
            for (let i = 0; i < farsiDigits.length; i++) {
                output = output.replace(new RegExp(farsiDigits[i], 'g'), englishDigits[i]);
            }
            return output;
        }

        function convertToFarsiDigits(input) {
            if (input === null || input === undefined) return '';
            let output = input.toString();
            for (let i = 0; i < englishDigits.length; i++) {
                output = output.replace(new RegExp(englishDigits[i], 'g'), farsiDigits[i]);
            }
            return output;
        }

        function formatNumber(number) {
            if (isNaN(number) || number === null) return '';
            return convertToFarsiDigits(number.toLocaleString('fa-IR'));
        }

        function convertToWords(num) {
            if (isNaN(num) || num === null) return '';
            const units = ['', 'هزار', 'میلیون', 'میلیارد'];
            const teens = ['ده', 'یازده', 'دوازده', 'سیزده', 'چهارده', 'پانزده', 'شانزده', 'هفده', 'هجده', 'نوزده'];
            const tens = ['', 'ده', 'بیست', 'سی', 'چهل', 'پنجاه', 'شصت', 'هفتاد', 'هشتاد', 'نود'];
            const hundreds = ['', 'صد', 'دویست', 'سیصد', 'چهارصد', 'پانصد', 'ششصد', 'هفتصد', 'هشتصد', 'نهصد'];
            const ones = ['', 'یک', 'دو', 'سه', 'چهار', 'پنج', 'شش', 'هفت', 'هشت', 'نه'];

            function convertLessThanThousand(n) {
                if (n === 0) return '';
                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                if (n < 100) {
                    const ten = Math.floor(n / 10);
                    const one = n % 10;
                    return tens[ten] + (one !== 0 ? ' و ' + ones[one] : '');
                }
                const hundred = Math.floor(n / 100);
                const rest = n % 100;
                return hundreds[hundred] + (rest !== 0 ? ' و ' + convertLessThanThousand(rest) : '');
            }

            if (num === 0) return 'صفر';
            let words = '';
            let i = 0;
            let tempNum = num;

            while (tempNum > 0) {
                const chunk = tempNum % 1000;
                if (chunk !== 0) {
                    let chunkWords = convertLessThanThousand(chunk);
                    if (units[i] !== '') {
                        words = chunkWords + ' ' + units[i] + (words !== '' ? ' و ' + words : '');
                    } else {
                        words = chunkWords + (words !== '' ? ' و ' + words : '');
                    }
                }
                tempNum = Math.floor(tempNum / 1000);
                i++;
            }
            return words.trim();
        }

        function updatePriceInWords(inputId, outputId) {
            const inputElement = document.getElementById(inputId);
            const outputElement = document.getElementById(outputId);
            const value = parseFloat(convertToEnglishDigits(inputElement.value.replace(/,/g, '')));
            if (!isNaN(value)) {
                outputElement.textContent = convertToWords(value) + ' تومان';
                outputElement.style.fontSize = (value > 999999999) ? '0.7em' : '0.9em'; /* Adjust font size for very large numbers */
            } else {
                outputElement.textContent = '';
            }
        }

        function updateWageInWords(inputId, outputId) {
            const inputElement = document.getElementById(inputId);
            const outputElement = document.getElementById(outputId);
            const value = parseFloat(convertToEnglishDigits(inputElement.value.replace(/,/g, '')));
            const wageType = document.querySelector(`input[name="wageType${inputElement.id.replace('wage', '')}"]:checked`).value;

            if (!isNaN(value)) {
                if (wageType === 'percent') {
                    outputElement.textContent = convertToWords(value) + ' درصد';
                } else {
                    outputElement.textContent = convertToWords(value) + ' تومان';
                }
                outputElement.style.fontSize = (value > 999999999) ? '0.7em' : '0.9em';
            } else {
                outputElement.textContent = '';
            }
        }

        let itemIdCounter = 1;
        let buyItemIdCounter = 1;
        let coinSubItemIdCounter = 1;

        function addItem() {
            itemIdCounter++;
            const itemContainer = document.getElementById('itemContainer');
            const newItemRow = document.createElement('div');
            newItemRow.classList.add('item-row');
            newItemRow.setAttribute('data-item-id', itemIdCounter);
            newItemRow.innerHTML = `
                <button type="button" class="remove-item" onclick="removeItem(this)">✖</button>
                <div class="flex-group">
                    <div class="form-group">
                        <label for="weight${itemIdCounter}">وزن طلا (گرم):</label>
                        <input type="text" id="weight${itemIdCounter}" class="gold-weight" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label for="productType${itemIdCounter}">نوع محصول:</label>
                        <select id="productType${itemIdCounter}" class="product-type-select">
                            <option value="">انتخاب کنید</option>
                            <option value="زنجیر">زنجیر</option>
                            <option value="دستبند">دستبند</option>
                            <option value="النگو">النگو</option>
                            <option value="سرویس">سرویس</option>
                            <option value="نیم‌ست">نیم‌ست</option>
                            <option value="گوشواره">گوشواره</option>
                            <option value="مدال">مدال</option>
                            <option value="گردنبند">گردنبند</option>
                            <option value="خلخال">خلخال</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="wage${itemIdCounter}">اجرت:</label>
                    <div class="currency-toggle">
                        <label>
                            <input type="radio" name="wageType${itemIdCounter}" value="percent" checked onchange="toggleWageInput(this)"> درصد
                        </label>
                        <label>
                            <input type="radio" name="wageType${itemIdCounter}" value="amount" onchange="toggleWageInput(this)"> تومان
                        </label>
                    </div>
                    <div class="input-inline-wrapper">
                        <input type="text" id="wage${itemIdCounter}" class="gold-wage">
                        <span class="input-inline-display" id="wageInWords${itemIdCounter}"></span>
                    </div>
                </div>
            `;
            itemContainer.appendChild(newItemRow);

            // Add event listeners for new inputs
            document.getElementById(`goldPrice`).addEventListener('input', calculateFactor);
            document.getElementById(`weight${itemIdCounter}`).addEventListener('input', calculateFactor);
            document.getElementById(`wage${itemIdCounter}`).addEventListener('input', calculateFactor);
            document.getElementById(`productType${itemIdCounter}`).addEventListener('change', calculateFactor);
            document.querySelectorAll(`input[name="wageType${itemIdCounter}"]`).forEach(radio => {
                radio.addEventListener('change', calculateFactor);
            });

            // Add input formatting and word conversion
            document.getElementById(`weight${itemIdCounter}`).addEventListener('input', function() {
                this.value = formatInput(this.value);
            });
            document.getElementById(`wage${itemIdCounter}`).addEventListener('input', function() {
                this.value = formatInput(this.value);
                updateWageInWords(`wage${itemIdCounter}`, `wageInWords${itemIdCounter}`);
            });
            calculateFactor();
        }

        function removeItem(button) {
            const itemRow = button.closest('.item-row');
            itemRow.remove();
            calculateFactor();
        }

        function toggleWageInput(radio) {
            const wageInput = radio.closest('.form-group').querySelector('.gold-wage');
            const wageType = radio.value;
            if (wageType === 'percent') {
                wageInput.placeholder = 'مثال: 7';
            } else {
                wageInput.placeholder = 'مثال: 50000';
            }
            updateWageInWords(wageInput.id, wageInput.nextElementSibling.id);
            calculateFactor();
        }

        function addBuyGoldItem() {
            buyItemIdCounter++;
            const container = document.getElementById('buyGoldItemContainer');
            const newItem = document.createElement('div');
            newItem.classList.add('buy-option-group');
            newItem.setAttribute('data-buy-item-id', `gold${buyItemIdCounter}`);
            newItem.innerHTML = `
                <button type="button" class="remove-buy-item" onclick="removeBuyItem(this)">✖</button>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="buyGoldWeight${buyItemIdCounter}" style="margin-bottom: 5px;">وزن طلا (گرم):</label>
                    <input type="text" id="buyGoldWeight${buyItemIdCounter}" class="buy-option-input gold-buy-weight" inputmode="decimal">
                </div>
            `;
            container.appendChild(newItem);
            document.getElementById(`buyGoldWeight${buyItemIdCounter}`).addEventListener('input', function() {
                this.value = formatInput(this.value);
                calculateFactor();
            });
            calculateFactor();
        }

        function addBuyCoinItem() {
            buyItemIdCounter++;
            const container = document.getElementById('buyCoinItemContainer');
            const newItem = document.createElement('div');
            newItem.classList.add('coin-item-group');
            newItem.setAttribute('data-buy-item-id', `coin${buyItemIdCounter}`);
            newItem.innerHTML = `
                <button type="button" class="remove-buy-item" onclick="removeBuyItem(this)">✖</button>
                <div id="coinSelectsCoin${buyItemIdCounter}">
                    <div class="coin-sub-item">
                        <select class="buy-option-input coin-model-select" onchange="updateCoinPriceInput(this, 'coin${buyItemIdCounter}')">
                            <option value="">انتخاب مدل سکه</option>
                            <option value="ربع ۸۶">ربع ۸۶</option>
                            <option value="نیم ۸۶">نیم ۸۶</option>
                            <option value="امامی ۸۶">امامی ۸۶</option>
                            <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                            <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                            <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                            <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                        </select>
                        <input type="text" class="buy-option-input coin-price-input" placeholder="قیمت سکه" oninput="calculateFactor()" style="flex-grow: 1;">
                        <button type="button" class="coin-remove-button" onclick="removeCoinSubItem(this)">✖</button>
                    </div>
                </div>
                <button type="button" class="add-coin-button" onclick="addCoinSelect('coin${buyItemIdCounter}')">افزودن سکه جدید</button>
            `;
            container.appendChild(newItem);
            newItem.querySelectorAll('.coin-price-input').forEach(input => {
                input.addEventListener('input', function() {
                    this.value = formatInput(this.value);
                    calculateFactor();
                });
            });
            calculateFactor();
        }

        function addCoinSelect(buyItemId) {
            coinSubItemIdCounter++;
            const coinSelectsContainer = document.getElementById(`coinSelects${buyItemId}`);
            const newCoinSubItem = document.createElement('div');
            newCoinSubItem.classList.add('coin-sub-item');
            newCoinSubItem.innerHTML = `
                <select class="buy-option-input coin-model-select" onchange="updateCoinPriceInput(this, '${buyItemId}')">
                    <option value="">انتخاب مدل سکه</option>
                    <option value="ربع ۸۶">ربع ۸۶</option>
                    <option value="نیم ۸۶">نیم ۸۶</option>
                    <option value="امامی ۸۶">امامی ۸۶</option>
                    <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                    <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                    <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                    <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                </select>
                <input type="text" class="buy-option-input coin-price-input" placeholder="قیمت سکه" oninput="calculateFactor()" style="flex-grow: 1;">
                <button type="button" class="coin-remove-button" onclick="removeCoinSubItem(this)">✖</button>
            `;
            coinSelectsContainer.appendChild(newCoinSubItem);
            newCoinSubItem.querySelector('.coin-price-input').addEventListener('input', function() {
                this.value = formatInput(this.value);
                calculateFactor();
            });
            calculateFactor();
        }

        function removeCoinSubItem(button) {
            const subItem = button.closest('.coin-sub-item');
            subItem.remove();
            calculateFactor();
        }

        function removeBuyItem(button) {
            const itemGroup = button.closest('.buy-option-group') || button.closest('.coin-item-group');
            itemGroup.remove();
            calculateFactor();
        }

        function updateCoinPriceInput(selectElement, buyItemId) {
            const inputElement = selectElement.nextElementSibling; // The input right after the select
            const selectedCoin = selectElement.value;
            let price = ''; // Default empty
            
            // Example prices - you might fetch these dynamically or have a more robust lookup
            switch (selectedCoin) {
                case 'ربع ۸۶': price = '15000000'; break;
                case 'نیم ۸۶': price = '28000000'; break;
                case 'امامی ۸۶': price = '32000000'; break;
                case 'ربع زیر ۸۶': price = '14500000'; break;
                case 'نیم زیر ۸۶': price = '27000000'; break;
                case 'امامی زیر ۸۶': price = '31000000'; break;
                case 'یک گرمی بانکی': price = '6000000'; break;
                default: price = ''; break;
            }
            inputElement.value = formatInput(price);
            calculateFactor();
        }

        function calculateFactor() {
            const goldPriceInput = document.getElementById('goldPrice');
            updatePriceInWords('goldPrice', 'goldPriceInWords');

            const goldPrice = parseFloat(convertToEnglishDigits(goldPriceInput.value.replace(/,/g, ''))) || 0;
            let totalGoldValue = 0;
            let totalWage = 0;
            let totalBuyGoldWeight = 0;
            let totalBuyCoinValue = 0;
            let totalBuyParsianWeight = 0;
            let totalBuyIngotWeight = 0;

            document.querySelectorAll('.item-row').forEach(itemRow => {
                const itemId = itemRow.getAttribute('data-item-id');
                const weight = parseFloat(convertToEnglishDigits(document.getElementById(`weight${itemId}`).value.replace(/,/g, ''))) || 0;
                const wageInput = parseFloat(convertToEnglishDigits(document.getElementById(`wage${itemId}`).value.replace(/,/g, ''))) || 0;
                const wageType = document.querySelector(`input[name="wageType${itemId}"]:checked`).value;

                let currentWage = 0;
                if (wageType === 'percent') {
                    currentWage = (wageInput / 100) * goldPrice * weight;
                } else {
                    currentWage = wageInput;
                }

                totalGoldValue += goldPrice * weight + currentWage;
                totalWage += currentWage;
            });

            document.querySelectorAll('.gold-buy-weight').forEach(input => {
                totalBuyGoldWeight += parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0;
            });

            document.querySelectorAll('.coin-price-input').forEach(input => {
                totalBuyCoinValue += parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0;
            });

            document.querySelectorAll('.parsian-buy-weight').forEach(input => {
                totalBuyParsianWeight += parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0;
            });

            document.querySelectorAll('.ingot-buy-weight').forEach(input => {
                totalBuyIngotWeight += parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0;
            });

            const profitRate = parseFloat(document.getElementById('profitRate').value) || 0;
            const discountInput = parseFloat(convertToEnglishDigits(document.getElementById('discount').value.replace(/,/g, ''))) || 0;
            const includeTax = document.getElementById('includeTax').checked;
            const buyDiffGoldWithDiscount = document.getElementById('buyDiffGoldWithDiscount').checked;

            let totalProfit = totalGoldValue * (profitRate / 100);
            let totalTax = includeTax ? (totalGoldValue + totalProfit) * 0.10 : 0;
            let totalAmount = totalGoldValue + totalProfit + totalTax;
            
            let buyDiffGoldAmount = 0;
            if (buyDiffGoldWithDiscount && totalBuyGoldWeight > 0) {
                buyDiffGoldAmount = totalBuyGoldWeight * goldPrice * 0.02; // 2% discount
            }

            let customerPayoutGold = totalBuyGoldWeight * goldPrice;
            let customerPayoutParsian = totalBuyParsianWeight * goldPrice; // Assuming Parsian price is related to gold price per gram
            let customerPayoutIngot = totalBuyIngotWeight * goldPrice; // Assuming Ingot price is related to gold price per gram
            let totalCustomerPayout = customerPayoutGold + totalBuyCoinValue + customerPayoutParsian + customerPayoutIngot;

            let finalTotal = totalAmount - discountInput - totalCustomerPayout + buyDiffGoldAmount;

            const resultSection = document.getElementById('resultSection');
            resultSection.innerHTML = `
                <div class="result-item"><span>جمع کل (بدون اجرت و سود):</span><span>${formatNumber(goldPrice * document.querySelectorAll('.gold-weight').reduce((sum, input) => sum + (parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0), 0))}</span></div>
                <div class="result-item"><span>کل اجرت:</span><span>${formatNumber(totalWage)}</span></div>
                <div class="result-item"><span>کل سود فروشنده (${profitRate}%):</span><span>${formatNumber(totalProfit)}</span></div>
                ${includeTax ? `<div class="result-item total-tax"><span>مالیات (${10}%):</span><span>${formatNumber(totalTax)}</span></div>` : ''}
                <div class="result-item"><span>جمع قابل پرداخت:</span><span>${formatNumber(totalAmount)}</span></div>
                ${discountInput > 0 ? `<div class="result-item discount-amount"><span>تخفیف:</span><span>${formatNumber(discountInput)}</span></div>` : ''}
                ${totalBuyGoldWeight > 0 ? `<div class="result-item buy-gold-amount"><span>قیمت طلای خریداری شده از مشتری (${formatNumber(totalBuyGoldWeight)} گرم):</span><span>${formatNumber(customerPayoutGold)}</span></div>` : ''}
                ${totalBuyCoinValue > 0 ? `<div class="result-item buy-gold-amount"><span>قیمت سکه خریداری شده از مشتری:</span><span>${formatNumber(totalBuyCoinValue)}</span></div>` : ''}
                ${totalBuyParsianWeight > 0 ? `<div class="result-item buy-gold-amount"><span>قیمت پارسیان خریداری شده از مشتری (${formatNumber(totalBuyParsianWeight)} گرم):</span><span>${formatNumber(customerPayoutParsian)}</span></div>` : ''}
                ${totalBuyIngotWeight > 0 ? `<div class="result-item buy-gold-amount"><span>قیمت شمش خریداری شده از مشتری (${formatNumber(totalBuyIngotWeight)} گرم):</span><span>${formatNumber(customerPayoutIngot)}</span></div>` : ''}
                ${buyDiffGoldWithDiscount && buyDiffGoldAmount > 0 ? `<div class="result-item buy-diff-gold-amount"><span>کسر 2% بابت خرید ما به تفاوت طلا:</span><span>${formatNumber(buyDiffGoldAmount)}</span></div>` : ''}
                <div class="result-item final-total"><span>قیمت نهایی:</span><span>${formatNumber(finalTotal)}</span></div>
            `;

            updateSuggestedDiscounts(finalTotal, discountInput);
        }

        function updateSuggestedDiscounts(currentTotal, currentDiscount) {
            const suggestedDiscountsSection = document.getElementById('suggestedDiscountsSection');
            suggestedDiscountsSection.innerHTML = '';
            
            const goldPrice = parseFloat(convertToEnglishDigits(document.getElementById('goldPrice').value.replace(/,/g, ''))) || 0;
            if (goldPrice === 0 || isNaN(goldPrice) || currentTotal <= 0) {
                suggestedDiscountsSection.style.display = 'none';
                return;
            }

            const amounts = [10000, 20000, 50000, 100000, 200000];
            const currentTotalRounded = Math.round(currentTotal / 1000) * 1000; // Round to nearest thousand for comparison

            const currentDiscountValue = parseFloat(convertToEnglishDigits(document.getElementById('discount').value.replace(/,/g, ''))) || 0;
            let hasSuggestions = false;

            amounts.forEach(amount => {
                const targetPrice = currentTotalRounded - amount;
                if (targetPrice > 0) {
                    const diff = currentTotal - targetPrice;
                    const isActive = (Math.abs(currentDiscountValue - diff) < 10); // Check if current discount is very close to this suggestion
                    
                    const suggestedDiscountItem = document.createElement('div');
                    suggestedDiscountItem.classList.add('suggested-discount-item');
                    if (isActive) {
                        suggestedDiscountItem.classList.add('active');
                    }
                    suggestedDiscountItem.innerHTML = `
                        <div class="suggested-discount-text">
                            <div>پیشنهاد تخفیف: <span class="amount">${formatNumber(diff)} تومان</span></div>
                            <div class="final-price">قیمت نهایی: <span>${formatNumber(targetPrice)} تومان</span></div>
                        </div>
                        <input type="radio" name="suggestedDiscount" value="${diff}" ${isActive ? 'checked' : ''} onclick="applySuggestedDiscount(this)">
                    `;
                    suggestedDiscountsSection.appendChild(suggestedDiscountItem);
                    hasSuggestions = true;
                }
            });

            if (hasSuggestions) {
                suggestedDiscountsSection.style.display = 'block';
            } else {
                suggestedDiscountsSection.style.display = 'none';
            }
        }


        function applySuggestedDiscount(radio) {
            const discountInput = document.getElementById('discount');
            discountInput.value = formatInput(radio.value);
            calculateFactor();

            // Remove active class from all suggested items
            document.querySelectorAll('.suggested-discount-item').forEach(item => {
                item.classList.remove('active');
            });
            // Add active class to the clicked item
            radio.closest('.suggested-discount-item').classList.add('active');
        }


        function generateInvoiceDisplay() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const goldPrice = parseFloat(convertToEnglishDigits(document.getElementById('goldPrice').value.replace(/,/g, ''))) || 0;

            let invoiceContent = ``;
            let totalGoldWeightSold = 0;
            let totalWageAmountSold = 0;
            let totalProductPriceSold = 0;

            document.querySelectorAll('.item-row').forEach(itemRow => {
                const itemId = itemRow.getAttribute('data-item-id');
                const weight = parseFloat(convertToEnglishDigits(document.getElementById(`weight${itemId}`).value.replace(/,/g, ''))) || 0;
                const productType = document.getElementById(`productType${itemId}`).value;
                const wageInput = parseFloat(convertToEnglishDigits(document.getElementById(`wage${itemId}`).value.replace(/,/g, ''))) || 0;
                const wageType = document.querySelector(`input[name="wageType${itemId}"]:checked`).value;

                if (weight > 0) {
                    totalGoldWeightSold += weight;
                    let currentWage = 0;
                    if (wageType === 'percent') {
                        currentWage = (wageInput / 100) * goldPrice * weight;
                    } else {
                        currentWage = wageInput;
                    }
                    totalWageAmountSold += currentWage;
                    const itemTotalPrice = (goldPrice * weight) + currentWage;
                    totalProductPriceSold += itemTotalPrice;

                    invoiceContent += `
                        <div class="invoice-item-group">
                            <p><strong>نوع کالا:</strong> ${productType || 'طلای متفرقه'}</p>
                            <p><strong>وزن:</strong> ${formatNumber(weight)} گرم</p>
                            <p><strong>اجرت:</strong> ${wageType === 'percent' ? `${formatNumber(wageInput)}%` : `${formatNumber(wageInput)} تومان`} (${formatNumber(currentWage)} تومان)</p>
                            <p><strong>قیمت واحد طلا:</strong> ${formatNumber(goldPrice)} تومان</p>
                            <p><strong>قیمت کل آیتم:</strong> ${formatNumber(itemTotalPrice)} تومان</p>
                        </div>
                    `;
                }
            });

            if (totalProductPriceSold > 0) {
                invoiceContent += `<p class="invoice-section-divider">خلاصه فروش طلا:</p>`;
                invoiceContent += `<p><strong>جمع کل وزن طلای فروخته شده:</strong> ${formatNumber(totalGoldWeightSold)} گرم</p>`;
                invoiceContent += `<p><strong>جمع کل اجرت طلا:</strong> ${formatNumber(totalWageAmountSold)} تومان</p>`;
                invoiceContent += `<p><strong>جمع کل قیمت طلا (با اجرت):</strong> ${formatNumber(totalProductPriceSold)} تومان</p>`;
            }

            // Customer bought items
            let totalBuyGoldWeight = 0;
            document.querySelectorAll('.gold-buy-weight').forEach(input => {
                totalBuyGoldWeight += parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0;
            });
            let customerPayoutGold = totalBuyGoldWeight * goldPrice;
            if (totalBuyGoldWeight > 0) {
                invoiceContent += `
                    <p class="invoice-section-divider">خرید طلا از مشتری:</p>
                    <p class="buy-item-value"><strong>وزن طلای خریداری شده:</strong> <span>${formatNumber(totalBuyGoldWeight)}</span> گرم</p>
                    <p class="buy-item-value"><strong>قیمت طلای خریداری شده:</strong> <span>${formatNumber(customerPayoutGold)}</span> تومان</p>
                `;
            }

            let totalBuyCoinValue = 0;
            let coinDetails = [];
            document.querySelectorAll('.coin-item-group').forEach(group => {
                group.querySelectorAll('.coin-model-select').forEach(select => {
                    const selectedModel = select.value;
                    const priceInput = select.nextElementSibling;
                    const price = parseFloat(convertToEnglishDigits(priceInput.value.replace(/,/g, ''))) || 0;
                    if (selectedModel && price > 0) {
                        totalBuyCoinValue += price;
                        coinDetails.push({ model: selectedModel, price: price });
                    }
                });
            });

            if (totalBuyCoinValue > 0) {
                invoiceContent += `
                    <p class="invoice-section-divider">خرید سکه از مشتری:</p>
                `;
                coinDetails.forEach(coin => {
                    invoiceContent += `<p class="buy-item-value"><strong>مدل سکه:</strong> ${coin.model}، <strong>قیمت:</strong> <span>${formatNumber(coin.price)}</span> تومان</p>`;
                });
                invoiceContent += `<p class="buy-item-value"><strong>جمع کل قیمت سکه‌های خریداری شده:</strong> <span>${formatNumber(totalBuyCoinValue)}</span> تومان</p>`;
            }

            let totalBuyParsianWeight = 0;
            document.querySelectorAll('.parsian-buy-weight').forEach(input => {
                totalBuyParsianWeight += parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0;
            });
            let customerPayoutParsian = totalBuyParsianWeight * goldPrice;
            if (totalBuyParsianWeight > 0) {
                invoiceContent += `
                    <p class="invoice-section-divider">خرید پارسیان از مشتری:</p>
                    <p class="buy-item-value"><strong>وزن پارسیان خریداری شده:</strong> <span>${formatNumber(totalBuyParsianWeight)}</span> گرم</p>
                    <p class="buy-item-value"><strong>قیمت پارسیان خریداری شده:</strong> <span>${formatNumber(customerPayoutParsian)}</span> تومان</p>
                `;
            }

            let totalBuyIngotWeight = 0;
            document.querySelectorAll('.ingot-buy-weight').forEach(input => {
                totalBuyIngotWeight += parseFloat(convertToEnglishDigits(input.value.replace(/,/g, ''))) || 0;
            });
            let customerPayoutIngot = totalBuyIngotWeight * goldPrice;
            if (totalBuyIngotWeight > 0) {
                invoiceContent += `
                    <p class="invoice-section-divider">خرید شمش از مشتری:</p>
                    <p class="buy-item-value"><strong>وزن شمش خریداری شده:</strong> <span>${formatNumber(totalBuyIngotWeight)}</span> گرم</p>
                    <p class="buy-item-value"><strong>قیمت شمش خریداری شده:</strong> <span>${formatNumber(customerPayoutIngot)}</span> تومان</p>
                `;
            }

            const profitRate = parseFloat(document.getElementById('profitRate').value) || 0;
            const discountInput = parseFloat(convertToEnglishDigits(document.getElementById('discount').value.replace(/,/g, ''))) || 0;
            const includeTax = document.getElementById('includeTax').checked;
            const buyDiffGoldWithDiscount = document.getElementById('buyDiffGoldWithDiscount').checked;

            let totalProfit = totalProductPriceSold * (profitRate / 100);
            let totalTax = includeTax ? (totalProductPriceSold + totalProfit) * 0.10 : 0;
            let totalAmount = totalProductPriceSold + totalProfit + totalTax;
            
            let buyDiffGoldAmount = 0;
            if (buyDiffGoldWithDiscount && totalBuyGoldWeight > 0) {
                buyDiffGoldAmount = totalBuyGoldWeight * goldPrice * 0.02;
            }
            
            let totalCustomerPayout = customerPayoutGold + totalBuyCoinValue + customerPayoutParsian + customerPayoutIngot;
            let finalTotal = totalAmount - discountInput - totalCustomerPayout + buyDiffGoldAmount;

            invoiceContent += `
                <p class="invoice-section-divider">خلاصه مالی:</p>
                <p><strong>جمع فروش (با اجرت و سود):</strong> ${formatNumber(totalProductPriceSold + totalProfit)} تومان</p>
                ${includeTax ? `<p><strong>مالیات (${10}%):</strong> ${formatNumber(totalTax)} تومان</p>` : ''}
                <p><strong>جمع قابل پرداخت (بدون تخفیف و خرید):</strong> ${formatNumber(totalAmount)} تومان</p>
                ${discountInput > 0 ? `<p class="discount-value"><strong>تخفیف:</strong> ${formatNumber(discountInput)} تومان</p>` : ''}
                ${totalCustomerPayout > 0 ? `<p class="buy-item-value"><strong>کل مبلغ خرید از مشتری:</strong> <span>${formatNumber(totalCustomerPayout)}</span> تومان</p>` : ''}
                ${buyDiffGoldWithDiscount && buyDiffGoldAmount > 0 ? `<p class="buy-item-value"><strong>کسر 2% بابت خرید ما به تفاوت طلا:</strong> <span>${formatNumber(buyDiffGoldAmount)}</span> تومان</p>` : ''}
                <p class="total-price-line"><strong>قیمت نهایی فاکتور:</strong> <span class="total-final-value">${formatNumber(finalTotal)}</span> تومان</p>
            `;

            const generatedInvoiceDisplay = document.getElementById('generatedInvoiceDisplay');
            generatedInvoiceDisplay.innerHTML = `
                <p style="text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 20px;">فاکتور فروش طلا</p>
                <p><strong>تاریخ:</strong> ${convertToFarsiDigits(new Date().toLocaleDateString('fa-IR'))}</p>
                <p><strong>نام فروشنده:</strong> [نام فروشنده]</p>
                ${customerName ? `<p><strong>نام خریدار:</strong> ${customerName}</p>` : ''}
                ${customerPhone ? `<p><strong>شماره تماس خریدار:</strong> ${customerPhone}</p>` : ''}
                <p><strong>قیمت روز طلا (هر گرم):</strong> ${formatNumber(goldPrice)} تومان</p>
                <hr style="border-top: 1px dashed #ccc; margin: 20px 0;">
                ${invoiceContent}
                <p style="margin-top: 30px; text-align: center; font-size: 0.9em; color: #666;">
                    با تشکر از خرید شما
                </p>
                <p style="text-align: center; font-size: 0.8em; color: #999;">
                    این فاکتور بر اساس اطلاعات وارد شده تولید شده است.
                </p>
            `;
            generatedInvoiceDisplay.style.display = 'block';
            document.getElementById('printInvoiceButton').style.display = 'block';
            document.getElementById('invoiceOutputContent').classList.add('expanded');
            document.getElementById('invoiceOutputWrapper').querySelector('.invoice-output-header').classList.add('expanded');
        }

        function printInvoice() {
            window.print();
        }

        function toggleBuySection(sectionId) {
            const section = document.getElementById(sectionId);
            const content = section.querySelector('.buy-section-content');
            const header = section.querySelector('.buy-section-header');
            
            content.classList.toggle('expanded');
            header.classList.toggle('expanded');
        }

        function toggleInvoiceOutput() {
            const wrapper = document.getElementById('invoiceOutputWrapper');
            const content = document.getElementById('invoiceOutputContent');
            const header = wrapper.querySelector('.invoice-output-header');

            content.classList.toggle('expanded');
            header.classList.toggle('expanded');
        }

        // Input formatting: Add commas as thousands separators and handle Farsi digits
        function formatInput(value) {
            if (value === null || value === undefined) return '';
            let cleanedValue = convertToEnglishDigits(value.toString().replace(/,/g, ''));
            // Allow only numbers and a single decimal point
            cleanedValue = cleanedValue.replace(/[^0-9.]/g, ''); 
            const parts = cleanedValue.split('.');
            if (parts.length > 2) { // Only one decimal point allowed
                cleanedValue = parts[0] + '.' + parts.slice(1).join('');
            }

            if (cleanedValue === '' || cleanedValue === '.') {
                return '';
            }

            // If it ends with a decimal point, keep it that way for user input
            if (cleanedValue.endsWith('.')) {
                return convertToFarsiDigits(cleanedValue);
            }

            const number = parseFloat(cleanedValue);
            if (isNaN(number)) {
                return '';
            }
            // Format integer part with commas
            const integerPart = Math.floor(number).toLocaleString('en-US');
            const decimalPart = cleanedValue.includes('.') ? cleanedValue.split('.')[1] : '';

            let formatted = convertToFarsiDigits(integerPart);
            if (decimalPart !== '') {
                formatted += '.' + convertToFarsiDigits(decimalPart);
            }
            return formatted;
        }


        document.addEventListener('DOMContentLoaded', function() {
            // Apply formatting and word conversion on initial load for existing inputs
            document.getElementById('goldPrice').addEventListener('input', function() {
                this.value = formatInput(this.value);
                updatePriceInWords('goldPrice', 'goldPriceInWords');
                calculateFactor();
            });

            document.querySelectorAll('.gold-weight, .gold-wage, .buy-option-input, .discount-input').forEach(input => {
                input.addEventListener('input', function() {
                    this.value = formatInput(this.value);
                    calculateFactor();
                });
            });

            // Initial call to set up the wage input placeholder
            document.querySelectorAll('input[name="wageType1"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleWageInput(this);
                });
            });

            // Set initial placeholders for existing wage inputs
            document.querySelectorAll('.item-row').forEach(itemRow => {
                const itemId = itemRow.getAttribute('data-item-id');
                const wageRadio = document.querySelector(`input[name="wageType${itemId}"]:checked`);
                if (wageRadio) {
                    toggleWageInput(wageRadio);
                }
            });

            // Update word conversion for wage on load
            document.querySelectorAll('.gold-wage').forEach(input => {
                updateWageInWords(input.id, input.nextElementSibling.id);
            });


            // Recalculate everything when select options change
            document.getElementById('profitRate').addEventListener('change', calculateFactor);
            document.getElementById('includeTax').addEventListener('change', calculateFactor);
            document.getElementById('buyDiffGoldWithDiscount').addEventListener('change', calculateFactor);

            // Trigger calculateFactor when any item-row input changes
            document.getElementById('itemContainer').addEventListener('input', function(event) {
                if (event.target.classList.contains('gold-weight') || event.target.classList.contains('gold-wage')) {
                    calculateFactor();
                }
            });
            document.getElementById('itemContainer').addEventListener('change', function(event) {
                if (event.target.classList.contains('product-type-select')) {
                    calculateFactor();
                }
            });

            document.getElementById('buyGoldItemContainer').addEventListener('input', calculateFactor);
            document.getElementById('buyCoinItemContainer').addEventListener('input', calculateFactor);
            document.getElementById('buyParsianIngotSection').addEventListener('input', calculateFactor);
            
            // Clear inputs if they are 0 and blur to avoid persistent 0s
            document.querySelectorAll('input[type="text"], input[type="tel"]').forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() === '۰' || this.value.trim() === '0') {
                        this.value = '';
                    }
                });
            });

            // Clear buy section inputs if they are 0 on blur
            const buyGoldWeightInput = document.getElementById('buyGoldWeight1');
            const parsianWeightInput = document.getElementById('buyParsianWeight1');
            const ingotWeightInput = document.getElementById('buyIngotWeight1');

            if (buyGoldWeightInput) {
                buyGoldWeightInput.addEventListener('blur', function() {
                    if (parseFloat(convertToEnglishDigits(this.value)) === 0 && this.value.trim() === '') {
                        this.value = '';
                    }
                });
            }
            if (parsianWeightInput) {
                parsianWeightInput.addEventListener('blur', function() {
                    if (parseFloat(convertToEnglishDigits(this.value)) === 0 && this.value.trim() === '') {
                        this.value = '';
                    }
                });
            }
            if (ingotWeightInput) {
                ingotWeightInput.addEventListener('blur', function() {
                    if (parseFloat(convertToEnglishDigits(this.value)) === 0 && this.value.trim() === '') {
                        this.value = '';
                    }
                });
            }

            // Collapse all buy sections and invoice section by default
            document.getElementById('buyGoldSection').querySelector('.buy-section-content').classList.remove('expanded');
            document.getElementById('buyGoldSection').querySelector('.buy-section-header').classList.remove('expanded');
            document.getElementById('buyCoinSection').querySelector('.buy-section-content').classList.remove('expanded');
            document.getElementById('buyCoinSection').querySelector('.buy-section-header').classList.remove('expanded');
            document.getElementById('buyParsianIngotSection').querySelector('.buy-section-content').classList.remove('expanded');
            document.getElementById('buyParsianIngotSection').querySelector('.buy-section-header').classList.remove('expanded');
            document.getElementById('invoiceOutputContent').classList.remove('expanded');
            document.getElementById('invoiceOutputWrapper').querySelector('.invoice-output-header').classList.remove('expanded');

            calculateFactor();
        });
    </script>
</body>
</html>
