<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاسبه‌گر طلا و فاکتور فروش</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f2f2f7;
            color: #333;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
            color: #1a73e8; /* Blue for main headings */
        }

        h2 {
            font-size: 1.4em;
            margin-top: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title::before {
            content: '';
            width: 8px;
            height: 25px;
            border-radius: 4px;
            margin-left: 10px;
        }

        .gold-calc-title::before { background-color: #f44336; /* Red */ }
        .buy-gold-title::before { background-color: #4CAF50; /* Green */ }
        .additional-costs-title::before { background-color: #9c27b0; /* Purple */ }
        .discount-title::before { background-color: #fdd835; /* Yellow */ }
        .invoice-title::before { background-color: #2196F3; /* Blue */ }
        .customer-invoice-title::before { background-color: #FF9800; /* Orange */ }


        .form-group {
            margin-bottom: 18px;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95em;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0 10px;
        }

        .input-wrapper input, .input-wrapper select {
            border: none;
            flex-grow: 1;
            padding: 12px 0;
            background-color: transparent;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1em;
            color: #333;
            outline: none;
            text-align: right;
        }

        .input-wrapper input::placeholder {
            color: #bbb;
        }

        .input-wrapper .currency-label {
            margin-left: 10px;
            color: #777;
            font-size: 0.9em;
        }

        .input-wrapper .persian-text {
            flex-grow: 1;
            padding: 12px 0;
            text-align: left;
            margin-left: 10px;
            color: #555;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            min-width: 50px; /* Adjust as needed */
            font-size: 0.9em; /* Default font size */
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 10px;
            width: 18px;
            height: 18px;
        }

        .add-item-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 0.95em;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }

        .add-item-btn:hover {
            background-color: #45a049;
        }

        .gold-item, .coin-item {
            border: 1px dashed #c0c0c0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fefefe;
            position: relative;
        }

        .remove-item-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 10px;
            transition: background-color 0.3s ease;
        }

        .remove-item-btn:hover {
            background-color: #da190b;
        }


        .discount-smart-box {
            background-color: #e8f5e9; /* Light green */
            border: 1px solid #a5d6a7; /* Darker green border */
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .discount-smart-box h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #388e3c; /* Dark green */
        }

        .smart-discount-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .smart-discount-btn {
            background-color: #c8e6c9; /* Lighter green */
            color: #388e3c;
            border: 1px solid #81c784;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 0.9em;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .smart-discount-btn.active {
            background-color: #388e3c;
            color: white;
            border-color: #1b5e20;
            transform: scale(1.05);
        }

        .smart-discount-btn:hover:not(.active) {
            background-color: #b9d9ba;
        }

        .invoice-summary {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item .label {
            font-weight: bold;
            color: #555;
        }

        .invoice-item .value {
            color: #333;
        }

        .invoice-item .value.discount {
            color: #f44336; /* Red for discount */
            font-weight: bold;
        }

        .invoice-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2196F3; /* Blue for total price */
        }

        .customer-invoice-section {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            .smart-discount-options {
                flex-direction: column;
            }
            .smart-discount-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>محاسبه‌گر طلا و فاکتور فروش</h1>

        <div class="section-title gold-calc-title">
            <h2>محاسبه قیمت طلا</h2>
        </div>

        <div class="form-group">
            <label for="goldPrice">قیمت هر گرم طلا (تومان):</label>
            <div class="input-wrapper">
                <div id="goldPricePersian" class="persian-text"></div>
                <input type="text" id="goldPrice" inputmode="numeric" maxlength="9" pattern="[0-9]*" oninput="formatAndConvertGoldPrice(this)">
            </div>
        </div>

        <div id="goldItemsContainer">
            <div class="gold-item" id="goldItem_1">
                <button type="button" class="remove-item-btn" onclick="removeItem('goldItem_1')">×</button>
                <div class="form-group">
                    <label for="goldWeight_1">وزن طلا (گرم):</label>
                    <div class="input-wrapper">
                        <input type="text" id="goldWeight_1" inputmode="decimal" oninput="convertToPersian(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="goldModel_1">مدل طلا:</label>
                    <div class="input-wrapper">
                        <select id="goldModel_1">
                            <option value="سرویس">سرویس</option>
                            <option value="النگو">النگو</option>
                            <option value="نیم‌ست">نیم‌ست</option>
                            <option value="دستبند">دستبند</option>
                            <option value="زنجیر">زنجیر</option>
                            <option value="گردنبند">گردنبند</option>
                            <option value="گوشواره">گوشواره</option>
                            <option value="مدال">مدال</option>
                            <option value="پلاک">پلاک</option>
                            <option value="خلخال">خلخال</option>
                            <option value="آویز ساعت">آویز ساعت</option>
                            <option value="رو لباسی">رو لباسی</option>
                            <option value="سفارشی">سفارشی</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="wage_1">اجرت:</label>
                    <div class="input-wrapper">
                        <input type="text" id="wage_1" inputmode="decimal" oninput="formatWageInput(this)">
                        <select id="wageType_1" onchange="updateWagePlaceholder(this)">
                            <option value="%">%</option>
                            <option value="$">تومان</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="add-item-btn" onclick="addGoldItem()">+ افزودن آیتم طلا</button>

        <hr>

        <div class="section-title buy-gold-title">
            <h2>بخش خرید طلا</h2>
        </div>

        <div id="buyGoldItemsContainer">
            <div class="gold-item" id="buyGoldItem_1">
                <button type="button" class="remove-item-btn" onclick="removeItem('buyGoldItem_1')">×</button>
                <div class="form-group">
                    <label for="buyGoldType_1">نوع خرید:</label>
                    <div class="input-wrapper">
                        <select id="buyGoldType_1" onchange="toggleBuyGoldFields(this)">
                            <option value="">انتخاب کنید...</option>
                            <option value="gold">طلا</option>
                            <option value="ingot">شمش</option>
                            <option value="parsian">سکه پارسیان</option>
                            <option value="coin">سکه</option>
                        </select>
                    </div>
                </div>

                <div class="form-group hidden" id="buyGoldWeightGroup_1">
                    <label for="buyGoldWeight_1">وزن (گرم):</label>
                    <div class="input-wrapper">
                        <input type="text" id="buyGoldWeight_1" inputmode="decimal" oninput="convertToPersian(this)">
                    </div>
                </div>

                <div class="form-group hidden" id="buyCoinModelGroup_1">
                    <label for="buyCoinModel_1">مدل سکه:</label>
                    <div class="input-wrapper">
                        <select id="buyCoinModel_1">
                            <option value="ربع ۸۶">ربع ۸۶</option>
                            <option value="نیم ۸۶">نیم ۸۶</option>
                            <option value="امامی ۸۶">امامی ۸۶</option>
                            <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                            <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                            <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                            <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                        </select>
                    </div>
                </div>

                <div class="form-group hidden" id="buyCoinPriceGroup_1">
                    <label for="buyCoinPrice_1">مبلغ سکه (تومان):</label>
                    <div class="input-wrapper">
                        <input type="text" id="buyCoinPrice_1" inputmode="numeric" oninput="formatNumberInput(this)">
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="add-item-btn" onclick="addBuyGoldItem()">+ افزودن آیتم خرید</button>

        <hr>

        <div class="section-title additional-costs-title">
            <h2>هزینه‌های اضافی</h2>
        </div>

        <div class="form-group">
            <label for="sellerProfit">سود فروشنده (%):</label>
            <div class="input-wrapper">
                <input type="number" id="sellerProfit" min="1" max="7" value="7">
            </div>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="applyTax" checked>
            <label for="applyTax">اعمال مالیات ۱۰% (از سود و اجرت)</label>
        </div>

        <hr>

        <div class="section-title discount-title">
            <h2>تخفیف</h2>
        </div>

        <div class="form-group">
            <label for="manualDiscount">تخفیف دستی (تومان):</label>
            <div class="input-wrapper">
                <input type="text" id="manualDiscount" inputmode="numeric" oninput="formatNumberInput(this)">
            </div>
        </div>

        <div class="discount-smart-box">
            <h3>تخفیف هوشمند</h3>
            <div id="smartDiscountOptions" class="smart-discount-options">
                </div>
        </div>

        <hr>

        <div class="section-title invoice-title">
            <h2>فاکتور نهایی</h2>
        </div>

        <div class="invoice-summary">
            <div id="invoiceItems">
                </div>
            <div class="invoice-item">
                <span class="label">تخفیف کل:</span>
                <span class="value discount" id="totalDiscountDisplay">0 تومان</span>
            </div>
            <div class="invoice-total">
                <span>قیمت نهایی:</span>
                <span id="finalPriceDisplay">0 تومان</span>
            </div>
        </div>

        <hr>

        <div class="section-title customer-invoice-title">
            <h2>فاکتور فروش مشتری</h2>
        </div>

        <div class="customer-invoice-section">
            <div class="form-group">
                <label for="customerName">نام خریدار:</label>
                <div class="input-wrapper">
                    <input type="text" id="customerName" oninput="validateName(this)">
                </div>
            </div>

            <div class="form-group">
                <label for="customerPhone">شماره تماس (اختیاری):</label>
                <div class="input-wrapper">
                    <input type="tel" id="customerPhone" maxlength="11" inputmode="numeric" oninput="convertToPersian(this)">
                </div>
            </div>

            <div id="customerInvoiceItems">
                </div>

            <div class="invoice-total">
                <span>قیمت کل:</span>
                <span id="customerFinalPriceDisplay">0 تومان</span>
            </div>
        </div>
    </div>

    <script>
        let goldItemCount = 1;
        let buyGoldItemCount = 1;

        const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

        // Function to convert English numbers to Persian
        function toPersianDigits(str) {
            return str.replace(/[0-9]/g, function(d) {
                return persianNumbers[parseInt(d)];
            });
        }

        // Function to convert Persian numbers to English
        function toEnglishDigits(str) {
            return str.replace(/[۰-۹]/g, function(d) {
                return englishNumbers[persianNumbers.indexOf(d)];
            });
        }

        // Function to format numbers with commas and convert to Persian
        function formatNumberWithCommasAndPersian(inputElement) {
            let value = toEnglishDigits(inputElement.value.replace(/,/g, ''));
            if (isNaN(value) || value === '') {
                inputElement.value = '';
                return '';
            }
            let formattedValue = parseFloat(value).toLocaleString('en-US');
            inputElement.value = toPersianDigits(formattedValue);
            return parseFloat(value);
        }

        // Specific formatting for Gold Price (7 digits, then commas)
        function formatAndConvertGoldPrice(input) {
            let value = input.value.replace(/,/g, ''); // Remove existing commas
            let originalCursorPos = input.selectionStart;

            // Restrict to 7 digits
            if (value.length > 7) {
                value = value.substring(0, 7);
            }

            // Add commas every three digits
            let parts = [];
            for (let i = value.length - 1; i >= 0; i--) {
                parts.unshift(value[i]);
                if ((value.length - 1 - i) % 3 === 2 && i !== 0) {
                    parts.unshift(',');
                }
            }
            let formattedValue = parts.join('');

            input.value = formattedValue;
            updateGoldPricePersianText(input.value);

            // Restore cursor position
            input.setSelectionRange(originalCursorPos, originalCursorPos);
            calculateFinalPrice(); // Recalculate on input change
        }

        // Function to update the Persian text representation of gold price
        function updateGoldPricePersianText(value) {
            const goldPricePersianDiv = document.getElementById('goldPricePersian');
            let cleanValue = toEnglishDigits(value.replace(/,/g, ''));
            if (!cleanValue) {
                goldPricePersianDiv.textContent = '';
                return;
            }

            const wordify = num => {
                const words = [
                    ['', 'یک', 'دو', 'سه', 'چهار', 'پنج', 'شش', 'هفت', 'هشت', 'نه'],
                    ['ده', 'یازده', 'دوازده', 'سیزده', 'چهارده', 'پانزده', 'شانزده', 'هفده', 'هجده', 'نوزده'],
                    ['', '', 'بیست', 'سی', 'چهل', 'پنجاه', 'شصت', 'هفتاد', 'هشتاد', 'نود'],
                    ['', 'صد', 'دویست', 'سیصد', 'چهارصد', 'پانصد', 'ششصد', 'هفتصد', 'هشتصد', 'نهصد'],
                    ['', 'هزار', 'میلیون', 'میلیارد', 'تریلیون']
                ];

                const numToWord = (n, level) => {
                    let str = '';
                    if (n >= 100) {
                        str += words[3][Math.floor(n / 100)] + ' و ';
                        n %= 100;
                    }
                    if (n >= 20) {
                        str += words[2][Math.floor(n / 10)];
                        n %= 10;
                        if (n > 0) str += ' و ';
                    }
                    if (n >= 10) {
                        str += words[1][n % 10];
                    } else if (n > 0) {
                        str += words[0][n];
                    }
                    return str;
                };

                let result = '';
                if (num === 0) return 'صفر';
                let i = 0;
                while (num > 0) {
                    let chunk = num % 1000;
                    if (chunk > 0) {
                        let chunkWord = numToWord(chunk, i);
                        if (i > 0) {
                            result = (chunkWord ? chunkWord + ' ' + words[4][i] : '') + (result ? ' و ' + result : '');
                        } else {
                            result = chunkWord;
                        }
                    }
                    num = Math.floor(num / 1000);
                    i++;
                }
                return result.trim();
            };

            const num = parseInt(cleanValue);
            if (isNaN(num)) {
                goldPricePersianDiv.textContent = '';
                return;
            }

            let word = wordify(num) + ' تومان';
            goldPricePersianDiv.textContent = word;

            // Adjust font size based on length
            if (word.length > 25) { // Arbitrary threshold, adjust as needed
                goldPricePersianDiv.style.fontSize = '0.75em';
            } else if (word.length > 18) {
                goldPricePersianDiv.style.fontSize = '0.85em';
            } else {
                goldPricePersianDiv.style.fontSize = '0.9em'; // Default
            }
        }

        // Function to convert English numbers in input to Persian
        function convertToPersian(input) {
            let value = input.value;
            input.value = toPersianDigits(value.replace(/[^0-9.]/g, '')); // Allow only numbers and dot
            calculateFinalPrice(); // Recalculate on input change
        }

        // Format for general number inputs (e.g., manual discount, coin price)
        function formatNumberInput(input) {
            formatNumberWithCommasAndPersian(input);
            calculateFinalPrice();
        }

        // Wage input formatting (percentage or amount)
        function formatWageInput(input) {
            const wageTypeSelect = document.getElementById(input.id.replace('wage_', 'wageType_'));
            let value = toEnglishDigits(input.value.replace(/,/g, ''));

            if (wageTypeSelect.value === '%') {
                // Percentage: 1 to 30
                if (value !== '') {
                    value = parseFloat(value);
                    if (isNaN(value)) value = '';
                    if (value < 1) value = 1;
                    if (value > 30) value = 30;
                }
            } else {
                // Amount: max 7 digits
                if (value.length > 7) {
                    value = value.substring(0, 7);
                }
                // Add commas
                let parts = [];
                for (let i = value.length - 1; i >= 0; i--) {
                    parts.unshift(value[i]);
                    if ((value.length - 1 - i) % 3 === 2 && i !== 0) {
                        parts.unshift(',');
                    }
                }
                value = parts.join('');
            }
            input.value = toPersianDigits(value.toString());
            calculateFinalPrice();
        }

        // Update wage input placeholder based on type selected
        function updateWagePlaceholder(select) {
            const inputId = select.id.replace('wageType_', 'wage_');
            const input = document.getElementById(inputId);
            if (select.value === '%') {
                input.placeholder = 'درصد (۱ تا ۳۰)';
            } else {
                input.placeholder = 'مبلغ (حداکثر ۷ رقم)';
            }
            // Trigger re-validation/re-formatting if there's an existing value
            if (input.value) {
                formatWageInput(input);
            }
        }

        // Initialize placeholders for existing wage fields
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('select[id^="wageType_"]').forEach(select => {
                updateWagePlaceholder(select);
            });
            calculateFinalPrice();
        });


        // Add/Remove Gold Items
        function addGoldItem() {
            goldItemCount++;
            const container = document.getElementById('goldItemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'gold-item';
            newItem.id = `goldItem_${goldItemCount}`;
            newItem.innerHTML = `
                <button type="button" class="remove-item-btn" onclick="removeItem('goldItem_${goldItemCount}')">×</button>
                <div class="form-group">
                    <label for="goldWeight_${goldItemCount}">وزن طلا (گرم):</label>
                    <div class="input-wrapper">
                        <input type="text" id="goldWeight_${goldItemCount}" inputmode="decimal" oninput="convertToPersian(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="goldModel_${goldItemCount}">مدل طلا:</label>
                    <div class="input-wrapper">
                        <select id="goldModel_${goldItemCount}">
                            <option value="سرویس">سرویس</option>
                            <option value="النگو">النگو</option>
                            <option value="نیم‌ست">نیم‌ست</option>
                            <option value="دستبند">دستبند</option>
                            <option value="زنجیر">زنجیر</option>
                            <option value="گردنبند">گردنبند</option>
                            <option value="گوشواره">گوشواره</option>
                            <option value="مدال">مدال</option>
                            <option value="پلاک">پلاک</option>
                            <option value="خلخال">خلخال</option>
                            <option value="آویز ساعت">آویز ساعت</option>
                            <option value="رو لباسی">رو لباسی</option>
                            <option value="سفارشی">سفارشی</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="wage_${goldItemCount}">اجرت:</label>
                    <div class="input-wrapper">
                        <input type="text" id="wage_${goldItemCount}" inputmode="decimal" oninput="formatWageInput(this)">
                        <select id="wageType_${goldItemCount}" onchange="updateWagePlaceholder(this)">
                            <option value="%">%</option>
                            <option value="$">تومان</option>
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(newItem);
            updateWagePlaceholder(document.getElementById(`wageType_${goldItemCount}`)); // Set placeholder for new item
            calculateFinalPrice();
        }

        // Add/Remove Buy Gold Items
        function addBuyGoldItem() {
            buyGoldItemCount++;
            const container = document.getElementById('buyGoldItemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'gold-item';
            newItem.id = `buyGoldItem_${buyGoldItemCount}`;
            newItem.innerHTML = `
                <button type="button" class="remove-item-btn" onclick="removeItem('buyGoldItem_${buyGoldItemCount}')">×</button>
                <div class="form-group">
                    <label for="buyGoldType_${buyGoldItemCount}">نوع خرید:</label>
                    <div class="input-wrapper">
                        <select id="buyGoldType_${buyGoldItemCount}" onchange="toggleBuyGoldFields(this)">
                            <option value="">انتخاب کنید...</option>
                            <option value="gold">طلا</option>
                            <option value="ingot">شمش</option>
                            <option value="parsian">سکه پارسیان</option>
                            <option value="coin">سکه</option>
                        </select>
                    </div>
                </div>

                <div class="form-group hidden" id="buyGoldWeightGroup_${buyGoldItemCount}">
                    <label for="buyGoldWeight_${buyGoldItemCount}">وزن (گرم):</label>
                    <div class="input-wrapper">
                        <input type="text" id="buyGoldWeight_${buyGoldItemCount}" inputmode="decimal" oninput="convertToPersian(this)">
                    </div>
                </div>

                <div class="form-group hidden" id="buyCoinModelGroup_${buyGoldItemCount}">
                    <label for="buyCoinModel_${buyGoldItemCount}">مدل سکه:</label>
                    <div class="input-wrapper">
                        <select id="buyCoinModel_${buyGoldItemCount}">
                            <option value="ربع ۸۶">ربع ۸۶</option>
                            <option value="نیم ۸۶">نیم ۸۶</option>
                            <option value="امامی ۸۶">امامی ۸۶</option>
                            <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                            <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                            <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                            <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                        </select>
                    </div>
                </div>

                <div class="form-group hidden" id="buyCoinPriceGroup_${buyGoldItemCount}">
                    <label for="buyCoinPrice_${buyGoldItemCount}">مبلغ سکه (تومان):</label>
                    <div class="input-wrapper">
                        <input type="text" id="buyCoinPrice_${buyGoldItemCount}" inputmode="numeric" oninput="formatNumberInput(this)">
                    </div>
                </div>
            `;
            container.appendChild(newItem);
            calculateFinalPrice();
        }

        function removeItem(itemId) {
            const item = document.getElementById(itemId);
            if (item) {
                item.remove();
            }
            calculateFinalPrice();
        }

        function toggleBuyGoldFields(selectElement) {
            const itemId = selectElement.id.split('_')[1];
            const weightGroup = document.getElementById(`buyGoldWeightGroup_${itemId}`);
            const coinModelGroup = document.getElementById(`buyCoinModelGroup_${itemId}`);
            const coinPriceGroup = document.getElementById(`buyCoinPriceGroup_${itemId}`);

            // Hide all by default
            weightGroup.classList.add('hidden');
            coinModelGroup.classList.add('hidden');
            coinPriceGroup.classList.add('hidden');

            switch (selectElement.value) {
                case 'gold':
                case 'ingot':
                case 'parsian':
                    weightGroup.classList.remove('hidden');
                    break;
                case 'coin':
                    coinModelGroup.classList.remove('hidden');
                    coinPriceGroup.classList.remove('hidden');
                    break;
            }
            calculateFinalPrice();
        }

        // Calculation Logic
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('input', calculateFinalPrice);
            element.addEventListener('change', calculateFinalPrice);
        });

        function calculateFinalPrice() {
            const goldPriceInput = document.getElementById('goldPrice');
            const goldPricePerGram = parseFloat(toEnglishDigits(goldPriceInput.value.replace(/,/g, '')));
            const sellerProfitPercentage = parseFloat(document.getElementById('sellerProfit').value) || 0;
            const applyTax = document.getElementById('applyTax').checked;
            const manualDiscount = parseFloat(toEnglishDigits(document.getElementById('manualDiscount').value.replace(/,/g, ''))) || 0;

            let totalGoldItemsPrice = 0;
            let totalBuyItemsPrice = 0;
            let totalWage = 0;
            let totalProfit = 0;
            let totalTax = 0;
            let totalDiscount = 0;

            const invoiceItems = [];
            const customerInvoiceItems = [];

            // --- Calculate for Gold Items ---
            for (let i = 1; i <= goldItemCount; i++) {
                const weightInput = document.getElementById(`goldWeight_${i}`);
                const modelSelect = document.getElementById(`goldModel_${i}`);
                const wageInput = document.getElementById(`wage_${i}`);
                const wageTypeSelect = document.getElementById(`wageType_${i}`);

                if (!weightInput || !modelSelect || !wageInput || !wageTypeSelect) continue;

                const weight = parseFloat(toEnglishDigits(weightInput.value)) || 0;
                const model = modelSelect.value;
                let wageValue = parseFloat(toEnglishDigits(wageInput.value.replace(/,/g, ''))) || 0;
                const wageType = wageTypeSelect.value;

                if (weight === 0 && wageValue === 0) continue; // Skip empty rows

                let itemWage = 0;
                if (wageType === '%') {
                    itemWage = (weight * goldPricePerGram) * (wageValue / 100);
                } else {
                    itemWage = wageValue;
                }
                totalWage += itemWage;

                const itemBasePrice = weight * goldPricePerGram;
                const itemProfit = itemBasePrice * (sellerProfitPercentage / 100);
                totalProfit += itemProfit;

                const itemPrice = itemBasePrice + itemWage + itemProfit;
                totalGoldItemsPrice += itemPrice;

                let itemTax = 0;
                if (applyTax) {
                    itemTax = (itemProfit + itemWage) * 0.10;
                    totalTax += itemTax;
                }

                invoiceItems.push({
                    type: model || 'طلا',
                    wage: itemWage,
                    tax: itemTax,
                    price: itemPrice + itemTax,
                    weight: weight,
                    profit: itemProfit // Store for customer invoice
                });
            }

            // --- Calculate for Buy Gold Items ---
            for (let i = 1; i <= buyGoldItemCount; i++) {
                const buyTypeSelect = document.getElementById(`buyGoldType_${i}`);
                const buyWeightInput = document.getElementById(`buyGoldWeight_${i}`);
                const buyCoinModelSelect = document.getElementById(`buyCoinModel_${i}`);
                const buyCoinPriceInput = document.getElementById(`buyCoinPrice_${i}`);

                if (!buyTypeSelect) continue;

                const buyType = buyTypeSelect.value;
                let itemBuyPrice = 0;
                let itemWeight = 0; // Initialize for customer invoice
                let itemModel = ''; // Initialize for customer invoice

                switch (buyType) {
                    case 'gold':
                        itemWeight = parseFloat(toEnglishDigits(buyWeightInput.value)) || 0;
                        itemBuyPrice = itemWeight * goldPricePerGram;
                        itemModel = 'طلای آب شده';
                        break;
                    case 'ingot':
                        itemWeight = parseFloat(toEnglishDigits(buyWeightInput.value)) || 0;
                        itemBuyPrice = (itemWeight * 995 / 750) * goldPricePerGram;
                        itemModel = 'شمش';
                        break;
                    case 'parsian':
                        itemWeight = parseFloat(toEnglishDigits(buyWeightInput.value)) || 0;
                        itemBuyPrice = itemWeight * goldPricePerGram;
                        itemModel = 'سکه پارسیان';
                        break;
                    case 'coin':
                        itemBuyPrice = parseFloat(toEnglishDigits(buyCoinPriceInput.value.replace(/,/g, ''))) || 0;
                        itemModel = buyCoinModelSelect.value;
                        // No weight for coins here as price is manual
                        break;
                }
                totalBuyItemsPrice += itemBuyPrice;

                if (itemBuyPrice > 0) {
                    customerInvoiceItems.push({
                        type: `خرید ${itemModel}`,
                        weight: itemWeight,
                        price: itemBuyPrice,
                        wage: 0, // No wage for bought items
                        tax: 0,   // No tax for bought items
                        profit: 0 // No profit for bought items
                    });
                }
            }

            let totalCalculatedPrice = totalGoldItemsPrice + totalBuyItemsPrice;

            // Smart Discount Logic
            let smartDiscountAmount = 0;
            const currentSelectedSmartDiscount = document.querySelector('.smart-discount-btn.active');
            if (currentSelectedSmartDiscount) {
                smartDiscountAmount = parseFloat(toEnglishDigits(currentSelectedSmartDiscount.dataset.value.replace(/,/g, ''))) || 0;
                totalDiscount = smartDiscountAmount;
            } else {
                totalDiscount = manualDiscount;
            }

            const finalPrice = totalCalculatedPrice + totalTax - totalDiscount;

            // --- Update Invoice Summary ---
            const invoiceItemsDiv = document.getElementById('invoiceItems');
            invoiceItemsDiv.innerHTML = '';
            let totalCalculatedBeforeDiscount = 0;

            invoiceItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'invoice-item';
                itemDiv.innerHTML = `
                    <span class="label">${item.type}:</span>
                    <span class="value">${toPersianDigits(item.price.toLocaleString())} تومان</span>
                `;
                invoiceItemsDiv.appendChild(itemDiv);
                totalCalculatedBeforeDiscount += item.price;
            });

            // Add total for purchased items if any
            if (totalBuyItemsPrice > 0) {
                const buyItemDiv = document.createElement('div');
                buyItemDiv.className = 'invoice-item';
                buyItemDiv.innerHTML = `
                    <span class="label">جمع خرید طلا/سکه:</span>
                    <span class="value">${toPersianDigits(totalBuyItemsPrice.toLocaleString())} تومان</span>
                `;
                invoiceItemsDiv.appendChild(buyItemDiv);
                totalCalculatedBeforeDiscount += totalBuyItemsPrice;
            }

            if (totalWage > 0) {
                const wageDiv = document.createElement('div');
                wageDiv.className = 'invoice-item';
                wageDiv.innerHTML = `
                    <span class="label">اجرت:</span>
                    <span class="value">${toPersianDigits(totalWage.toLocaleString())} تومان</span>
                `;
                invoiceItemsDiv.appendChild(wageDiv);
            }

            if (applyTax && totalTax > 0) {
                const taxDiv = document.createElement('div');
                taxDiv.className = 'invoice-item';
                taxDiv.innerHTML = `
                    <span class="label">مالیات:</span>
                    <span class="value">${toPersianDigits(totalTax.toLocaleString())} تومان</span>
                `;
                invoiceItemsDiv.appendChild(taxDiv);
            }


            document.getElementById('totalDiscountDisplay').textContent = `${toPersianDigits(totalDiscount.toLocaleString())} تومان`;
            document.getElementById('finalPriceDisplay').textContent = `${toPersianDigits(Math.round(finalPrice).toLocaleString())} تومان`;


            // --- Update Customer Invoice ---
            const customerInvoiceItemsDiv = document.getElementById('customerInvoiceItems');
            customerInvoiceItemsDiv.innerHTML = '';

            invoiceItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'invoice-item';
                itemDiv.innerHTML = `
                    <div style="flex:1;"><span class="label">مدل طلا:</span> <span class="value">${item.type}</span></div>
                    <div style="flex:1;"><span class="label">وزن:</span> <span class="value">${toPersianDigits(item.weight)} گرم</span></div>
                    <div style="flex:1;"><span class="label">قیمت:</span> <span class="value">${toPersianDigits(item.price.toLocaleString())} تومان</span></div>
                `;
                if (item.wage > 0) {
                    itemDiv.innerHTML += `<div style="flex:1;"><span class="label">اجرت:</span> <span class="value">${toPersianDigits(item.wage.toLocaleString())} تومان</span></div>`;
                }
                if (applyTax && item.tax > 0) {
                    itemDiv.innerHTML += `<div style="flex:1;"><span class="label">مالیات:</span> <span class="value">${toPersianDigits(item.tax.toLocaleString())} تومان</span></div>`;
                }
                customerInvoiceItemsDiv.appendChild(itemDiv);
            });

            customerInvoiceItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'invoice-item';
                itemDiv.innerHTML = `
                    <div style="flex:1;"><span class="label">مدل طلا:</span> <span class="value">${item.type}</span></div>
                    ${item.weight > 0 ? `<div style="flex:1;"><span class="label">وزن:</span> <span class="value">${toPersianDigits(item.weight)} گرم</span></div>` : ''}
                    <div style="flex:1;"><span class="label">قیمت:</span> <span class="value">${toPersianDigits(item.price.toLocaleString())} تومان</span></div>
                `;
                customerInvoiceItemsDiv.appendChild(itemDiv);
            });

            if (totalDiscount > 0) {
                const discountDiv = document.createElement('div');
                discountDiv.className = 'invoice-item';
                discountDiv.innerHTML = `
                    <span class="label">تخفیف:</span>
                    <span class="value discount">${toPersianDigits(totalDiscount.toLocaleString())} تومان</span>
                `;
                customerInvoiceItemsDiv.appendChild(discountDiv);
            }

            document.getElementById('customerFinalPriceDisplay').textContent = `${toPersianDigits(Math.round(finalPrice).toLocaleString())} تومان`;

            updateSmartDiscountOptions(finalPrice + totalDiscount); // Pass current total including discount for smart discount calculation
        }

        // Smart Discount Generation
        let activeSmartDiscountButton = null;

        function updateSmartDiscountOptions(currentTotal) {
            const smartDiscountOptionsDiv = document.getElementById('smartDiscountOptions');
            smartDiscountOptionsDiv.innerHTML = '';

            if (currentTotal <= 0 || isNaN(currentTotal)) {
                return;
            }

            const options = [];
            const strTotal = Math.round(currentTotal).toString();
            let len = strTotal.length;

            if (len >= 3) {
                // Option 1: Round to nearest 1000 (XXX000)
                let option1 = Math.floor(currentTotal / 1000) * 1000;
                if (option1 < currentTotal) options.push(option1);

                // Option 2: Round to nearest 5000 (XX5000 or XX0000)
                let option2 = Math.round(currentTotal / 5000) * 5000;
                if (option2 > currentTotal && options.indexOf(option2) === -1) options.push(option2);
                else { // If rounding up passed it, round down to nearest 5000
                    option2 = Math.floor(currentTotal / 5000) * 5000;
                    if (option2 < currentTotal && options.indexOf(option2) === -1) options.push(option2);
                }


                // Option 3: Round to nearest 10000 (X00000)
                let option3 = Math.floor(currentTotal / 10000) * 10000;
                if (option3 < currentTotal && options.indexOf(option3) === -1) options.push(option3);

                // Option 4: Round to nearest 50000 (X50000 or X00000)
                let option4 = Math.floor(currentTotal / 50000) * 50000;
                if (option4 < currentTotal && options.indexOf(option4) === -1) options.push(option4);
            }

            // Ensure unique and sort in descending order
            const uniqueOptions = [...new Set(options)].filter(opt => opt >= 0).sort((a, b) => b - a);

            uniqueOptions.forEach(optionValue => {
                const discountAmount = currentTotal - optionValue;
                if (discountAmount > 0) {
                    const button = document.createElement('button');
                    button.className = 'smart-discount-btn';
                    button.textContent = `${toPersianDigits(optionValue.toLocaleString())} (${toPersianDigits(Math.round(discountAmount).toLocaleString())} تخفیف)`;
                    button.dataset.value = Math.round(discountAmount); // Store actual discount value

                    button.onclick = () => {
                        if (activeSmartDiscountButton === button) {
                            // Deactivate if already active
                            button.classList.remove('active');
                            activeSmartDiscountButton = null;
                            document.getElementById('manualDiscount').value = ''; // Clear manual discount
                        } else {
                            // Activate new button
                            if (activeSmartDiscountButton) {
                                activeSmartDiscountButton.classList.remove('active');
                            }
                            button.classList.add('active');
                            activeSmartDiscountButton = button;
                            document.getElementById('manualDiscount').value = toPersianDigits(Math.round(discountAmount).toLocaleString());
                        }
                        calculateFinalPrice();
                    };
                    smartDiscountOptionsDiv.appendChild(button);
                }
            });
        }

        // Initial calculations and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('goldPrice').addEventListener('input', () => {
                formatAndConvertGoldPrice(document.getElementById('goldPrice'));
                calculateFinalPrice();
            });

            document.getElementById('sellerProfit').addEventListener('input', calculateFinalPrice);
            document.getElementById('applyTax').addEventListener('change', calculateFinalPrice);
            document.getElementById('manualDiscount').addEventListener('input', (event) => {
                formatNumberInput(event.target);
                // Deactivate smart discount if manual discount is entered
                if (activeSmartDiscountButton) {
                    activeSmartDiscountButton.classList.remove('active');
                    activeSmartDiscountButton = null;
                }
                calculateFinalPrice();
            });

            // Add event listeners for dynamically added gold items
            document.getElementById('goldItemsContainer').addEventListener('input', (event) => {
                if (event.target.id.startsWith('goldWeight_') || event.target.id.startsWith('wage_')) {
                    calculateFinalPrice();
                }
            });
            document.getElementById('goldItemsContainer').addEventListener('change', (event) => {
                if (event.target.id.startsWith('goldModel_') || event.target.id.startsWith('wageType_')) {
                    calculateFinalPrice();
                }
            });

            // Add event listeners for dynamically added buy gold items
            document.getElementById('buyGoldItemsContainer').addEventListener('input', (event) => {
                if (event.target.id.startsWith('buyGoldWeight_') || event.target.id.startsWith('buyCoinPrice_')) {
                    calculateFinalPrice();
                }
            });
            document.getElementById('buyGoldItemsContainer').addEventListener('change', (event) => {
                if (event.target.id.startsWith('buyGoldType_') || event.target.id.startsWith('buyCoinModel_')) {
                    calculateFinalPrice();
                }
            });

            // Validate customer name (only Persian letters)
            document.getElementById('customerName').addEventListener('input', function() {
                this.value = this.value.replace(/[^ابپتثجچحخدذرزژسشصضطظعغفقکگلمنوهیئأؤءآ‌ ]/g, ''); // Allow Persian letters and space
            });

            // Initial calculation
            calculateFinalPrice();
        });
    </script>
</body>
</html>
