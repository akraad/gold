<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاکتور طلا</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-Variable.css" rel="stylesheet" type="text/css" />
    <style>
        /* Fallback and additional font-face rule for Vazirmatn */
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Light.woff2') format('woff2');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-SemiBold.woff2') format('woff2');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }


        /* General Styles */
        body {
            font-family: 'Vazirmatn', sans-serif !important; /* Ensure Vazirmatn is applied */
            margin: 0;
            padding: 0;
            background-color: #f8f8f8; /* Very light gray background */
            color: #333;
            direction: rtl; /* Right-to-left for RTL languages */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 700px; /* Adjusted max-width for better compactness */
            background-color: #fff;
            padding: 25px;
            margin: 20px auto; /* Centered with auto margins */
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        /* Header */
        h1 {
            background-color: #2196F3; /* Blue color for header */
            color: white;
            padding: 15px 0;
            margin: -25px -25px 25px -25px; /* Adjust margin to extend full width */
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            text-align: center;
            font-size: 1.8em;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #2196F3 0%, #4CAF50 100%); /* Blue to Green Gradient */
        }

        h2 {
            font-size: 1.5em;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #3f51b5; /* Blue for section titles */
        }

        .section-title {
            font-size: 1.4em;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        .section-title.gold { color: #f9a825; /* Gold/Orange */ }
        .section-title.purchase { color: #8e24aa; /* Purple */ }
        .section-title.discount { color: #d32f2f; /* Red */ }
        .section-title.smart-discount { color: #4CAF50; /* Green */ }
        .section-title.invoice { color: #2196F3; /* Blue */ }
        .section-title.customer { color: #1e88e5; /* Darker blue */ }


        .form-group {
            margin-bottom: 15px; /* Reduced margin-bottom */
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.9em; /* Slightly smaller label font */
            margin-bottom: 6px; /* Reduced margin-bottom */
            color: #555;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: calc(100% - 20px); /* Account for padding */
            padding: 10px; /* Reduced padding */
            border: 1px solid #ddd;
            border-radius: 6px; /* Slightly smaller border-radius */
            font-size: 1em;
            color: #333;
            background-color: #fdfdfd;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Vazirmatn', sans-serif !important; /* Apply Vazirmatn to inputs */
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus {
            border-color: #64b5f6; /* Light blue on focus */
            box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.3);
            outline: none;
        }

        .input-with-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-with-text input {
            flex-grow: 1; /* Input takes available space */
        }

        .input-with-text .text-display {
            background-color: #e8f5e9; /* Light green background */
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            padding: 10px; /* Reduced padding */
            flex-grow: 1;
            text-align: center;
            font-size: 1em;
            color: #2e7d32; /* Dark green text */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0; /* Allow text to shrink */
            font-family: 'Vazirmatn', sans-serif !important; /* Apply Vazirmatn */
        }
        .input-with-text .text-display.small-font {
            font-size: 0.8em; /* Smaller font for long text */
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 8px; /* Space between checkbox and label */
            transform: scale(1.1); /* Slightly larger checkbox */
        }

        /* Radio button styling for Wage */
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 0; /* Override form-group label margin */
        }
        .radio-group input[type="radio"] {
            margin-left: 5px;
            transform: scale(1.1);
        }


        .add-item-btn {
            background-color: #4CAF50; /* Green add button */
            color: white;
            padding: 8px 12px; /* Smaller padding */
            border: none;
            border-radius: 20px; /* Pill shape */
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 10px;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 5px; /* Space between icon and text */
        }
        .add-item-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        .add-item-btn:hover {
            background-color: #43A047; /* Darker green on hover */
            transform: translateY(-1px);
        }

        .smart-discount-box {
            background-color: #e8f5e9; /* Light green for smart discount */
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 15px; /* Reduced padding */
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Reduced gap */
            justify-content: center;
            align-items: center;
        }

        .smart-discount-option {
            background-color: #66BB6A; /* Lighter green option button */
            color: white;
            padding: 10px 15px; /* Reduced padding */
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            flex-basis: calc(50% - 10px); /* Two items per row on larger screens */
            text-align: center;
            box-sizing: border-box; /* Include padding in width */
        }
        @media (max-width: 600px) {
            .smart-discount-option {
                flex-basis: 100%; /* One item per row on smaller screens */
            }
        }

        .smart-discount-option:hover {
            background-color: #4CAF50; /* Darker green on hover */
            transform: translateY(-2px);
        }

        .smart-discount-option.active {
            background-color: #2E7D32; /* Even darker green when active */
            border: 2px solid #A5D6A7;
        }

        .invoice-summary {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 7px 0; /* Reduced padding */
            border-bottom: 1px dotted #eee;
            font-size: 0.95em; /* Slightly smaller font */
        }

        .invoice-item:last-of-type {
            border-bottom: none;
        }

        .invoice-item .label {
            color: #666;
        }

        .invoice-item .value {
            font-weight: 500;
            color: #333;
            font-family: 'Vazirmatn', sans-serif !important; /* Apply Vazirmatn */
        }

        .invoice-item .value.discount {
            color: #d32f2f; /* Red for discount */
            font-weight: bold;
        }

        .total-price {
            margin-top: 20px;
            font-size: 1.5em; /* Slightly smaller font */
            font-weight: bold;
            color: #2196F3; /* Blue for total price */
            text-align: left;
            padding-top: 15px;
            border-top: 2px solid #ccc;
        }

        /* Customer Invoice Section */
        .customer-invoice-section {
            background-color: #e3f2fd; /* Light blue background for customer invoice */
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 20px;
            line-height: 1.8; /* More spacing for readability */
            font-size: 0.98em;
            color: #3f51b5; /* Darker blue text */
        }
        .customer-invoice-section p {
            margin: 0;
            padding: 3px 0;
        }
        .customer-invoice-section strong {
            color: #1e88e5; /* Stronger blue for bold text */
        }
        .customer-invoice-section .discount-text {
            color: #d32f2f; /* Red for discount in customer invoice */
            font-weight: bold;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            h1 {
                font-size: 1.6em;
                margin: -15px -15px 15px -15px;
            }
            h2, .section-title {
                font-size: 1.3em;
            }
            .form-group input, .form-group select, .input-with-text .text-display {
                padding: 8px;
            }
            .smart-discount-option {
                font-size: 0.9em;
                padding: 8px 12px;
            }
        }

        /* Horizontal lines for sections */
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 30px 0;
        }

        /* Compact purchase section */
        .purchase-item-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Spacing between purchase items */
            margin-bottom: 15px;
        }

        .purchase-item-group .form-group {
            flex: 1 1 calc(50% - 15px); /* Two items per row */
            min-width: 250px; /* Minimum width before wrapping */
        }

        @media (max-width: 600px) {
            .purchase-item-group .form-group {
                flex: 1 1 100%; /* One item per row on small screens */
            }
        }
        .coin-item .form-group { /* Specific styling for coin price input */
            margin-top: 5px;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>فاکتور طلافروشی</h1>

        <div class="section-title gold">محاسبه قیمت طلا</div>
        <div class="form-group">
            <label for="goldPrice">قیمت طلا ۱۸ عیار (تومان):</label>
            <div class="input-with-text">
                <input type="text" id="goldPrice" inputmode="numeric" pattern="[0-9]*">
                <div class="text-display" id="goldPriceText"></div>
            </div>
        </div>

        <div id="goldItemsContainer">
            <div class="gold-item" data-id="1">
                <hr>
                <div class="form-group">
                    <label for="goldWeight_1">وزن طلا (گرم):</label>
                    <input type="text" id="goldWeight_1" class="persian-num-input">
                </div>
                <div class="form-group">
                    <label for="goldModel_1">مدل طلا:</label>
                    <select id="goldModel_1">
                        <option value="">انتخاب کنید</option>
                        <option value="سرویس">سرویس</option>
                        <option value="النگو">النگو</option>
                        <option value="نیم‌ست">نیم‌ست</option>
                        <option value="دستبند">دستبند</option>
                        <option value="زنجیر">زنجیر</option>
                        <option value="گردنبند">گردنبند</option>
                        <option value="گوشواره">گوشواره</option>
                        <option value="مدال">مدال</option>
                        <option value="پلاک">پلاک</option>
                        <option value="خلخال">خلخال</option>
                        <option value="آویز ساعت">آویز ساعت</option>
                        <option value="رو لباسی">رو لباسی</option>
                        <option value="سفارشی">سفارشی</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="wage_1">اجرت:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="wageType_1" value="percent" checked> %
                        </label>
                        <label>
                            <input type="radio" name="wageType_1" value="toman"> تومان
                        </label>
                    </div>
                    <input type="text" id="wage_1" class="persian-num-input" placeholder="مقدار اجرت">
                </div>
            </div>
        </div>
        <button class="add-item-btn" id="addGoldItem">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4c-.55 0-1 .45-1 1v6H5c-.55 0-1 .45-1 1s.45 1 1 1h6v6c0 .55.45 1 1 1s1-.45 1-1v-6h6c.55 0 1-.45 1-1s-.45-1-1-1h-6V5c0-.55-.45-1-1-1z"/></svg>
            افزودن طلای جدید
        </button>

        <div class="form-group">
            <label for="profitPercentage">سود فروشنده:</label>
            <select id="profitPercentage">
                <option value="1">1%</option>
                <option value="2">2%</option>
                <option value="3">3%</option>
                <option value="4">4%</option>
                <option value="5">5%</option>
                <option value="6">6%</option>
                <option value="7" selected>7%</option>
            </select>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="taxToggle" checked>
            <label for="taxToggle">مالیات (10%)</label>
        </div>

        <hr>

        <div class="section-title purchase">بخش خرید</div>
        <div class="purchase-item-group">
            <div class="form-group">
                <label for="purchaseGoldWeight">خرید طلا (وزن):</label>
                <input type="text" id="purchaseGoldWeight" class="persian-num-input">
            </div>

            <div class="form-group">
                <label for="purchaseIngotWeight">خرید شمش (وزن):</label>
                <input type="text" id="purchaseIngotWeight" class="persian-num-input">
            </div>

            <div class="form-group">
                <label for="purchaseParsianWeight">خرید پارسیان (وزن):</label>
                <input type="text" id="purchaseParsianWeight" class="persian-num-input">
            </div>
        </div>

        <div id="coinPurchaseContainer">
            <div class="coin-item" data-id="1">
                <div class="form-group">
                    <label for="purchaseCoinModel_1">خرید سکه:</label>
                    <select id="purchaseCoinModel_1">
                        <option value="">انتخاب کنید</option>
                        <option value="ربع ۸۶">ربع ۸۶</option>
                        <option value="نیم ۸۶">نیم ۸۶</option>
                        <option value="امامی ۸۶">امامی ۸۶</option>
                        <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                        <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                        <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                        <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="purchaseCoinPrice_1">مبلغ سکه:</label>
                    <input type="text" id="purchaseCoinPrice_1" class="persian-num-input persian-num-comma"> </div>
            </div>
        </div>
        <button class="add-item-btn" id="addCoinItem">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4c-.55 0-1 .45-1 1v6H5c-.55 0-1 .45-1 1s.45 1 1 1h6v6c0 .55.45 1 1 1s1-.45 1-1v-6h6c.55 0 1-.45 1-1s-.45-1-1-1h-6V5c0-.55-.45-1-1-1z"/></svg>
            افزودن سکه جدید
        </button>

        <hr>

        <div class="section-title discount">باکس تخفیف</div>
        <div class="form-group">
            <label for="discountAmount">مبلغ تخفیف (تومان):</label>
            <input type="text" id="discountAmount" class="persian-num-input persian-num-comma">
        </div>

        <hr>

        <div class="section-title smart-discount">تخفیف هوشمند</div>
        <div class="smart-discount-box" id="smartDiscountOptions">
            </div>

        <hr>

        <div class="section-title invoice">فاکتور</div>
        <div class="invoice-summary">
            <div id="invoiceDetails">
                </div>
            <div class="invoice-item total-price">
                <span class="label">قیمت نهایی:</span>
                <span class="value" id="finalPrice">۰ تومان</span>
            </div>
        </div>

        <hr>

        <div class="section-title customer">فاکتور فروش مشتری</div>
        <div class="customer-invoice-section">
            <p><strong>نام خریدار:</strong> <span id="customerNameDisplay"></span></p>
            <p><strong>شماره تماس:</strong> <span id="customerPhoneDisplay"></span></p>
            <p><strong>تعداد طلا خریداری شده:</strong> <span id="customerPurchasedGoldCountDisplay"></span></p>
            <p><strong>مدل اولین طلا:</strong> <span id="customerGoldModelDisplay"></span></p>
            <p><strong>وزن اولین طلا:</strong> <span id="customerWeightDisplay"></span> گرم</p>
            <p><strong>قیمت پایه طلا:</strong> <span id="customerBaseGoldPriceDisplay"></span></p>
            <p><strong>جمع اجرت:</strong> <span id="customerWageDisplay"></span></p>
            <p><strong>جمع مالیات:</strong> <span id="customerTaxDisplay"></span></p>
            <p><strong>تخفیف کلی:</strong> <span id="customerDiscountDisplay" class="discount-text"></span></p>
            <p><strong>قیمت کل فاکتور:</strong> <span id="customerTotalPriceDisplay"></span></p>
        </div>

    </div>

    <script>
        // Utility Functions
        const toPersianDigits = (num) => {
            if (num === null || num === undefined || num === '') return '';
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return String(num).replace(/\d/g, digit => persianDigits[digit]);
        };

        const toEnglishDigits = (str) => {
            if (str === null || str === undefined || str === '') return '';
            const persianDigitsMap = {
                '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4', '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
            };
            return String(str).replace(/[۰-۹]/g, digit => persianDigitsMap[digit]);
        };

        const formatNumberWithCommas = (num) => {
            const numStr = String(num);
            if (numStr.includes('.')) {
                const parts = numStr.split('.');
                return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + '.' + parts[1];
            }
            return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        const numberToWords = (num) => {
            if (num === 0) return "صفر";
            if (num === null || num === undefined || num === '') return '';
            const units = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
            const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
            const tens = ["", "ده", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
            const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
            const largeUnits = ["", "هزار", "میلیون", "میلیارد", "تریلیون"];

            const convertChunk = (n) => {
                let s = "";
                const h = Math.floor(n / 100);
                const t = n % 100;

                if (h > 0) s += hundreds[h] + " ";
                if (t >= 10 && t <= 19) s += teens[t - 10] + " ";
                else {
                    if (tens[Math.floor(t / 10)]) s += tens[Math.floor(t / 10)] + " ";
                    if (units[t % 10]) s += units[t % 10] + " ";
                }
                return s.trim();
            };

            let words = [];
            let chunkCount = 0;

            if (num < 0) {
                words.push("منفی");
                num = Math.abs(num);
            }

            if (num === 0) return "صفر";

            let numStr = String(num);
            // Pad with leading zeros to make length a multiple of 3
            while (numStr.length % 3 !== 0 && numStr.length > 0) { // Check length > 0
                numStr = '0' + numStr;
            }

            for (let i = numStr.length; i > 0; i -= 3) {
                const chunk = parseInt(numStr.substring(i - 3, i), 10);
                if (chunk > 0) {
                    let chunkWords = convertChunk(chunk);
                    if (largeUnits[chunkCount]) chunkWords += " " + largeUnits[chunkCount];
                    words.unshift(chunkWords);
                }
                chunkCount++;
            }
            return words.filter(word => word.trim() !== "").join(" و ").trim();
        };


        // Element References
        const goldPriceInput = document.getElementById('goldPrice');
        const goldPriceTextDisplay = document.getElementById('goldPriceText');
        const goldItemsContainer = document.getElementById('goldItemsContainer');
        const addGoldItemBtn = document.getElementById('addGoldItem');
        const profitPercentageSelect = document.getElementById('profitPercentage');
        const taxToggle = document.getElementById('taxToggle');
        const purchaseGoldWeightInput = document.getElementById('purchaseGoldWeight');
        const purchaseIngotWeightInput = document.getElementById('purchaseIngotWeight');
        const purchaseParsianWeightInput = document.getElementById('purchaseParsianWeight');
        const coinPurchaseContainer = document.getElementById('coinPurchaseContainer');
        const addCoinItemBtn = document.getElementById('addCoinItem');
        const discountAmountInput = document.getElementById('discountAmount');
        const smartDiscountOptionsDiv = document.getElementById('smartDiscountOptions');
        const invoiceDetailsDiv = document.getElementById('invoiceDetails');
        const finalPriceSpan = document.getElementById('finalPrice');

        // Customer Invoice Elements
        // Removed direct inputs as they are now display-only
        const customerNameDisplay = document.getElementById('customerNameDisplay');
        const customerPhoneDisplay = document.getElementById('customerPhoneDisplay');
        const customerPurchasedGoldCountDisplay = document.getElementById('customerPurchasedGoldCountDisplay'); // Changed to count
        const customerGoldModelDisplay = document.getElementById('customerGoldModelDisplay');
        const customerWeightDisplay = document.getElementById('customerWeightDisplay');
        const customerBaseGoldPriceDisplay = document.getElementById('customerBaseGoldPriceDisplay'); // Changed for clarity
        const customerWageDisplay = document.getElementById('customerWageDisplay');
        const customerTaxDisplay = document.getElementById('customerTaxDisplay');
        const customerDiscountDisplay = document.getElementById('customerDiscountDisplay');
        const customerTotalPriceDisplay = document.getElementById('customerTotalPriceDisplay');

        let goldItemCount = 1;
        let coinItemCount = 1;
        let activeSmartDiscount = null; // Stores the currently active smart discount value

        // Functions for Calculations
        const calculateGoldItemPrice = (pricePerGram, weight, wageType, wageValue, profitPercent) => {
            let totalWage = 0;
            const cleanWeight = parseFloat(toEnglishDigits(weight));
            const cleanPricePerGram = parseFloat(toEnglishDigits(pricePerGram.replace(/,/g, '')));

            if (isNaN(cleanWeight) || cleanWeight <= 0) return { price: 0, wageAmount: 0, profitAmount: 0, basePrice: 0 };
            if (isNaN(cleanPricePerGram) || cleanPricePerGram <= 0) return { price: 0, wageAmount: 0, profitAmount: 0, basePrice: 0 };

            let basePrice = cleanPricePerGram * cleanWeight;

            // Calculate wage
            if (wageValue) {
                const cleanWageValue = parseFloat(toEnglishDigits(wageValue.replace(/,/g, ''))); // Ensure wageValue is clean
                if (!isNaN(cleanWageValue)) {
                    if (wageType === 'percent') {
                        if (cleanWageValue >= 0 && cleanWageValue <= 30) { // Wage can be 0%
                            totalWage = (basePrice * cleanWageValue) / 100;
                        }
                    } else if (wageType === 'toman') {
                        // Max 7 digits check for toman wage
                        if (String(Math.round(cleanWageValue)).length <= 7) { // Round for length check
                            totalWage = cleanWageValue; // Wage is total amount, not per gram here
                        }
                    }
                }
            }

            // Calculate profit
            const profitAmount = (basePrice + totalWage) * (profitPercent / 100);

            const itemTotalPrice = basePrice + totalWage + profitAmount;

            return {
                price: itemTotalPrice,
                basePrice: basePrice,
                wageAmount: totalWage,
                profitAmount: profitAmount
            };
        };

        const calculatePurchasePrices = (goldPrice) => {
            const cleanGoldPrice = parseFloat(toEnglishDigits(goldPrice.replace(/,/g, '')));
            let totalPurchasePrice = 0;

            // Gold purchase
            const goldWeight = parseFloat(toEnglishDigits(purchaseGoldWeightInput.value));
            if (!isNaN(goldWeight) && goldWeight > 0) {
                totalPurchasePrice += goldWeight * cleanGoldPrice;
            }

            // Ingot purchase
            const ingotWeight = parseFloat(toEnglishDigits(purchaseIngotWeightInput.value));
            if (!isNaN(ingotWeight) && ingotWeight > 0) {
                // Corrected ingot calculation based on standard purity conversion
                totalPurchasePrice += (ingotWeight * (18 / 24)) * cleanGoldPrice; // Assuming 995 for 24k and converting to 18k equivalent
            }

            // Parsian purchase
            const parsianWeight = parseFloat(toEnglishDigits(purchaseParsianWeightInput.value));
            if (!isNaN(parsianWeight) && parsianWeight > 0) {
                totalPurchasePrice += parsianWeight * cleanGoldPrice;
            }

            // Coin purchase
            document.querySelectorAll('.coin-item').forEach((item) => {
                const coinPriceInput = item.querySelector(`[id^="purchaseCoinPrice_"]`);
                const coinPrice = parseFloat(toEnglishDigits(coinPriceInput ? coinPriceInput.value.replace(/,/g, '') : '0'));
                if (!isNaN(coinPrice) && coinPrice > 0) {
                    totalPurchasePrice += coinPrice;
                }
            });

            return totalPurchasePrice;
        };


        const updateInvoice = () => {
            let totalGoldBasePrice = 0; // Sum of just gold price * weight
            let totalWageSum = 0;
            let totalProfitSum = 0;
            let totalTaxSum = 0;
            let overallCalculatedTotal = 0; // This will be the sum of (basePrice + wage + profit + tax)
            let manualDiscount = parseFloat(toEnglishDigits(discountAmountInput.value.replace(/,/g, ''))) || 0;
            let finalDisplayPrice = 0; // The very final price shown

            const currentGoldPrice = goldPriceInput.value;
            const profitPercent = parseFloat(profitPercentageSelect.value);
            const isTaxEnabled = taxToggle.checked;

            const invoiceItems = [];
            let goldItemCounter = 0; // To count actual gold items with price > 0

            document.querySelectorAll('.gold-item').forEach((item) => {
                const id = item.dataset.id;
                const weightInput = item.querySelector(`#goldWeight_${id}`);
                const wageInput = item.querySelector(`#wage_${id}`);
                const modelSelect = item.querySelector(`#goldModel_${id}`);
                const wageTypeRadios = item.querySelectorAll(`input[name="wageType_${id}"]`);
                let wageType = 'percent'; // Default
                wageTypeRadios.forEach(radio => {
                    if (radio.checked) wageType = radio.value;
                });

                const weight = weightInput ? weightInput.value : '0';
                const wageValue = wageInput ? wageInput.value : '0';
                const model = modelSelect ? (modelSelect.value || "طلا") : "طلا";

                const calculation = calculateGoldItemPrice(currentGoldPrice, weight, wageType, wageValue, profitPercent);

                if (calculation.price > 0) {
                    goldItemCounter++;
                    totalGoldBasePrice += calculation.basePrice;
                    totalWageSum += calculation.wageAmount;
                    totalProfitSum += calculation.profitAmount;

                    let itemTax = 0;
                    if (isTaxEnabled) {
                        itemTax = (calculation.wageAmount + calculation.profitAmount) * 0.10;
                        totalTaxSum += itemTax;
                    }

                    invoiceItems.push({
                        type: 'gold',
                        name: model,
                        weight: parseFloat(toEnglishDigits(weight)),
                        basePrice: calculation.basePrice,
                        wage: calculation.wageAmount,
                        profit: calculation.profitAmount,
                        tax: itemTax,
                        totalItemPrice: calculation.price + itemTax
                    });
                }
            });

            const purchaseTotal = calculatePurchasePrices(currentGoldPrice);
            if (purchaseTotal > 0) {
                invoiceItems.push({
                    type: 'purchase',
                    name: 'خریدها (سکه، شمش، پارسیان)',
                    price: purchaseTotal,
                    totalItemPrice: purchaseTotal
                });
            }

            // Sum up all prices for overall total BEFORE smart/manual discount
            overallCalculatedTotal = totalGoldBasePrice + totalWageSum + totalProfitSum + totalTaxSum + purchaseTotal;

            let discountApplied = 0;
            // Apply smart discount if active
            if (activeSmartDiscount !== null) {
                finalDisplayPrice = activeSmartDiscount;
                if (finalDisplayPrice < overallCalculatedTotal) {
                    discountApplied = overallCalculatedTotal - finalDisplayPrice;
                } else {
                    discountApplied = 0; // No actual discount if smart discount is higher or equal
                }
            } else {
                finalDisplayPrice = overallCalculatedTotal;
                discountApplied = manualDiscount; // Use manual discount if no smart discount active
            }

            // Ensure the final display price accounts for the discount applied
            finalDisplayPrice = overallCalculatedTotal - discountApplied;

            if (finalDisplayPrice < 0) finalDisplayPrice = 0; // Ensure price doesn't go negative


            let invoiceHtml = '';
            invoiceItems.forEach(item => {
                invoiceHtml += `
                    <div class="invoice-item">
                        <span class="label">مدل: ${item.name}</span>
                        ${item.type === 'gold' ? `<span class="value">وزن: ${toPersianDigits(formatNumberWithCommas(item.weight))} گرم</span>` : ''}
                    </div>
                    <div class="invoice-item">
                        <span class="label">قیمت پایه:</span>
                        <span class="value">${toPersianDigits(formatNumberWithCommas(Math.round(item.basePrice)))} تومان</span>
                    </div>
                `;
                if (item.wage > 0) {
                    invoiceHtml += `
                        <div class="invoice-item">
                            <span class="label">اجرت:</span>
                            <span class="value">${toPersianDigits(formatNumberWithCommas(Math.round(item.wage)))} تومان</span>
                        </div>
                    `;
                }
                if (item.profit > 0) {
                    invoiceHtml += `
                        <div class="invoice-item">
                            <span class="label">سود فروشنده:</span>
                            <span class="value">${toPersianDigits(formatNumberWithCommas(Math.round(item.profit)))} تومان</span>
                        </div>
                    `;
                }
                if (item.tax > 0 && isTaxEnabled) {
                    invoiceHtml += `
                        <div class="invoice-item">
                            <span class="label">مالیات:</span>
                            <span class="value">${toPersianDigits(formatNumberWithCommas(Math.round(item.tax)))} تومان</span>
                        </div>
                    `;
                }
                invoiceHtml += `<hr style="border-top: 1px dashed #eee; margin: 10px 0;">`;
            });

            if (discountApplied > 0) {
                invoiceHtml += `
                    <div class="invoice-item">
                        <span class="label">تخفیف:</span>
                        <span class="value discount">${toPersianDigits(formatNumberWithCommas(Math.round(discountApplied)))} تومان</span>
                    </div>
                `;
            }

            invoiceDetailsDiv.innerHTML = invoiceHtml;
            finalPriceSpan.textContent = `${toPersianDigits(formatNumberWithCommas(Math.round(finalDisplayPrice)))} تومان`;

            // Update customer invoice
            updateCustomerInvoice(goldItemCounter, totalGoldBasePrice, totalWageSum, totalTaxSum, discountApplied, finalDisplayPrice);
        };

        const updateCustomerInvoice = (goldItemCount, totalGoldBasePrice, totalWageSum, totalTaxSum, discountApplied, finalPrice) => {
            // Placeholder for customer name and phone (assuming user inputs these somewhere else or they are hardcoded for now)
            customerNameDisplay.textContent = "نام مشتری"; // You can replace this with an actual input field value
            customerPhoneDisplay.textContent = toPersianDigits("09123456789"); // Replace with actual phone input if applicable

            customerPurchasedGoldCountDisplay.textContent = toPersianDigits(goldItemCount);
            // Display details for the first gold item if available
            const firstGoldItem = document.querySelector('.gold-item[data-id="1"]');
            if (firstGoldItem) {
                customerGoldModelDisplay.textContent = firstGoldItem.querySelector('#goldModel_1').value || 'نا مشخص';
                customerWeightDisplay.textContent = toPersianDigits(firstGoldItem.querySelector('#goldWeight_1').value || '۰');
            } else {
                customerGoldModelDisplay.textContent = 'نا مشخص';
                customerWeightDisplay.textContent = '۰';
            }

            customerBaseGoldPriceDisplay.textContent = `${toPersianDigits(formatNumberWithCommas(Math.round(totalGoldBasePrice)))} تومان`;
            customerWageDisplay.textContent = `${toPersianDigits(formatNumberWithCommas(Math.round(totalWageSum)))} تومان`;
            customerTaxDisplay.textContent = taxToggle.checked ? `${toPersianDigits(formatNumberWithCommas(Math.round(totalTaxSum)))} تومان` : 'ندارد';
            customerDiscountDisplay.textContent = (discountApplied > 0) ? `${toPersianDigits(formatNumberWithCommas(Math.round(discountApplied)))} تومان` : 'ندارد';
            customerTotalPriceDisplay.textContent = `${toPersianDigits(formatNumberWithCommas(Math.round(finalPrice)))} تومان`;
        };

        // Event Listeners
        goldPriceInput.addEventListener('input', (e) => {
            let value = toEnglishDigits(e.target.value).replace(/[^0-9]/g, '');
            value = value.substring(0, 7); // Apply 7-digit limit here in JS
            e.target.value = formatNumberWithCommas(value);

            const numValue = parseInt(value.replace(/,/g, ''), 10);
            if (!isNaN(numValue)) {
                let words = numberToWords(numValue);
                goldPriceTextDisplay.textContent = words + " تومان";
                const tempSpan = document.createElement('span');
                tempSpan.style.visibility = 'hidden';
                tempSpan.style.position = 'absolute';
                tempSpan.style.whiteSpace = 'nowrap';
                tempSpan.style.fontFamily = getComputedStyle(goldPriceTextDisplay).fontFamily;
                tempSpan.style.fontSize = getComputedStyle(goldPriceTextDisplay).fontSize;
                tempSpan.textContent = words + " تومان";
                document.body.appendChild(tempSpan);
                const textWidth = tempSpan.offsetWidth;
                document.body.removeChild(tempSpan);

                if (textWidth > goldPriceTextDisplay.clientWidth) {
                    goldPriceTextDisplay.classList.add('small-font');
                } else {
                    goldPriceTextDisplay.classList.remove('small-font');
                }
            } else {
                goldPriceTextDisplay.textContent = "";
            }
            updateInvoice();
            updateSmartDiscountOptions();
        });

        document.addEventListener('input', (e) => {
            // Generic input handler for persian number inputs
            if (e.target.classList.contains('persian-num-input')) {
                let value = toEnglishDigits(e.target.value).replace(/[^0-9.]/g, ''); // Allow digits and dot

                // Special handling for comma formatting
                if (e.target.classList.contains('persian-num-comma')) {
                    const parts = value.split('.');
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ""); // Remove existing commas
                    value = parts.join('.');
                }

                if (e.target.id.startsWith('wage_')) {
                    const id = e.target.id.split('_')[1];
                    const wageType = document.querySelector(`input[name="wageType_${id}"]:checked`).value;
                    if (wageType === 'percent') {
                        if (parseFloat(value) > 30) value = '30';
                        if (parseFloat(value) < 0) value = '0';
                    } else if (wageType === 'toman') {
                        const parts = value.split('.');
                        if (parts[0].length > 7) {
                            parts[0] = parts[0].substring(0, 7);
                        }
                        value = parts.join('.');
                    }
                } else if (e.target.id === 'discountAmount') {
                    value = value.replace(/\./g, ''); // No decimals for discount
                    activeSmartDiscount = null; // Deactivate smart discount if manual discount is entered
                    document.querySelectorAll('.smart-discount-option').forEach(option => option.classList.remove('active'));
                } else if (e.target.id === 'customerPhone') {
                    value = value.replace(/\./g, '').substring(0, 11);
                } else if (e.target.id === 'customerPurchasedGold') { // This was for "عدد طلا خریداری شده"
                    value = value.replace(/\./g, '');
                }

                // Apply comma formatting for specific inputs if they have 'persian-num-comma'
                if (e.target.classList.contains('persian-num-comma')) {
                    const parts = value.split('.');
                    e.target.value = toPersianDigits(formatNumberWithCommas(parts[0]) + (parts[1] ? '.' + parts[1] : ''));
                } else {
                    e.target.value = toPersianDigits(value);
                }
            }

            if (e.target.matches('select[id^="goldModel_"]') ||
                e.target.matches('#profitPercentage') ||
                e.target.matches('#taxToggle') ||
                e.target.matches('[id^="purchaseCoinModel_"]') ||
                e.target.classList.contains('persian-num-input'))
            {
                updateInvoice();
                updateSmartDiscountOptions();
            }
        });

        // Event listener for wage type radio buttons
        document.addEventListener('change', (e) => {
            if (e.target.type === 'radio' && e.target.name.startsWith('wageType_')) {
                const id = e.target.name.split('_')[1];
                const wageInput = document.getElementById(`wage_${id}`);
                wageInput.value = ''; // Clear value on unit change
                updateInvoice();
                updateSmartDiscountOptions();
            }
        });

        addGoldItemBtn.addEventListener('click', () => {
            goldItemCount++;
            const newItemHtml = `
                <div class="gold-item" data-id="${goldItemCount}">
                    <hr>
                    <div class="form-group">
                        <label for="goldWeight_${goldItemCount}">وزن طلا ${goldItemCount} (گرم):</label>
                        <input type="text" id="goldWeight_${goldItemCount}" class="persian-num-input">
                    </div>
                    <div class="form-group">
                        <label for="goldModel_${goldItemCount}">مدل طلا ${goldItemCount}:</label>
                        <select id="goldModel_${goldItemCount}">
                            <option value="">انتخاب کنید</option>
                            <option value="سرویس">سرویس</option>
                            <option value="النگو">النگو</option>
                            <option value="نیم‌ست">نیم‌ست</option>
                            <option value="دستبند">دستبند</option>
                            <option value="زنجیر">زنجیر</option>
                            <option value="گردنبند">گردنبند</option>
                            <option value="گوشواره">گوشواره</option>
                            <option value="مدال">مدال</option>
                            <option value="پلاک">پلاک</option>
                            <option value="خلخال">خلخال</option>
                            <option value="آویز ساعت">آویز ساعت</option>
                            <option value="رو لباسی">رو لباسی</option>
                            <option value="سفارشی">سفارشی</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="wage_${goldItemCount}">اجرت ${goldItemCount}:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="wageType_${goldItemCount}" value="percent" checked> %
                            </label>
                            <label>
                                <input type="radio" name="wageType_${goldItemCount}" value="toman"> تومان
                            </label>
                        </div>
                        <input type="text" id="wage_${goldItemCount}" class="persian-num-input" placeholder="مقدار اجرت">
                    </div>
                </div>
            `;
            goldItemsContainer.insertAdjacentHTML('beforeend', newItemHtml);
            updateInvoice();
            updateSmartDiscountOptions();
        });

        addCoinItemBtn.addEventListener('click', () => {
            coinItemCount++;
            const newItemHtml = `
                <div class="coin-item" data-id="${coinItemCount}">
                    <hr style="margin: 15px 0;">
                    <div class="form-group">
                        <label for="purchaseCoinModel_${coinItemCount}">خرید سکه ${coinItemCount}:</label>
                        <select id="purchaseCoinModel_${coinItemCount}">
                            <option value="">انتخاب کنید</option>
                            <option value="ربع ۸۶">ربع ۸۶</option>
                            <option value="نیم ۸۶">نیم ۸۶</option>
                            <option value="امامی ۸۶">امامی ۸۶</option>
                            <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                            <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                            <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                            <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="purchaseCoinPrice_${coinItemCount}">مبلغ سکه ${coinItemCount}:</label>
                        <input type="text" id="purchaseCoinPrice_${coinItemCount}" class="persian-num-input persian-num-comma">
                    </div>
                </div>
            `;
            coinPurchaseContainer.insertAdjacentHTML('beforeend', newItemHtml);
            updateInvoice();
            updateSmartDiscountOptions();
        });

        // Smart Discount Logic
        const generateSmartDiscountOptions = (totalPrice) => {
            smartDiscountOptionsDiv.innerHTML = ''; // Clear previous options
            if (totalPrice <= 0) return;

            const options = [];
            const roundedTotalPrice = Math.round(totalPrice); // Ensure integer for rounding

            // Generate discount options by rounding down to common significant figures
            // Option 1: Round down to nearest 1000
            options.push(Math.floor(roundedTotalPrice / 1000) * 1000);

            // Option 2: Round down to nearest 500,000
            options.push(Math.floor(roundedTotalPrice / 500000) * 500000);

            // Option 3: Round down to nearest 1,000,000
            options.push(Math.floor(roundedTotalPrice / 1000000) * 1000000);

            // Option 4: A more aggressive round down to X.5M or X.0M, always less than or equal to current price
            if (roundedTotalPrice >= 1000000) {
                let aggressiveRound = Math.floor(roundedTotalPrice / 1000000) * 1000000;
                if ((roundedTotalPrice - aggressiveRound) > 500000) {
                    aggressiveRound += 500000;
                }
                options.push(aggressiveRound);
            }

            // Filter out duplicates, values greater than current total, and negative values
            // Sort in ascending order, then reverse to show higher discounts (lower final price) first
            const uniqueOptions = [...new Set(options.filter(val => val <= roundedTotalPrice && val >= 0))]
                                    .sort((a, b) => a - b).reverse();

            // Limit to 4 options, take the highest ones (most significant discounts)
            const finalOptions = uniqueOptions.slice(0, 4);

            finalOptions.forEach(option => {
                const div = document.createElement('div');
                div.classList.add('smart-discount-option');
                div.textContent = `${toPersianDigits(formatNumberWithCommas(option))} تومان`;
                div.dataset.value = option;
                if (activeSmartDiscount === option) {
                    div.classList.add('active');
                }
                div.addEventListener('click', () => {
                    if (activeSmartDiscount === option) {
                        activeSmartDiscount = null; // Deactivate if already active
                    } else {
                        activeSmartDiscount = option; // Activate
                        discountAmountInput.value = ''; // Clear manual discount when smart discount is picked
                    }
                    updateSmartDiscountOptions(); // Re-render to update active state
                    updateInvoice(); // Recalculate invoice with new active discount
                });
                smartDiscountOptionsDiv.appendChild(div);
            });
        };

        const updateSmartDiscountOptions = () => {
            let currentTotalBeforeDiscount = 0;
            const currentGoldPrice = goldPriceInput.value;
            const profitPercent = parseFloat(profitPercentageSelect.value);
            const isTaxEnabled = taxToggle.checked;

            document.querySelectorAll('.gold-item').forEach((item) => {
                const id = item.dataset.id;
                const weightInput = item.querySelector(`#goldWeight_${id}`);
                const wageInput = item.querySelector(`#wage_${id}`);
                const wageTypeRadios = item.querySelectorAll(`input[name="wageType_${id}"]`);
                let wageType = 'percent';
                wageTypeRadios.forEach(radio => {
                    if (radio.checked) wageType = radio.value;
                });

                const weight = weightInput ? weightInput.value : '0';
                const wageValue = wageInput ? wageInput.value : '0';

                const calculation = calculateGoldItemPrice(currentGoldPrice, weight, wageType, wageValue, profitPercent);

                if (calculation.price > 0) {
                    currentTotalBeforeDiscount += calculation.price;
                    if (isTaxEnabled) {
                        currentTotalBeforeDiscount += (calculation.wageAmount + calculation.profitAmount) * 0.10;
                    }
                }
            });

            currentTotalBeforeDiscount += calculatePurchasePrices(currentGoldPrice);

            generateSmartDiscountOptions(currentTotalBeforeDiscount);
        };

        // This function updates only customer invoice display fields without re-calculating everything
        const updateCustomerInvoiceDisplayOnly = () => {
            // These will be hardcoded for now, or linked to specific inputs if they exist elsewhere
            // For a real app, you'd likely have customer name/phone input fields.
            // Assuming customerNameDisplay and customerPhoneDisplay are for static text now.
            customerNameDisplay.textContent = "نام مشتری";
            customerPhoneDisplay.textContent = toPersianDigits("09123456789");
        };


        // Initial Calculations on Load
        document.addEventListener('DOMContentLoaded', () => {
            updateInvoice();
            updateSmartDiscountOptions();
            updateCustomerInvoiceDisplayOnly(); // Initial update for customer info display
        });
    </script>
</body>
</html>
