<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاکتور طلافروشی</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 650px; /* Adjust max-width for better mobile display */
            margin: 20px;
            box-sizing: border-box;
            border: 1px solid #e0e0e0;
        }

        header {
            background-color: #4A90E2; /* Blue header */
            color: white;
            padding: 15px 25px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            margin: -25px -25px 25px -25px; /* Adjust to extend to edges */
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }

        h2 {
            font-size: 1.4em;
            color: #007bff; /* Blue */
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        h2.section-gold { color: #28a745; /* Green */ }
        h2.section-buy { color: #fd7e14; /* Orange/Gold */ }
        h2.section-calc { color: #6f42c1; /* Purple */ }
        h2.section-discount { color: #dc3545; /* Red */ }
        h2.section-factor { color: #007bff; /* Blue */ }


        .form-group {
            margin-bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }

        .form-row > .form-group {
            flex: 1;
            min-width: 150px; /* Minimum width for form groups in a row */
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1em;
            color: #333;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
            outline: none;
        }

        .input-group {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .input-group input {
            flex-grow: 1;
        }

        .input-group span {
            padding: 0 10px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-left: none;
            border-radius: 0 8px 8px 0;
            height: 44px; /* Match input height */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            color: #555;
        }

        .input-group input:not(:last-child) {
            border-radius: 8px 0 0 8px;
        }

        .input-group select {
            border-radius: 8px 0 0 8px;
        }


        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.95em;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 10px;
            width: 18px;
            height: 18px;
            accent-color: #28a745;
        }

        .add-item-btn {
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 15px;
            transition: background-color 0.3s ease;
            display: block;
            width: fit-content;
        }

        .add-item-btn:hover {
            background-color: #218838;
        }

        .remove-item-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }

        .remove-item-btn:hover {
            background-color: #c82333;
        }

        .gold-item, .buy-item {
            border: 1px dashed #cceeff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 10px;
            background-color: #f8fcff;
        }

        .gold-item:first-of-type, .buy-item:first-of-type {
            margin-top: 0;
        }

        .cost-type-toggle {
            display: flex;
            gap: 5px;
        }

        .cost-type-toggle button {
            background-color: #e0e0e0;
            color: #555;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            flex: 1;
        }

        .cost-type-toggle button.active {
            background-color: #4A90E2;
            color: white;
        }

        .cost-type-toggle button:hover:not(.active) {
            background-color: #d0d0d0;
        }

        .discount-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .discount-option-btn {
            background-color: #e6ffe6; /* Light green */
            color: #28a745;
            border: 1px solid #28a745;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .discount-option-btn.active {
            background-color: #28a745;
            color: white;
        }

        .discount-option-btn:hover:not(.active) {
            background-color: #d4fcd4;
        }

        .factor-section, .customer-factor-section {
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .factor-item, .customer-factor-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e9e9e9;
            font-size: 1.05em;
        }

        .factor-item:last-child, .customer-factor-item:last-child {
            border-bottom: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
        }

        .factor-item span:first-child, .customer-factor-item span:first-child {
            font-weight: 500;
            color: #444;
        }

        .factor-item .discount-price {
            color: #dc3545; /* Red for discount */
            font-weight: bold;
        }

        .factor-item .final-price {
            color: #007bff; /* Blue for final price */
            font-weight: bold;
            font-size: 1.2em;
        }

        .price-in-words {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            padding: 0 10px;
            color: #6c757d;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 200px); /* Adjust based on input width */
            direction: rtl; /* Ensure text is right-to-left */
        }
        .price-input-wrapper {
            position: relative;
            display: flex; /* Or block, depending on layout */
            width: 100%;
        }
        .price-input-wrapper input {
            padding-right: 150px; /* Make space for the words */
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row > .form-group {
                min-width: unset;
                width: 100%;
            }
            .container {
                margin: 10px;
                padding: 15px;
            }
            header {
                padding: 10px 15px;
                margin: -15px -15px 20px -15px;
            }
            header h1 {
                font-size: 1.5em;
            }
            h2 {
                font-size: 1.2em;
            }
            input, select {
                padding: 10px;
                font-size: 0.95em;
            }
            .input-group span {
                height: 40px;
            }
            .discount-option-btn {
                padding: 8px 15px;
                font-size: 0.85em;
            }
             .price-in-words {
                font-size: 0.7em;
                max-width: calc(100% - 120px);
            }
            .price-input-wrapper input {
                padding-right: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>فاکتور طلافروشی</h1>
        </header>

        <section id="gold-items-section">
            <h2 class="section-gold">محاسبه قیمت طلا</h2>
            <div id="goldItemsContainer">
                </div>
            <button type="button" class="add-item-btn" onclick="addGoldItem()">+ افزودن آیتم طلای جدید</button>
        </section>

        ---

        <section id="buy-section">
            <h2 class="section-buy">بخش خرید طلا</h2>
            <div id="buyItemsContainer">
                <div class="buy-item">
                    <h3>خرید طلا</h3>
                    <div class="form-group">
                        <label for="buyGoldWeight">وزن طلا (گرم)</label>
                        <input type="text" id="buyGoldWeight" class="buy-weight-input" oninput="formatAndCalculate()">
                    </div>
                </div>
                <div class="buy-item">
                    <h3>خرید شمش</h3>
                    <div class="form-group">
                        <label for="buyIngotWeight">وزن شمش (گرم)</label>
                        <input type="text" id="buyIngotWeight" class="buy-weight-input" oninput="formatAndCalculate()">
                    </div>
                </div>
                <div class="buy-item">
                    <h3>خرید پارسیان</h3>
                    <div class="form-group">
                        <label for="buyParsianWeight">وزن پارسیان (گرم)</label>
                        <input type="text" id="buyParsianWeight" class="buy-weight-input" oninput="formatAndCalculate()">
                    </div>
                </div>
                <div class="buy-item">
                    <h3>خرید سکه</h3>
                    <div id="coinSelectionContainer">
                        <div class="form-group form-row">
                            <div class="form-group">
                                <label for="coinModel_0">مدل سکه</label>
                                <select id="coinModel_0" onchange="toggleCoinAmountField(0); formatAndCalculate()">
                                    <option value="">انتخاب کنید</option>
                                    <option value="ربع ۸۶">ربع ۸۶</option>
                                    <option value="نیم ۸۶">نیم ۸۶</option>
                                    <option value="امامی ۸۶">امامی ۸۶</option>
                                    <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                                    <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                                    <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                                    <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                                </select>
                            </div>
                            <div class="form-group coin-amount-group" style="display: none;">
                                <label for="coinAmount_0">مبلغ سکه (تومان)</label>
                                <input type="text" id="coinAmount_0" class="coin-amount-input" oninput="formatNumberInput(this); formatAndCalculate();" maxlength="9">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addCoinSelection()">+ افزودن سکه دیگر</button>
                </div>
            </div>
        </section>

        ---

        <section id="calculation-section">
            <h2 class="section-calc">تنظیمات نهایی</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="sellerProfit">سود فروشنده (درصد)</label>
                    <input type="number" id="sellerProfit" min="1" max="7" value="7" oninput="formatAndCalculate()">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="taxActive" checked onchange="formatAndCalculate()">
                        <label for="taxActive">مالیات ۱۰ درصد (از سود و اجرت)</label>
                    </div>
                </div>
            </div>
        </section>

        ---

        <section id="discount-section">
            <h2 class="section-discount">تخفیف</h2>
            <div class="form-group">
                <label for="manualDiscount">تخفیف دستی (تومان)</label>
                <input type="text" id="manualDiscount" oninput="formatNumberInput(this); formatAndCalculate();" maxlength="9">
            </div>

            <div class="form-group">
                <label>تخفیف هوشمند</label>
                <div id="smartDiscountOptions" class="discount-options">
                    </div>
            </div>
        </section>

        ---

        <section id="factor-output-section" class="factor-section">
            <h2 class="section-factor">فاکتور قیمت</h2>
            <div id="goldFactorDetails">
                </div>
            <div class="factor-item">
                <span>جمع مالیات</span>
                <span id="totalTax">0 تومان</span>
            </div>
            <div class="factor-item">
                <span>تخفیف</span>
                <span id="displayDiscount" class="discount-price">0 تومان</span>
            </div>
            <div class="factor-item">
                <span>قیمت نهایی</span>
                <span id="finalPrice" class="final-price">0 تومان</span>
            </div>
        </section>

        ---

        <section id="customer-factor-section" class="customer-factor-section">
            <h2 class="section-factor">فاکتور فروش مشتری</h2>
            <div class="form-group">
                <label for="customerName">نام خریدار:</label>
                <input type="text" id="customerName" oninput="validateCustomerName(this)">
            </div>
            <div class="form-group">
                <label for="customerPhone">شماره تماس (اختیاری):</label>
                <input type="text" id="customerPhone" oninput="validateCustomerPhone(this)" maxlength="11">
            </div>

            <div id="customerGoldDetails">
                </div>
            <div class="customer-factor-item">
                <span>مالیات</span>
                <span id="customerTax">0 تومان</span>
            </div>
            <div class="customer-factor-item">
                <span>تخفیف</span>
                <span id="customerDiscount" class="discount-price">0 تومان</span>
            </div>
            <div class="customer-factor-item">
                <span>قیمت کل</span>
                <span id="customerTotalPrice" class="final-price">0 تومان</span>
            </div>
        </section>
    </div>

    <script>
        let goldItemCounter = 0;
        let coinSelectionCounter = 0;

        const modelOptions = [
            "سرویس", "النگو", "نیم‌ست", "دستبند", "زنجیر", "گردنبند", "گوشواره", "مدال", "پلاک", "خلخال", "آویز ساعت", "رو لباسی", "سفارشی"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            addGoldItem(); // Add the initial gold item
            formatAndCalculate(); // Initial calculation
        });

        function addGoldItem() {
            const container = document.getElementById('goldItemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'gold-item';
            newItem.dataset.id = goldItemCounter;
            newItem.innerHTML = `
                <h3>طلا ${goldItemCounter + 1}</h3>
                <div class="form-row">
                    <div class="form-group price-input-wrapper" style="position: relative;">
                        <label for="goldPrice_${goldItemCounter}">قیمت طلا (تومان)</label>
                        <input type="text" id="goldPrice_${goldItemCounter}" oninput="formatPriceInput(this, 'priceInWords_${goldItemCounter}'); formatAndCalculate()" maxlength="9">
                        <span id="priceInWords_${goldItemCounter}" class="price-in-words"></span>
                    </div>
                    <div class="form-group">
                        <label for="goldWeight_${goldItemCounter}">وزن طلا (گرم)</label>
                        <input type="text" id="goldWeight_${goldItemCounter}" oninput="formatWeightInput(this); formatAndCalculate()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="goldModel_${goldItemCounter}">مدل طلا</label>
                        <select id="goldModel_${goldItemCounter}" onchange="formatAndCalculate()">
                            <option value="">انتخاب کنید</option>
                            ${modelOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="wageAmount_${goldItemCounter}">اجرت</label>
                        <div class="input-group">
                            <input type="text" id="wageAmount_${goldItemCounter}" class="wage-input" oninput="formatWageInput(this, ${goldItemCounter}); formatAndCalculate()" maxlength="7">
                            <span id="wageUnit_${goldItemCounter}">%</span>
                        </div>
                        <div class="cost-type-toggle" style="margin-top: 5px;">
                            <button type="button" class="wage-type-btn active" data-type="percent" onclick="toggleWageType(${goldItemCounter}, 'percent')">%</button>
                            <button type="button" class="wage-type-btn" data-type="amount" onclick="toggleWageType(${goldItemCounter}, 'amount')">$</button>
                        </div>
                    </div>
                </div>
                ${goldItemCounter > 0 ? `<button type="button" class="remove-item-btn" onclick="removeGoldItem(${goldItemCounter})">حذف این آیتم</button>` : ''}
            `;
            container.appendChild(newItem);
            goldItemCounter++;
        }

        function removeGoldItem(id) {
            const itemToRemove = document.querySelector(`.gold-item[data-id="${id}"]`);
            if (itemToRemove) {
                itemToRemove.remove();
                formatAndCalculate();
            }
        }

        function addCoinSelection() {
            const container = document.getElementById('coinSelectionContainer');
            const newIndex = coinSelectionCounter + 1;
            const newCoinGroup = document.createElement('div');
            newCoinGroup.className = 'form-group form-row';
            newCoinGroup.dataset.id = newIndex;
            newCoinGroup.innerHTML = `
                <div class="form-group">
                    <label for="coinModel_${newIndex}">مدل سکه</label>
                    <select id="coinModel_${newIndex}" onchange="toggleCoinAmountField(${newIndex}); formatAndCalculate()">
                        <option value="">انتخاب کنید</option>
                        <option value="ربع ۸۶">ربع ۸۶</option>
                        <option value="نیم ۸۶">نیم ۸۸</option>
                        <option value="امامی ۸۶">امامی ۸۶</option>
                        <option value="ربع زیر ۸۶">ربع زیر ۸۶</option>
                        <option value="نیم زیر ۸۶">نیم زیر ۸۶</option>
                        <option value="امامی زیر ۸۶">امامی زیر ۸۶</option>
                        <option value="یک گرمی بانکی">یک گرمی بانکی</option>
                    </select>
                </div>
                <div class="form-group coin-amount-group" style="display: none;">
                    <label for="coinAmount_${newIndex}">مبلغ سکه (تومان)</label>
                    <input type="text" id="coinAmount_${newIndex}" class="coin-amount-input" oninput="formatNumberInput(this); formatAndCalculate();" maxlength="9">
                </div>
                <button type="button" class="remove-item-btn" onclick="removeCoinSelection(${newIndex})" style="margin-right: auto; margin-top: 25px;">حذف</button>
            `;
            container.appendChild(newCoinGroup);
            coinSelectionCounter++;
        }

        function removeCoinSelection(id) {
            const itemToRemove = document.querySelector(`#coinSelectionContainer .form-row[data-id="${id}"]`);
            if (itemToRemove) {
                itemToRemove.remove();
                formatAndCalculate();
            }
        }

        function toggleCoinAmountField(index) {
            const coinModel = document.getElementById(`coinModel_${index}`).value;
            const coinAmountGroup = document.getElementById(`coinModel_${index}`).closest('.form-row').querySelector('.coin-amount-group');
            if (coinModel) {
                coinAmountGroup.style.display = 'block';
            } else {
                coinAmountGroup.style.display = 'none';
                document.getElementById(`coinAmount_${index}`).value = '';
            }
        }

        function toggleWageType(id, type) {
            const buttons = document.querySelectorAll(`.gold-item[data-id="${id}"] .wage-type-btn`);
            const wageInput = document.getElementById(`wageAmount_${id}`);
            const wageUnit = document.getElementById(`wageUnit_${id}`);

            buttons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.gold-item[data-id="${id}"] .wage-type-btn[data-type="${type}"]`).classList.add('active');

            wageInput.dataset.wageType = type;
            wageUnit.textContent = (type === 'percent' ? '%' : '$');
            formatWageInput(wageInput, id); // Reformat after type change
            formatAndCalculate();
        }

        function formatPriceInput(input, wordsSpanId) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value.length > 7) {
                value = value.substring(0, 7); // Limit to 7 digits
            }
            input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ','); // Add commas
            updatePriceInWords(input.value, wordsSpanId);
            adjustFontSize(input, document.getElementById(wordsSpanId));
            formatAndCalculate();
        }

        function formatWeightInput(input) {
            let value = input.value.replace(/[^0-9.]/g, ''); // Allow only digits and one dot
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join(''); // Allow only one dot
            }
            input.value = value;
            formatAndCalculate();
        }

        function formatWageInput(input, id) {
            const wageType = input.dataset.wageType || 'percent'; // Default to percent
            let value = input.value.replace(/[^0-9.]/g, '');

            if (wageType === 'percent') {
                if (value === '') {
                    input.value = '';
                } else {
                    let num = parseFloat(value);
                    if (isNaN(num)) num = 0;
                    if (num < 1) num = 1;
                    if (num > 30) num = 30;
                    input.value = num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
            } else { // type is amount
                if (value.length > 7) {
                    value = value.substring(0, 7);
                }
                input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            formatAndCalculate();
        }

        function formatNumberInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (input.maxLength && value.length > input.maxLength) {
                value = value.substring(0, input.maxLength);
            }
            input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            formatAndCalculate();
        }


        const units = ["", "هزار", "میلیون", "میلیارد", "تریلیون"];
        const ones = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
        const tens = ["", "ده", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
        const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
        const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];

        function convertToPersianWords(num) {
            if (num === 0) return "صفر";
            if (num < 0) return "منفی " + convertToPersianWords(Math.abs(num));

            let words = [];
            let i = 0;

            while (num > 0) {
                let chunk = num % 1000;
                if (chunk !== 0) {
                    let chunkWords = [];
                    let h = Math.floor(chunk / 100);
                    let t = Math.floor((chunk % 100) / 10);
                    let o = chunk % 10;

                    if (h > 0) chunkWords.push(hundreds[h]);

                    if (t === 1) {
                        chunkWords.push(teens[o]);
                    } else {
                        if (t > 0) chunkWords.push(tens[t]);
                        if (o > 0) chunkWords.push(ones[o]);
                    }
                    words.push(chunkWords.join(" و ") + " " + units[i]);
                }
                num = Math.floor(num / 1000);
                i++;
            }
            return words.reverse().join(" و ").trim() + " تومان";
        }

        function updatePriceInWords(priceString, wordsSpanId) {
            const num = parseInt(priceString.replace(/,/g, ''), 10);
            const wordsSpan = document.getElementById(wordsSpanId);
            if (isNaN(num) || num === 0) {
                wordsSpan.textContent = '';
            } else {
                wordsSpan.textContent = convertToPersianWords(num);
            }
            adjustFontSize(document.getElementById(wordsSpanId.replace('priceInWords_', 'goldPrice_')), wordsSpan);
        }

        function adjustFontSize(inputElement, wordsSpanElement) {
            const inputRect = inputElement.getBoundingClientRect();
            const wordsRect = wordsSpanElement.getBoundingClientRect();
            const maxWordsWidth = inputRect.width - (inputElement.offsetWidth - inputElement.clientWidth) - 20; // Some padding

            let fontSize = 0.8; // Initial font size in em
            wordsSpanElement.style.fontSize = fontSize + 'em';

            // Reduce font size if text overflows
            while (wordsSpanElement.scrollWidth > maxWordsWidth && fontSize > 0.4) {
                fontSize -= 0.05;
                wordsSpanElement.style.fontSize = fontSize + 'em';
            }
        }

        function validateCustomerName(input) {
            input.value = input.value.replace(/[^آ-ی\s]/g, ''); // Allow only Persian letters and spaces
        }

        function validateCustomerPhone(input) {
            input.value = input.value.replace(/\D/g, ''); // Allow only digits
            if (input.value.length > 11) {
                input.value = input.value.substring(0, 11);
            }
        }

        function formatAndCalculate() {
            let totalGoldPrice = 0;
            let totalWage = 0;
            let totalProfit = 0;
            let totalTaxAmount = 0;
            let finalOverallPrice = 0;

            const sellerProfitRate = parseFloat(document.getElementById('sellerProfit').value) / 100 || 0.07;
            const taxActive = document.getElementById('taxActive').checked;
            let manualDiscount = parseFloat(document.getElementById('manualDiscount').value.replace(/,/g, '')) || 0;

            document.getElementById('goldFactorDetails').innerHTML = ''; // Clear previous details
            document.getElementById('customerGoldDetails').innerHTML = ''; // Clear previous customer details

            // Calculate for Gold Items
            document.querySelectorAll('.gold-item').forEach((item, index) => {
                const goldPriceInput = document.getElementById(`goldPrice_${item.dataset.id}`);
                const goldWeightInput = document.getElementById(`goldWeight_${item.dataset.id}`);
                const goldModelSelect = document.getElementById(`goldModel_${item.dataset.id}`);
                const wageAmountInput = document.getElementById(`wageAmount_${item.dataset.id}`);
                const wageType = wageAmountInput.dataset.wageType || 'percent';

                const goldPricePerGram = parseFloat(goldPriceInput.value.replace(/,/g, '')) || 0;
                const goldWeight = parseFloat(goldWeightInput.value) || 0;
                let wageValue = parseFloat(wageAmountInput.value.replace(/,/g, '')) || 0;

                const currentGoldPrice = goldPricePerGram * goldWeight;
                let currentWage = 0;
                if (wageType === 'percent') {
                    currentWage = currentGoldPrice * (wageValue / 100);
                } else { // amount
                    currentWage = wageValue * goldWeight; // Assuming amount wage is per gram
                }

                const currentProfit = currentGoldPrice * sellerProfitRate;
                let currentTax = 0;
                if (taxActive) {
                    currentTax = (currentWage + currentProfit) * 0.10;
                }

                const itemTotalPrice = currentGoldPrice + currentWage + currentProfit + currentTax;

                totalGoldPrice += currentGoldPrice;
                totalWage += currentWage;
                totalProfit += currentProfit;
                totalTaxAmount += currentTax;
                finalOverallPrice += itemTotalPrice;

                // Update Factor Price section
                const factorDetail = document.createElement('div');
                factorDetail.className = 'factor-item';
                const modelName = goldModelSelect.value || `طلا ${index + 1}`;
                factorDetail.innerHTML = `
                    <span>${modelName}</span>
                    <span>${(itemTotalPrice).toLocaleString('fa-IR')} تومان</span>
                `;
                document.getElementById('goldFactorDetails').appendChild(factorDetail);

                // Update Customer Factor section
                const customerDetail = document.createElement('div');
                customerDetail.className = 'customer-factor-item';
                customerDetail.innerHTML = `
                    <div style="flex-basis: 100%; display: flex; justify-content: space-between; flex-wrap: wrap;">
                        <span style="font-weight: bold;">مدل:</span> <span>${modelName}</span>
                        <span style="font-weight: bold;">وزن:</span> <span>${goldWeight.toLocaleString('fa-IR')} گرم</span>
                        <span style="font-weight: bold;">قیمت:</span> <span>${currentGoldPrice.toLocaleString('fa-IR')} تومان</span>
                        <span style="font-weight: bold;">اجرت:</span> <span>${currentWage.toLocaleString('fa-IR')} تومان</span>
                    </div>
                `;
                document.getElementById('customerGoldDetails').appendChild(customerDetail);
            });

            // Calculate for Buy Section (Gold, Ingot, Parsian)
            const buyGoldWeight = parseFloat(document.getElementById('buyGoldWeight').value) || 0;
            const buyIngotWeight = parseFloat(document.getElementById('buyIngotWeight').value) || 0;
            const buyParsianWeight = parseFloat(document.getElementById('buyParsianWeight').value) || 0;
            const goldPricePerGramForBuy = parseFloat(document.getElementById('goldPrice_0').value.replace(/,/g, '')) || 0; // Use the main gold price

            let buySectionTotal = 0;

            if (buyGoldWeight > 0) {
                const price = buyGoldWeight * goldPricePerGramForBuy;
                buySectionTotal += price;
                 // Update Customer Factor section for buy gold
                const customerBuyGoldDetail = document.createElement('div');
                customerBuyGoldDetail.className = 'customer-factor-item';
                customerBuyGoldDetail.innerHTML = `
                    <div style="flex-basis: 100%; display: flex; justify-content: space-between; flex-wrap: wrap;">
                        <span style="font-weight: bold;">خرید طلا:</span> <span>${buyGoldWeight.toLocaleString('fa-IR')} گرم</span>
                        <span style="font-weight: bold;">قیمت:</span> <span>${price.toLocaleString('fa-IR')} تومان</span>
                    </div>
                `;
                document.getElementById('customerGoldDetails').appendChild(customerBuyGoldDetail);
            }

            if (buyIngotWeight > 0) {
                const price = (buyIngotWeight * 995 / 750) * goldPricePerGramForBuy;
                buySectionTotal += price;
                 // Update Customer Factor section for buy ingot
                const customerBuyIngotDetail = document.createElement('div');
                customerBuyIngotDetail.className = 'customer-factor-item';
                customerBuyIngotDetail.innerHTML = `
                    <div style="flex-basis: 100%; display: flex; justify-content: space-between; flex-wrap: wrap;">
                        <span style="font-weight: bold;">خرید شمش:</span> <span>${buyIngotWeight.toLocaleString('fa-IR')} گرم</span>
                        <span style="font-weight: bold;">قیمت:</span> <span>${price.toLocaleString('fa-IR')} تومان</span>
                    </div>
                `;
                document.getElementById('customerGoldDetails').appendChild(customerBuyIngotDetail);
            }

            if (buyParsianWeight > 0) {
                const price = buyParsianWeight * goldPricePerGramForBuy;
                buySectionTotal += price;
                 // Update Customer Factor section for buy parsian
                const customerBuyParsianDetail = document.createElement('div');
                customerBuyParsianDetail.className = 'customer-factor-item';
                customerBuyParsianDetail.innerHTML = `
                    <div style="flex-basis: 100%; display: flex; justify-content: space-between; flex-wrap: wrap;">
                        <span style="font-weight: bold;">خرید پارسیان:</span> <span>${buyParsianWeight.toLocaleString('fa-IR')} گرم</span>
                        <span style="font-weight: bold;">قیمت:</span> <span>${price.toLocaleString('fa-IR')} تومان</span>
                    </div>
                `;
                document.getElementById('customerGoldDetails').appendChild(customerBuyParsianDetail);
            }

            // Calculate for Coin Purchases
            document.querySelectorAll('.coin-amount-input').forEach((input) => {
                const coinAmount = parseFloat(input.value.replace(/,/g, '')) || 0;
                const coinModelSelect = input.closest('.form-row').querySelector('select');
                const coinModel = coinModelSelect ? coinModelSelect.value : '';

                if (coinAmount > 0) {
                    buySectionTotal += coinAmount;
                     // Update Customer Factor section for coins
                    const customerBuyCoinDetail = document.createElement('div');
                    customerBuyCoinDetail.className = 'customer-factor-item';
                    customerBuyCoinDetail.innerHTML = `
                        <div style="flex-basis: 100%; display: flex; justify-content: space-between; flex-wrap: wrap;">
                            <span style="font-weight: bold;">خرید سکه (${coinModel}):</span> <span>${coinAmount.toLocaleString('fa-IR')} تومان</span>
                        </div>
                    `;
                    document.getElementById('customerGoldDetails').appendChild(customerBuyCoinDetail);
                }
            });

            finalOverallPrice += buySectionTotal;


            // Apply Smart Discount if active
            const activeSmartDiscountBtn = document.querySelector('.discount-option-btn.active');
            if (activeSmartDiscountBtn) {
                manualDiscount = parseFloat(activeSmartDiscountBtn.dataset.value) || 0;
            }

            finalOverallPrice -= manualDiscount;

            // Update Factor Price Section
            document.getElementById('totalTax').textContent = `${totalTaxAmount.toLocaleString('fa-IR')} تومان`;
            document.getElementById('displayDiscount').textContent = `${manualDiscount.toLocaleString('fa-IR')} تومان`;
            document.getElementById('finalPrice').textContent = `${Math.round(finalOverallPrice).toLocaleString('fa-IR')} تومان`;


            // Update Customer Factor Section (based on the final calculated values)
            const customerGoldPurchasedText = Array.from(document.querySelectorAll('.gold-item')).map((item, idx) => {
                const goldModel = document.getElementById(`goldModel_${item.dataset.id}`).value || `طلا ${idx + 1}`;
                const goldWeight = parseFloat(document.getElementById(`goldWeight_${item.dataset.id}`).value) || 0;
                return `${goldModel}: ${goldWeight.toLocaleString('fa-IR')} گرم`;
            }).join(' و ');
            // This is just a placeholder, as the actual requirement was to show number of items, not their values.
            // "طلا خریداری شده: (فقط عدد قبول کنه - حداکثر ۱۱ رقم) (به فارسی تبدیل بشه اگه انگلیسی بود)"
            // This implies a count, not a list of items. We will just show the total price of gold.
             const customerGoldPurchasedDisplay = document.createElement('div');
            customerGoldPurchasedDisplay.className = 'customer-factor-item';
            customerGoldPurchasedDisplay.innerHTML = `
                <span>طلا خریداری شده:</span>
                <span>${(totalGoldPrice).toLocaleString('fa-IR')} تومان</span>
            `;
            // If we're displaying this item-by-item, this line should go away.
            // For now, removing it as the prompt has conflicting info or means just the total value
            // document.getElementById('customerGoldDetails').prepend(customerGoldPurchasedDisplay);


            document.getElementById('customerTax').textContent = `${totalTaxAmount.toLocaleString('fa-IR')} تومان`;
            document.getElementById('customerDiscount').textContent = `${manualDiscount.toLocaleString('fa-IR')} تومان`;
            document.getElementById('customerTotalPrice').textContent = `${Math.round(finalOverallPrice).toLocaleString('fa-IR')} تومان`;

            updateSmartDiscountOptions(Math.round(finalOverallPrice + manualDiscount)); // Pass the price *before* manual discount for smart discount calculation
        }

        function updateSmartDiscountOptions(currentPrice) {
            const optionsContainer = document.getElementById('smartDiscountOptions');
            optionsContainer.innerHTML = '';
            const price = parseFloat(currentPrice);

            if (isNaN(price) || price <= 0) {
                return;
            }

            const smartDiscounts = [
                Math.floor(price / 1000) * 1000,
                Math.floor(price / 5000) * 5000,
                Math.floor(price / 10000) * 10000,
                Math.floor(price / 50000) * 50000
            ];

            const uniqueDiscounts = [...new Set(smartDiscounts.filter(d => d < price))].sort((a, b) => b - a); // Get unique and sort descending

            uniqueDiscounts.forEach(discountedPrice => {
                const discountAmount = price - discountedPrice;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'discount-option-btn';
                btn.textContent = `${discountedPrice.toLocaleString('fa-IR')} (${discountAmount.toLocaleString('fa-IR')} تخفیف)`;
                btn.dataset.value = discountAmount;
                btn.onclick = () => toggleSmartDiscount(btn);
                optionsContainer.appendChild(btn);
            });
        }

        let activeSmartDiscountButton = null;

        function toggleSmartDiscount(button) {
            if (activeSmartDiscountButton && activeSmartDiscountButton !== button) {
                activeSmartDiscountButton.classList.remove('active');
            }

            button.classList.toggle('active');

            if (button.classList.contains('active')) {
                activeSmartDiscountButton = button;
                document.getElementById('manualDiscount').value = ''; // Clear manual discount if smart discount is active
            } else {
                activeSmartDiscountButton = null;
            }
            formatAndCalculate();
        }

        // Initialize with one gold item
        addGoldItem();
        formatAndCalculate(); // Initial calculation on load
    </script>
</body>
</html>
